<pre class="include"><code>other/header.md</code></pre>
<h1 id="haskell-rl-gamblers-problem-ex.-4.9">haskell-rl : Gambler’s Problem (Ex. 4.9)</h1>
<p>This <a href="https://wiki.haskell.org/Literate_programming">literate Haskell</a> document provides a solution to Exercise 4.9 in <em>Reinforcement Learning</em> by Sutton &amp; Barto.</p>
<p>Original author: <a href="mailto:capn.freako@gmail.com">David Banas</a><br />
Original date: May 10, 2018</p>
<p>Copyright © 2018 David Banas; all rights reserved World wide.</p>
<h2 id="contents">Contents</h2>
<ul class="incremental">
<li><a href="#code">Code</a></li>
<li><a href="#output">Output</a></li>
</ul>
<h2 id="code">code</h2>
<h2 id="ghc-options"><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/flags.html#flag-reference">ghc options</a></h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="ot">{-# OPTIONS_GHC -Wall #-}</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="ot">{-# OPTIONS_GHC -fno-warn-type-defaults #-}</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="ot">{-# OPTIONS_GHC -Wno-missing-signatures #-}</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="ot">{-# OPTIONS_GHC -Wno-orphans #-}</span></a></code></pre></div>
<h2 id="pragmas"><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/lang.html">pragmas</a></h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">-- doctest doesn&#39;t look at the cabal file, so you need pragmas here</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="ot">{-# LANGUAGE NoImplicitPrelude #-}</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="ot">{-# LANGUAGE DataKinds #-}</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="ot">{-# LANGUAGE DeriveGeneric #-}</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="ot">{-# LANGUAGE FlexibleContexts #-}</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="ot">{-# LANGUAGE ScopedTypeVariables #-}</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="ot">{-# LANGUAGE TypeOperators #-}</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="ot">{-# LANGUAGE TypeFamilies #-}</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="ot">{-# LANGUAGE FlexibleInstances #-}</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="co">-- {-# LANGUAGE BangPatterns #-}</span></a></code></pre></div>
<h2 id="libraries"><a href="https://www.stackage.org/">libraries</a></h2>
<ul class="incremental">
<li><a href="https://www.stackage.org/package/protolude">protolude</a></li>
<li><a href="https://www.stackage.org/package/optparse-generic">optparse-generic</a></li>
<li><a href="https://www.stackage.org/package/vector-sized">vector-sized</a></li>
<li><a href="https://www.stackage.org/package/finite-typelits">finite-typelits</a></li>
<li><a href="https://www.stackage.org/package/Chart">Chart</a></li>
<li><a href="https://www.stackage.org/package/Chart-cairo">Chart-cairo</a></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Prelude</span> <span class="kw">as</span> <span class="dt">P</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">-- import Prelude (unlines, Show(..), String)</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="kw">import</span> <span class="dt">Protolude</span>  <span class="kw">hiding</span> (show, for)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="kw">import</span> <span class="dt">Options.Generic</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="kw">import</span> <span class="dt">Control.Monad.Writer</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Vector.Sized</span>   <span class="kw">as</span> <span class="dt">VS</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co">-- import Data.Finite</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co">-- import Data.Finite.Internal</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Data.List</span>                            (findIndices)</a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="kw">import</span> <span class="dt">Data.Text</span>                            (pack)</a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="kw">import</span> <span class="dt">Graphics.Rendering.Chart.Easy</span> <span class="kw">hiding</span> (<span class="dt">Wrapped</span>, <span class="dt">Unwrapped</span>, <span class="dt">Empty</span>)</a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="kw">import</span> <span class="dt">Graphics.Rendering.Chart.Backend.Cairo</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="kw">import</span> <span class="dt">Text.Printf</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="kw">import</span> <span class="dt">RL.GPI</span></a></code></pre></div>
<h2 id="code-1">code</h2>
<ul class="incremental">
<li><a href="https://www.stackage.org/package/hoogle">hoogle</a></li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">  Problem specific definitions</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">gamma&#39; <span class="fu">=</span> <span class="dv">1</span>     <span class="co">-- Dictated by problem.</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="kw">type</span> <span class="dt">GState</span>  <span class="fu">=</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="kw">type</span> <span class="dt">GAction</span> <span class="fu">=</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">allStatesV <span class="fu">=</span> VS.generate P.id<span class="ot"> ::</span> <span class="dt">VS.Vector</span> <span class="dv">101</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="ot">actions&#39; ::</span> <span class="dt">GState</span> <span class="ot">-&gt;</span> [<span class="dt">GAction</span>]</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">actions&#39; s <span class="fu">=</span> [<span class="dv">0</span> <span class="fu">..</span> min s (<span class="dv">100</span> <span class="fu">-</span> s)]</a>
<a class="sourceLine" id="cb5-13" data-line-number="13"></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="ot">nextStates&#39; ::</span> <span class="dt">GState</span> <span class="ot">-&gt;</span> <span class="dt">GAction</span> <span class="ot">-&gt;</span> [<span class="dt">GState</span>]</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">nextStates&#39; s a <span class="fu">=</span> <span class="kw">if</span> a <span class="fu">==</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16">                   <span class="kw">then</span> [s]</a>
<a class="sourceLine" id="cb5-17" data-line-number="17">                   <span class="kw">else</span> [s <span class="fu">-</span> a, s <span class="fu">+</span> a]</a>
<a class="sourceLine" id="cb5-18" data-line-number="18"></a>
<a class="sourceLine" id="cb5-19" data-line-number="19"><span class="ot">rewards&#39; ::</span> <span class="dt">Float</span> <span class="ot">-&gt;</span> <span class="dt">GState</span> <span class="ot">-&gt;</span> <span class="dt">GAction</span> <span class="ot">-&gt;</span> <span class="dt">GState</span> <span class="ot">-&gt;</span> [(<span class="dt">Float</span>, <span class="dt">Float</span>)]</a>
<a class="sourceLine" id="cb5-20" data-line-number="20">rewards&#39; ph&#39; s a s&#39; <span class="fu">=</span> [(<span class="dv">0</span>, p)]</a>
<a class="sourceLine" id="cb5-21" data-line-number="21"> <span class="kw">where</span> p <span class="fu">=</span> <span class="kw">if</span> s&#39; <span class="fu">==</span> s <span class="fu">+</span> a</a>
<a class="sourceLine" id="cb5-22" data-line-number="22">             <span class="kw">then</span> ph&#39;</a>
<a class="sourceLine" id="cb5-23" data-line-number="23">             <span class="kw">else</span> <span class="dv">1</span> <span class="fu">-</span> ph&#39;</a>
<a class="sourceLine" id="cb5-24" data-line-number="24"></a>
<a class="sourceLine" id="cb5-25" data-line-number="25"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26"><span class="co">  Command line options defintions.</span></a>
<a class="sourceLine" id="cb5-27" data-line-number="27"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb5-28" data-line-number="28"></a>
<a class="sourceLine" id="cb5-29" data-line-number="29"><span class="kw">data</span> <span class="dt">Opts</span> w <span class="fu">=</span> <span class="dt">Opts</span></a>
<a class="sourceLine" id="cb5-30" data-line-number="30">    {<span class="ot"> nIter ::</span> w <span class="ot">::</span><span class="fu">:</span> <span class="dt">Maybe</span> <span class="dt">Int</span> <span class="fu">&lt;?&gt;</span></a>
<a class="sourceLine" id="cb5-31" data-line-number="31">        <span class="st">&quot;The number of policy improvement iterations&quot;</span></a>
<a class="sourceLine" id="cb5-32" data-line-number="32">    ,<span class="ot"> nEval ::</span> w <span class="ot">::</span><span class="fu">:</span> <span class="dt">Maybe</span> <span class="dt">Int</span> <span class="fu">&lt;?&gt;</span></a>
<a class="sourceLine" id="cb5-33" data-line-number="33">        <span class="st">&quot;The number of policy evaluation iterations per policy improvement iteration&quot;</span></a>
<a class="sourceLine" id="cb5-34" data-line-number="34">    ,<span class="ot"> eps ::</span> w <span class="ot">::</span><span class="fu">:</span> <span class="dt">Maybe</span> <span class="dt">Float</span> <span class="fu">&lt;?&gt;</span></a>
<a class="sourceLine" id="cb5-35" data-line-number="35">        <span class="st">&quot;Convergence tolerance&quot;</span></a>
<a class="sourceLine" id="cb5-36" data-line-number="36">    ,<span class="ot"> ph ::</span> w <span class="ot">::</span><span class="fu">:</span> <span class="dt">Maybe</span> <span class="dt">Float</span> <span class="fu">&lt;?&gt;</span></a>
<a class="sourceLine" id="cb5-37" data-line-number="37">        <span class="st">&quot;Probability of heads&quot;</span></a>
<a class="sourceLine" id="cb5-38" data-line-number="38">    }</a>
<a class="sourceLine" id="cb5-39" data-line-number="39">    <span class="kw">deriving</span> (<span class="dt">Generic</span>)</a>
<a class="sourceLine" id="cb5-40" data-line-number="40"></a>
<a class="sourceLine" id="cb5-41" data-line-number="41"><span class="kw">instance</span> <span class="dt">ParseRecord</span> (<span class="dt">Opts</span> <span class="dt">Wrapped</span>)</a>
<a class="sourceLine" id="cb5-42" data-line-number="42"></a>
<a class="sourceLine" id="cb5-43" data-line-number="43"></a>
<a class="sourceLine" id="cb5-44" data-line-number="44"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb5-45" data-line-number="45"><span class="co">  main()</span></a>
<a class="sourceLine" id="cb5-46" data-line-number="46"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb5-47" data-line-number="47"></a>
<a class="sourceLine" id="cb5-48" data-line-number="48"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb5-49" data-line-number="49">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb5-50" data-line-number="50">  <span class="co">-- Process command line options.</span></a>
<a class="sourceLine" id="cb5-51" data-line-number="51"><span class="ot">  o ::</span> <span class="dt">Opts</span> <span class="dt">Unwrapped</span> <span class="ot">&lt;-</span></a>
<a class="sourceLine" id="cb5-52" data-line-number="52">    unwrapRecord <span class="st">&quot;A solution to the &#39;Gambler&#39;s Problem&#39; (Ex. 4.9).&quot;</span></a>
<a class="sourceLine" id="cb5-53" data-line-number="53">  <span class="kw">let</span> nIters <span class="fu">=</span> fromMaybe <span class="dv">10</span>   (nIter o)</a>
<a class="sourceLine" id="cb5-54" data-line-number="54">      nEvals <span class="fu">=</span> fromMaybe  <span class="dv">1</span>   (nEval o)</a>
<a class="sourceLine" id="cb5-55" data-line-number="55">      eps&#39;   <span class="fu">=</span> fromMaybe  <span class="fl">0.1</span> (eps   o)</a>
<a class="sourceLine" id="cb5-56" data-line-number="56">      ph&#39;    <span class="fu">=</span> fromMaybe  <span class="fl">0.4</span> (ph    o)</a>
<a class="sourceLine" id="cb5-57" data-line-number="57"></a>
<a class="sourceLine" id="cb5-58" data-line-number="58">  <span class="co">-- Show policy/value convergence for different values of `nEval`.</span></a>
<a class="sourceLine" id="cb5-59" data-line-number="59">  forM_ (zip [(<span class="dv">1</span><span class="ot">::</span><span class="dt">Int</span>)<span class="fu">..</span><span class="dv">4</span>] [(<span class="dv">0</span><span class="ot">::</span><span class="dt">Int</span>),<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>]) <span class="fu">$</span> \(n, nEvals&#39;) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb5-60" data-line-number="60">    <span class="kw">let</span> iters <span class="fu">=</span> take (nIters <span class="fu">+</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-61" data-line-number="61">                     <span class="fu">$</span> iterate</a>
<a class="sourceLine" id="cb5-62" data-line-number="62">                         ( optPol</a>
<a class="sourceLine" id="cb5-63" data-line-number="63">                             rltDef</a>
<a class="sourceLine" id="cb5-64" data-line-number="64">                               { gamma      <span class="fu">=</span> gamma&#39;</a>
<a class="sourceLine" id="cb5-65" data-line-number="65">                               , epsilon    <span class="fu">=</span> eps&#39;</a>
<a class="sourceLine" id="cb5-66" data-line-number="66">                               , maxIter    <span class="fu">=</span> nEvals&#39;</a>
<a class="sourceLine" id="cb5-67" data-line-number="67">                               , states     <span class="fu">=</span> allStatesV</a>
<a class="sourceLine" id="cb5-68" data-line-number="68">                               , actions    <span class="fu">=</span> actions&#39;</a>
<a class="sourceLine" id="cb5-69" data-line-number="69">                               , nextStates <span class="fu">=</span> nextStates&#39;</a>
<a class="sourceLine" id="cb5-70" data-line-number="70">                               , rewards    <span class="fu">=</span> rewards&#39; ph&#39;</a>
<a class="sourceLine" id="cb5-71" data-line-number="71">                               , stateVals  <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-72" data-line-number="72">                                   [ (  <span class="dv">0</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb5-73" data-line-number="73">                                   , (<span class="dv">100</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-74" data-line-number="74">                                   ]</a>
<a class="sourceLine" id="cb5-75" data-line-number="75">                               }</a>
<a class="sourceLine" id="cb5-76" data-line-number="76">                         ) (\s <span class="ot">-&gt;</span> <span class="kw">if</span> s <span class="fu">==</span> <span class="dv">100</span> <span class="kw">then</span> (<span class="dv">0</span>,<span class="dv">1</span>) <span class="kw">else</span> (<span class="dv">0</span>,<span class="dv">0</span>), [])</a>
<a class="sourceLine" id="cb5-77" data-line-number="77">        acts  <span class="fu">=</span> map ((\f <span class="ot">-&gt;</span> VS.map (fst <span class="fu">.</span> f) allStatesV) <span class="fu">.</span> fst) iters</a>
<a class="sourceLine" id="cb5-78" data-line-number="78">        diffs <span class="fu">=</span> map (VS.map (fromIntegral <span class="fu">.</span> abs) <span class="fu">.</span> uncurry (<span class="fu">-</span>))</a>
<a class="sourceLine" id="cb5-79" data-line-number="79">                    <span class="fu">$</span> zip acts (P.tail acts)</a>
<a class="sourceLine" id="cb5-80" data-line-number="80">        ((_, (_, _)), cnts) <span class="fu">=</span> first (fromMaybe (P.error <span class="st">&quot;main: Major failure!&quot;</span>)) <span class="fu">$</span></a>
<a class="sourceLine" id="cb5-81" data-line-number="81">          runWriter <span class="fu">$</span> withinOnM eps&#39;</a>
<a class="sourceLine" id="cb5-82" data-line-number="82">                                ( \ (dv, (_, cnts&#39;)) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-83" data-line-number="83">                                    <span class="kw">do</span> tell <span class="fu">$</span> map negate cnts&#39;  <span class="co">-- to distinguish them</span></a>
<a class="sourceLine" id="cb5-84" data-line-number="84">                                       maxAndNonZero dv</a>
<a class="sourceLine" id="cb5-85" data-line-number="85">                                ) <span class="fu">$</span> zip diffs (P.tail iters)</a>
<a class="sourceLine" id="cb5-86" data-line-number="86">    toFile def (printf <span class="st">&quot;img/gam_cnv%d.png&quot;</span> n) <span class="fu">$</span></a>
<a class="sourceLine" id="cb5-87" data-line-number="87">      <span class="kw">do</span> layout_title <span class="fu">.=</span> (printf <span class="st">&quot;Value Function &amp; Policy Convergence (nEval = %d)&quot;</span> nEvals&#39;)</a>
<a class="sourceLine" id="cb5-88" data-line-number="88">         layout_x_axis <span class="fu">.</span> laxis_title <span class="fu">.=</span> <span class="st">&quot;Iteration (mixed)&quot;</span></a>
<a class="sourceLine" id="cb5-89" data-line-number="89">         layout_y_axis <span class="fu">.</span> laxis_title <span class="fu">.=</span> <span class="st">&quot;# of diffs &gt;eps.&quot;</span></a>
<a class="sourceLine" id="cb5-90" data-line-number="90">         plot (line <span class="st">&quot;Value&quot;</span>  [zip (findIndices (<span class="fu">&lt;=</span> <span class="dv">0</span>) cnts) (map negate <span class="fu">$</span> filter (<span class="fu">&lt;=</span> <span class="dv">0</span>) cnts)])</a>
<a class="sourceLine" id="cb5-91" data-line-number="91">         plot (line <span class="st">&quot;Policy&quot;</span> [zip (findIndices (<span class="fu">&gt;</span> <span class="dv">0</span>) cnts)  (filter (<span class="fu">&gt;</span> <span class="dv">0</span>) cnts)])</a>
<a class="sourceLine" id="cb5-92" data-line-number="92"></a>
<a class="sourceLine" id="cb5-93" data-line-number="93">  writeFile  <span class="st">&quot;other/gambler.md&quot;</span> (pack <span class="fu">$</span> printf <span class="st">&quot;\n$eps = %04.2g$\n&quot;</span> eps&#39;)</a>
<a class="sourceLine" id="cb5-94" data-line-number="94">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;\n### Value/Policy convergence vs. `nEval`\n\n&quot;</span></a>
<a class="sourceLine" id="cb5-95" data-line-number="95">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> (pack <span class="fu">$</span> printf <span class="st">&quot;$ph = %04.2f$\n\n&quot;</span> ph&#39;)</a>
<a class="sourceLine" id="cb5-96" data-line-number="96">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;Note: `nEval` of zero is _Value Iteration_.\n\n&quot;</span></a>
<a class="sourceLine" id="cb5-97" data-line-number="97">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;|     |     |\n&quot;</span></a>
<a class="sourceLine" id="cb5-98" data-line-number="98">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;| --- | --- |\n&quot;</span></a>
<a class="sourceLine" id="cb5-99" data-line-number="99">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;| ![](img/gam_cnv1.png) | ![](img/gam_cnv2.png) |\n&quot;</span></a>
<a class="sourceLine" id="cb5-100" data-line-number="100">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;| ![](img/gam_cnv3.png) | ![](img/gam_cnv4.png) |\n&quot;</span></a>
<a class="sourceLine" id="cb5-101" data-line-number="101"></a>
<a class="sourceLine" id="cb5-102" data-line-number="102">  <span class="co">-- Plot the state value functions and final policies for different `ph` values.</span></a>
<a class="sourceLine" id="cb5-103" data-line-number="103">  forM_ (zip [(<span class="dv">1</span><span class="ot">::</span><span class="dt">Int</span>)<span class="fu">..</span><span class="dv">4</span>] [(<span class="fl">0.25</span><span class="ot">::</span><span class="dt">Float</span>),<span class="fl">0.4</span>,<span class="fl">0.5</span>,<span class="fl">0.55</span>]) <span class="fu">$</span> \(n, ph&#39;&#39;) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb5-104" data-line-number="104">    <span class="kw">let</span> iters&#39; <span class="fu">=</span> take (nIters <span class="fu">+</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-105" data-line-number="105">                     <span class="fu">$</span> iterate</a>
<a class="sourceLine" id="cb5-106" data-line-number="106">                         ( optPol</a>
<a class="sourceLine" id="cb5-107" data-line-number="107">                             rltDef</a>
<a class="sourceLine" id="cb5-108" data-line-number="108">                               { gamma      <span class="fu">=</span> gamma&#39;</a>
<a class="sourceLine" id="cb5-109" data-line-number="109">                               , epsilon    <span class="fu">=</span> eps&#39;</a>
<a class="sourceLine" id="cb5-110" data-line-number="110">                               , maxIter    <span class="fu">=</span> nEvals</a>
<a class="sourceLine" id="cb5-111" data-line-number="111">                               , states     <span class="fu">=</span> allStatesV</a>
<a class="sourceLine" id="cb5-112" data-line-number="112">                               , actions    <span class="fu">=</span> actions&#39;</a>
<a class="sourceLine" id="cb5-113" data-line-number="113">                               , nextStates <span class="fu">=</span> nextStates&#39;</a>
<a class="sourceLine" id="cb5-114" data-line-number="114">                               , rewards    <span class="fu">=</span> rewards&#39; ph&#39;&#39;</a>
<a class="sourceLine" id="cb5-115" data-line-number="115">                               , stateVals  <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-116" data-line-number="116">                                   [ (  <span class="dv">0</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb5-117" data-line-number="117">                                   , (<span class="dv">100</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-118" data-line-number="118">                                   ]</a>
<a class="sourceLine" id="cb5-119" data-line-number="119">                               }</a>
<a class="sourceLine" id="cb5-120" data-line-number="120">                         ) (\s <span class="ot">-&gt;</span> <span class="kw">if</span> s <span class="fu">==</span> <span class="dv">100</span> <span class="kw">then</span> (<span class="dv">0</span>,<span class="dv">1</span>) <span class="kw">else</span> (<span class="dv">0</span>,<span class="dv">0</span>), [])</a>
<a class="sourceLine" id="cb5-121" data-line-number="121">        acts&#39;  <span class="fu">=</span> map ((\f <span class="ot">-&gt;</span> VS.map (fst <span class="fu">.</span> f) allStatesV) <span class="fu">.</span> fst) iters&#39;</a>
<a class="sourceLine" id="cb5-122" data-line-number="122">        diffs&#39; <span class="fu">=</span> map (VS.map (fromIntegral <span class="fu">.</span> abs) <span class="fu">.</span> uncurry (<span class="fu">-</span>))</a>
<a class="sourceLine" id="cb5-123" data-line-number="123">                    <span class="fu">$</span> zip acts&#39; (P.tail acts&#39;)</a>
<a class="sourceLine" id="cb5-124" data-line-number="124">        ((_, (g&#39;&#39;, _)), _) <span class="fu">=</span> first (fromMaybe (P.error <span class="st">&quot;main: Major failure!&quot;</span>)) <span class="fu">$</span></a>
<a class="sourceLine" id="cb5-125" data-line-number="125">          runWriter <span class="fu">$</span> withinOnM eps&#39;</a>
<a class="sourceLine" id="cb5-126" data-line-number="126">                                ( \ (dv, (_, cnts&#39;)) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-127" data-line-number="127">                                    <span class="kw">do</span> tell <span class="fu">$</span> map negate cnts&#39;  <span class="co">-- to distinguish them</span></a>
<a class="sourceLine" id="cb5-128" data-line-number="128">                                       maxAndNonZero dv</a>
<a class="sourceLine" id="cb5-129" data-line-number="129">                                ) <span class="fu">$</span> zip diffs&#39; (P.tail iters&#39;)</a>
<a class="sourceLine" id="cb5-130" data-line-number="130">        pol&#39;   <span class="fu">=</span> fst <span class="fu">.</span> g&#39;&#39;</a>
<a class="sourceLine" id="cb5-131" data-line-number="131">        val&#39;   <span class="fu">=</span> snd <span class="fu">.</span> g&#39;&#39;</a>
<a class="sourceLine" id="cb5-132" data-line-number="132">        vs&#39;    <span class="fu">=</span> map (\(g, _) <span class="ot">-&gt;</span> snd <span class="fu">.</span> g) iters&#39;</a>
<a class="sourceLine" id="cb5-133" data-line-number="133">    toFile def (printf <span class="st">&quot;img/gam_val%d.png&quot;</span> n) <span class="fu">$</span></a>
<a class="sourceLine" id="cb5-134" data-line-number="134">      <span class="kw">do</span> layout_title <span class="fu">.=</span> (printf <span class="st">&quot;State Value Functions (ph = %04.2f)&quot;</span> ph&#39;&#39;)</a>
<a class="sourceLine" id="cb5-135" data-line-number="135">         layout_x_axis <span class="fu">.</span> laxis_title <span class="fu">.=</span> <span class="st">&quot;Iteration (mixed)&quot;</span></a>
<a class="sourceLine" id="cb5-136" data-line-number="136">         layout_y_axis <span class="fu">.</span> laxis_title <span class="fu">.=</span> <span class="st">&quot;# of diffs&#39; &gt;eps.&quot;</span></a>
<a class="sourceLine" id="cb5-137" data-line-number="137">         setColors <span class="fu">$</span> map opaque [red, green, blue, black]</a>
<a class="sourceLine" id="cb5-138" data-line-number="138">         forM_ ( zip [<span class="st">&quot;1 Iter.&quot;</span>, <span class="st">&quot;2 Iters.&quot;</span>, <span class="st">&quot;3 Iters.&quot;</span>]</a>
<a class="sourceLine" id="cb5-139" data-line-number="139">                     [<span class="dv">1</span>,      <span class="dv">2</span>,      <span class="dv">3</span>]</a>
<a class="sourceLine" id="cb5-140" data-line-number="140">               ) <span class="fu">$</span> \ (lbl, n&#39;) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-141" data-line-number="141">                     plot ( line lbl</a>
<a class="sourceLine" id="cb5-142" data-line-number="142">                                 [ [ (x, (vs&#39; <span class="fu">P.!!</span> n&#39;) x)</a>
<a class="sourceLine" id="cb5-143" data-line-number="143">                                   <span class="fu">|</span> x <span class="ot">&lt;-</span> [(<span class="dv">0</span><span class="ot">::</span><span class="dt">GState</span>)<span class="fu">..</span><span class="dv">100</span>]</a>
<a class="sourceLine" id="cb5-144" data-line-number="144">                                   ]</a>
<a class="sourceLine" id="cb5-145" data-line-number="145">                                 ]</a>
<a class="sourceLine" id="cb5-146" data-line-number="146">                          )</a>
<a class="sourceLine" id="cb5-147" data-line-number="147">         plot ( line <span class="st">&quot;Final&quot;</span></a>
<a class="sourceLine" id="cb5-148" data-line-number="148">                     [ [ (x, val&#39; x)</a>
<a class="sourceLine" id="cb5-149" data-line-number="149">                       <span class="fu">|</span> x <span class="ot">&lt;-</span> [<span class="dv">0</span><span class="fu">..</span><span class="dv">100</span>]</a>
<a class="sourceLine" id="cb5-150" data-line-number="150">                       ]</a>
<a class="sourceLine" id="cb5-151" data-line-number="151">                     ]</a>
<a class="sourceLine" id="cb5-152" data-line-number="152">              )</a>
<a class="sourceLine" id="cb5-153" data-line-number="153">    toFile def (printf <span class="st">&quot;img/gam_pol%d.png&quot;</span> n) <span class="fu">$</span></a>
<a class="sourceLine" id="cb5-154" data-line-number="154">      <span class="kw">do</span> layout_title <span class="fu">.=</span> (printf <span class="st">&quot;Final Policy Function (ph = %04.2f)&quot;</span> ph&#39;&#39;)</a>
<a class="sourceLine" id="cb5-155" data-line-number="155">         layout_x_axis <span class="fu">.</span> laxis_title <span class="fu">.=</span> <span class="st">&quot;State&quot;</span></a>
<a class="sourceLine" id="cb5-156" data-line-number="156">         layout_y_axis <span class="fu">.</span> laxis_title <span class="fu">.=</span> <span class="st">&quot;Action&quot;</span></a>
<a class="sourceLine" id="cb5-157" data-line-number="157">         setColors <span class="fu">$</span> map opaque [blue, green, black]</a>
<a class="sourceLine" id="cb5-158" data-line-number="158">         plot ( line <span class="st">&quot;pi(s)&quot;</span></a>
<a class="sourceLine" id="cb5-159" data-line-number="159">                     [ [ (x, pol&#39; x)</a>
<a class="sourceLine" id="cb5-160" data-line-number="160">                       <span class="fu">|</span> x <span class="ot">&lt;-</span> [<span class="dv">0</span><span class="fu">..</span><span class="dv">100</span>]</a>
<a class="sourceLine" id="cb5-161" data-line-number="161">                       ]</a>
<a class="sourceLine" id="cb5-162" data-line-number="162">                     ]</a>
<a class="sourceLine" id="cb5-163" data-line-number="163">              )</a>
<a class="sourceLine" id="cb5-164" data-line-number="164"></a>
<a class="sourceLine" id="cb5-165" data-line-number="165">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;\n### State Value Functions vs. `ph`\n\n&quot;</span></a>
<a class="sourceLine" id="cb5-166" data-line-number="166">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> (pack <span class="fu">$</span> printf <span class="st">&quot;$nEval = %d$\n\n&quot;</span> nEvals)</a>
<a class="sourceLine" id="cb5-167" data-line-number="167">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;|     |     |\n&quot;</span></a>
<a class="sourceLine" id="cb5-168" data-line-number="168">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;| --- | --- |\n&quot;</span></a>
<a class="sourceLine" id="cb5-169" data-line-number="169">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;| ![](img/gam_val1.png) | ![](img/gam_val2.png) |\n&quot;</span></a>
<a class="sourceLine" id="cb5-170" data-line-number="170">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;| ![](img/gam_val3.png) | ![](img/gam_val4.png) |\n&quot;</span></a>
<a class="sourceLine" id="cb5-171" data-line-number="171"></a>
<a class="sourceLine" id="cb5-172" data-line-number="172">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;\n### Final Policy Function vs. `ph`\n\n&quot;</span></a>
<a class="sourceLine" id="cb5-173" data-line-number="173">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> (pack <span class="fu">$</span> printf <span class="st">&quot;$nEval = %d$\n\n&quot;</span> nEvals)</a>
<a class="sourceLine" id="cb5-174" data-line-number="174">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;|     |     |\n&quot;</span></a>
<a class="sourceLine" id="cb5-175" data-line-number="175">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;| --- | --- |\n&quot;</span></a>
<a class="sourceLine" id="cb5-176" data-line-number="176">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;| ![](img/gam_pol1.png) | ![](img/gam_pol2.png) |\n&quot;</span></a>
<a class="sourceLine" id="cb5-177" data-line-number="177">  appendFile <span class="st">&quot;other/gambler.md&quot;</span> <span class="st">&quot;| ![](img/gam_pol3.png) | ![](img/gam_pol4.png) |\n&quot;</span></a></code></pre></div>
<h2 id="output">output</h2>
<pre class="include"><code>other/gambler.md</code></pre>
<hr />
<div class="footer">
<p>Powered by <a href="https://haskell-lang.org/">haskell</a>, <a href="https://docs.haskellstack.org/en/stable/README/">stack</a> and <a href="http://pandoc.org/">pandoc</a>.</p>
</div>

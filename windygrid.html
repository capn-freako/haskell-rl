<meta charset="utf-8"> <link rel="stylesheet" href="other/lhs.css">
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<h1 id="haskell-rl-stochastically-windy-gridworld">haskell-rl : Stochastically Windy Gridworld</h1>
<p>This <a href="https://wiki.haskell.org/Literate_programming">literate Haskell</a> document provides a solution to Ex. 6.10 - <em>Windy Gridworld w/ King’s Moves and Stochastic Wind</em>.</p>
<p>Original author: <a href="mailto:David.Banas@target.com">David Banas</a><br />
Original date: June 28, 2018</p>
<p>Copyright © 2018 Target Corp.; all rights reserved World wide.</p>
<h2 id="contents">Contents</h2>
<ul class="incremental">
<li><a href="#code">Code</a></li>
<li><a href="#output">Output</a></li>
<li>=&gt; <a href="#dp-results">DP Results</a></li>
<li>=&gt; <a href="#td-results">TD Results</a></li>
<li><a href="#debug">Debug</a></li>
</ul>
<h2 id="code">code</h2>
<h2 id="ghc-options"><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/flags.html#flag-reference">ghc options</a></h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="ot">{-# OPTIONS_GHC -Wall #-}</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="ot">{-# OPTIONS_GHC -fno-warn-type-defaults #-}</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="ot">{-# OPTIONS_GHC -Wno-missing-signatures #-}</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="ot">{-# OPTIONS_GHC -Wno-orphans #-}</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="ot">{-# OPTIONS_GHC -cpp #-}</span></a></code></pre></div>
<h2 id="pragmas"><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/lang.html">pragmas</a></h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">-- doctest doesn&#39;t look at the cabal file, so you need pragmas here</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="ot">{-# LANGUAGE NoImplicitPrelude #-}</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="ot">{-# LANGUAGE DataKinds #-}</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="ot">{-# LANGUAGE DeriveGeneric #-}</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="ot">{-# LANGUAGE FlexibleContexts #-}</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="ot">{-# LANGUAGE FlexibleInstances #-}</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="ot">{-# LANGUAGE LambdaCase #-}</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="ot">{-# LANGUAGE RecordWildCards #-}</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="ot">{-# LANGUAGE ScopedTypeVariables #-}</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="ot">{-# LANGUAGE TupleSections #-}</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="ot">{-# LANGUAGE TypeApplications #-}</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="ot">{-# LANGUAGE TypeFamilies #-}</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="ot">{-# LANGUAGE TypeOperators #-}</span></a></code></pre></div>
<h2 id="libraries"><a href="https://www.stackage.org/">libraries</a></h2>
<ul class="incremental">
<li><a href="https://www.stackage.org/package/protolude">protolude</a></li>
<li><a href="https://www.stackage.org/package/optparse-generic">optparse-generic</a></li>
<li><a href="https://www.stackage.org/package/vector-sized">vector-sized</a></li>
<li><a href="https://www.stackage.org/package/finite-typelits">finite-typelits</a></li>
<li><a href="https://www.stackage.org/package/extra">extra</a></li>
<li><a href="https://www.stackage.org/package/text">text</a></li>
<li><a href="https://www.stackage.org/package/random">random</a></li>
<li><a href="https://www.stackage.org/package/random-shuffle">random-shuffle</a></li>
<li><a href="https://www.stackage.org/package/Chart">Chart</a></li>
<li><a href="https://www.stackage.org/package/Chart-cairo">Chart-cairo</a></li>
<li><a href="https://hackage.haskell.org/package/MemoTrie">MemoTrie</a></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Prelude</span> <span class="kw">as</span> <span class="dt">P</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">import</span> <span class="dt">Prelude</span> (unlines, <span class="dt">Show</span>(..), <span class="dt">String</span>)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">import</span> <span class="dt">Protolude</span>  <span class="kw">hiding</span> (show, for, first, second)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">import</span> <span class="dt">Options.Generic</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw">import</span> <span class="dt">Control.Arrow</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="kw">import</span> <span class="dt">Control.Monad.Writer</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Vector.Sized</span>   <span class="kw">as</span> <span class="dt">VS</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="kw">import</span> <span class="dt">Data.Finite</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Data.MemoTrie</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="kw">import</span> <span class="dt">Data.Text</span>                              (pack)</a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="kw">import</span> <span class="dt">Graphics.Rendering.Chart.Easy</span> <span class="kw">hiding</span>   (<span class="dt">Wrapped</span>, <span class="dt">Unwrapped</span>, <span class="dt">Empty</span>, <span class="dt">Iso</span>)</a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="kw">import</span> <span class="dt">Graphics.Rendering.Chart.Backend.Cairo</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="kw">import</span> <span class="dt">Text.Printf</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="kw">import</span> <span class="dt">ConCat.Isomorphism</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="kw">import</span> <span class="dt">ConCat.TArr</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="kw">import</span> <span class="dt">RL.GPI</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21"><span class="kw">import</span> <span class="dt">RL.MDP</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22"><span class="kw">import</span> <span class="dt">RL.Util</span></a></code></pre></div>
<ul class="incremental">
<li><a href="https://www.stackage.org/package/hoogle">hoogle</a></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">  Problem specific definitions</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">gGamma   <span class="fu">=</span> <span class="dv">1</span>  <span class="co">-- Specified by problem.</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">gWind    <span class="fu">=</span> fromMaybe (P.error <span class="st">&quot;gWind: Sized vector initialization from list failure!&quot;</span>)</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">                     (VS.fromList [<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">0</span>]<span class="ot"> ::</span> <span class="dt">Maybe</span> (<span class="dt">VS.Vector</span> <span class="dv">10</span> <span class="dt">Int</span>))</a>
<a class="sourceLine" id="cb4-9" data-line-number="9"></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="kw">type</span> <span class="dt">NNumRows</span> <span class="fu">=</span> <span class="dv">7</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">gNumRows <span class="fu">=</span> int <span class="fu">@</span><span class="dt">NNumRows</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="kw">type</span> <span class="dt">NNumCols</span> <span class="fu">=</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14">gNumCols <span class="fu">=</span> int <span class="fu">@</span><span class="dt">NNumCols</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="kw">type</span> <span class="dt">Na</span> <span class="fu">=</span> <span class="dv">9</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="kw">type</span> <span class="dt">MyState</span> <span class="fu">=</span> (<span class="dt">Finite</span> <span class="dt">NNumRows</span>, <span class="dt">Finite</span> <span class="dt">NNumCols</span>)</a>
<a class="sourceLine" id="cb4-19" data-line-number="19"></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="kw">instance</span> <span class="dt">MDP</span> <span class="dt">MyState</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21">  <span class="kw">type</span> <span class="dt">ActionT</span> <span class="dt">MyState</span> <span class="fu">=</span> <span class="dt">MyAction</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22">  states <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23">    [ ((finite <span class="fu">.</span> fromIntegral) r, (finite <span class="fu">.</span> fromIntegral) c)</a>
<a class="sourceLine" id="cb4-24" data-line-number="24">    <span class="fu">|</span> r <span class="ot">&lt;-</span> [<span class="dv">0</span><span class="fu">..</span>(gNumRows <span class="fu">-</span> <span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb4-25" data-line-number="25">    , c <span class="ot">&lt;-</span> [<span class="dv">0</span><span class="fu">..</span>(gNumCols <span class="fu">-</span> <span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb4-26" data-line-number="26">    ]</a>
<a class="sourceLine" id="cb4-27" data-line-number="27">  actions <span class="fu">=</span> const [<span class="dt">Up</span>, <span class="dt">Dn</span>, <span class="dt">Rt</span>, <span class="dt">Lt</span>, <span class="dt">UL</span>, <span class="dt">UR</span>, <span class="dt">DL</span>, <span class="dt">DR</span>, <span class="dt">NM</span>]</a>
<a class="sourceLine" id="cb4-28" data-line-number="28">  jointPMF s<span class="fu">@</span>(r,c) act <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-29" data-line-number="29">    [ ((s&#39;, rwd), <span class="fl">0.3333</span>)</a>
<a class="sourceLine" id="cb4-30" data-line-number="30">    <span class="fu">|</span> wr <span class="ot">&lt;-</span> <span class="kw">let</span> wind <span class="fu">=</span> gWind <span class="ot">`VS.index`</span> finite (fromIntegral c)</a>
<a class="sourceLine" id="cb4-31" data-line-number="31">             <span class="kw">in</span> <span class="kw">if</span> wind <span class="fu">/=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-32" data-line-number="32">                  <span class="kw">then</span> [wind <span class="fu">-</span> <span class="dv">1</span>, wind, wind <span class="fu">+</span> <span class="dv">1</span>]</a>
<a class="sourceLine" id="cb4-33" data-line-number="33">                  <span class="kw">else</span> [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>]  <span class="co">-- Duplication is to keep probabilities correct.</span></a>
<a class="sourceLine" id="cb4-34" data-line-number="34">    , <span class="kw">let</span> s&#39; <span class="fu">=</span> <span class="kw">if</span> s <span class="ot">`elem`</span> termStates</a>
<a class="sourceLine" id="cb4-35" data-line-number="35">                 <span class="kw">then</span> s</a>
<a class="sourceLine" id="cb4-36" data-line-number="36">                 <span class="kw">else</span> bound ((fromIntegral <span class="fu">.</span> getFinite) r <span class="fu">+</span> dr <span class="fu">+</span> wr, (fromIntegral <span class="fu">.</span> getFinite) c <span class="fu">+</span> dc)</a>
<a class="sourceLine" id="cb4-37" data-line-number="37">          dr <span class="fu">=</span> <span class="kw">case</span> act <span class="kw">of</span></a>
<a class="sourceLine" id="cb4-38" data-line-number="38">                 <span class="dt">Up</span> <span class="ot">-&gt;</span>  <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-39" data-line-number="39">                 <span class="dt">Dn</span> <span class="ot">-&gt;</span> <span class="fu">-</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb4-40" data-line-number="40">                 <span class="dt">Lt</span> <span class="ot">-&gt;</span>  <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-41" data-line-number="41">                 <span class="dt">Rt</span> <span class="ot">-&gt;</span>  <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-42" data-line-number="42">                 <span class="dt">UL</span> <span class="ot">-&gt;</span>  <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-43" data-line-number="43">                 <span class="dt">UR</span> <span class="ot">-&gt;</span>  <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-44" data-line-number="44">                 <span class="dt">DL</span> <span class="ot">-&gt;</span> <span class="fu">-</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb4-45" data-line-number="45">                 <span class="dt">DR</span> <span class="ot">-&gt;</span> <span class="fu">-</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb4-46" data-line-number="46">                 <span class="dt">NM</span> <span class="ot">-&gt;</span>  <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-47" data-line-number="47">          dc <span class="fu">=</span> <span class="kw">case</span> act <span class="kw">of</span></a>
<a class="sourceLine" id="cb4-48" data-line-number="48">                 <span class="dt">Up</span> <span class="ot">-&gt;</span>  <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-49" data-line-number="49">                 <span class="dt">Dn</span> <span class="ot">-&gt;</span>  <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-50" data-line-number="50">                 <span class="dt">Lt</span> <span class="ot">-&gt;</span> <span class="fu">-</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb4-51" data-line-number="51">                 <span class="dt">Rt</span> <span class="ot">-&gt;</span>  <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-52" data-line-number="52">                 <span class="dt">UL</span> <span class="ot">-&gt;</span> <span class="fu">-</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb4-53" data-line-number="53">                 <span class="dt">UR</span> <span class="ot">-&gt;</span>  <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-54" data-line-number="54">                 <span class="dt">DL</span> <span class="ot">-&gt;</span> <span class="fu">-</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb4-55" data-line-number="55">                 <span class="dt">DR</span> <span class="ot">-&gt;</span>  <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-56" data-line-number="56">                 <span class="dt">NM</span> <span class="ot">-&gt;</span>  <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-57" data-line-number="57">          bound (row, col) <span class="fu">=</span> ( (finite <span class="fu">.</span> fromIntegral) <span class="fu">$</span> min (gNumRows <span class="fu">-</span> <span class="dv">1</span>) (max <span class="dv">0</span> row)</a>
<a class="sourceLine" id="cb4-58" data-line-number="58">                             , (finite <span class="fu">.</span> fromIntegral) <span class="fu">$</span> min (gNumCols <span class="fu">-</span> <span class="dv">1</span>) (max <span class="dv">0</span> col ) )</a>
<a class="sourceLine" id="cb4-59" data-line-number="59">          rwd <span class="fu">=</span> fromIntegral <span class="fu">$</span></a>
<a class="sourceLine" id="cb4-60" data-line-number="60">            <span class="kw">if</span> s&#39; <span class="ot">`elem`</span> termStates</a>
<a class="sourceLine" id="cb4-61" data-line-number="61">              <span class="kw">then</span>  <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-62" data-line-number="62">              <span class="kw">else</span> <span class="fu">-</span><span class="dv">1</span></a>
<a class="sourceLine" id="cb4-63" data-line-number="63">    ]</a>
<a class="sourceLine" id="cb4-64" data-line-number="64">  termStates <span class="fu">=</span> [(<span class="dv">3</span>,<span class="dv">7</span>)]</a>
<a class="sourceLine" id="cb4-65" data-line-number="65">  initStates <span class="fu">=</span> [(<span class="dv">3</span>,<span class="dv">0</span>)]</a>
<a class="sourceLine" id="cb4-66" data-line-number="66"></a>
<a class="sourceLine" id="cb4-67" data-line-number="67"><span class="kw">data</span> <span class="dt">MyAction</span> <span class="fu">=</span> <span class="dt">Up</span></a>
<a class="sourceLine" id="cb4-68" data-line-number="68">              <span class="fu">|</span> <span class="dt">Dn</span></a>
<a class="sourceLine" id="cb4-69" data-line-number="69">              <span class="fu">|</span> <span class="dt">Rt</span></a>
<a class="sourceLine" id="cb4-70" data-line-number="70">              <span class="fu">|</span> <span class="dt">Lt</span></a>
<a class="sourceLine" id="cb4-71" data-line-number="71">              <span class="fu">|</span> <span class="dt">UL</span></a>
<a class="sourceLine" id="cb4-72" data-line-number="72">              <span class="fu">|</span> <span class="dt">UR</span></a>
<a class="sourceLine" id="cb4-73" data-line-number="73">              <span class="fu">|</span> <span class="dt">DL</span></a>
<a class="sourceLine" id="cb4-74" data-line-number="74">              <span class="fu">|</span> <span class="dt">DR</span></a>
<a class="sourceLine" id="cb4-75" data-line-number="75">              <span class="fu">|</span> <span class="dt">NM</span>  <span class="co">-- no move</span></a>
<a class="sourceLine" id="cb4-76" data-line-number="76">  <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Ord</span>, <span class="dt">Generic</span>)</a>
<a class="sourceLine" id="cb4-77" data-line-number="77"></a>
<a class="sourceLine" id="cb4-78" data-line-number="78"><span class="kw">instance</span> <span class="dt">Show</span> <span class="dt">MyAction</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-79" data-line-number="79">  show x <span class="fu">=</span> <span class="kw">case</span> x <span class="kw">of</span></a>
<a class="sourceLine" id="cb4-80" data-line-number="80">             <span class="dt">Up</span> <span class="ot">-&gt;</span> <span class="st">&quot;\\uparrow &quot;</span></a>
<a class="sourceLine" id="cb4-81" data-line-number="81">             <span class="dt">Dn</span> <span class="ot">-&gt;</span> <span class="st">&quot;\\downarrow &quot;</span></a>
<a class="sourceLine" id="cb4-82" data-line-number="82">             <span class="dt">Rt</span> <span class="ot">-&gt;</span> <span class="st">&quot;\\rightarrow &quot;</span></a>
<a class="sourceLine" id="cb4-83" data-line-number="83">             <span class="dt">Lt</span> <span class="ot">-&gt;</span> <span class="st">&quot;\\leftarrow &quot;</span></a>
<a class="sourceLine" id="cb4-84" data-line-number="84">             <span class="dt">UL</span> <span class="ot">-&gt;</span> <span class="st">&quot;\\nwarrow &quot;</span></a>
<a class="sourceLine" id="cb4-85" data-line-number="85">             <span class="dt">UR</span> <span class="ot">-&gt;</span> <span class="st">&quot;\\nearrow &quot;</span></a>
<a class="sourceLine" id="cb4-86" data-line-number="86">             <span class="dt">DL</span> <span class="ot">-&gt;</span> <span class="st">&quot;\\swarrow &quot;</span></a>
<a class="sourceLine" id="cb4-87" data-line-number="87">             <span class="dt">DR</span> <span class="ot">-&gt;</span> <span class="st">&quot;\\searrow &quot;</span></a>
<a class="sourceLine" id="cb4-88" data-line-number="88">             <span class="dt">NM</span> <span class="ot">-&gt;</span> <span class="st">&quot;\\cdot &quot;</span></a>
<a class="sourceLine" id="cb4-89" data-line-number="89"></a>
<a class="sourceLine" id="cb4-90" data-line-number="90"><span class="kw">instance</span> <span class="dt">HasTrie</span> <span class="dt">MyAction</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-91" data-line-number="91">  <span class="kw">newtype</span> (<span class="dt">MyAction</span> <span class="fu">:-&gt;:</span> b) <span class="fu">=</span> <span class="dt">MyActionTrie</span> {<span class="ot"> unMyActionTrie ::</span> <span class="dt">Reg</span> <span class="dt">MyAction</span> <span class="fu">:-&gt;:</span> b } </a>
<a class="sourceLine" id="cb4-92" data-line-number="92">  trie      <span class="fu">=</span> trieGeneric      <span class="dt">MyActionTrie</span> </a>
<a class="sourceLine" id="cb4-93" data-line-number="93">  untrie    <span class="fu">=</span> untrieGeneric    unMyActionTrie</a>
<a class="sourceLine" id="cb4-94" data-line-number="94">  enumerate <span class="fu">=</span> enumerateGeneric unMyActionTrie</a>
<a class="sourceLine" id="cb4-95" data-line-number="95"></a>
<a class="sourceLine" id="cb4-96" data-line-number="96"><span class="kw">instance</span> <span class="dt">HasFin</span> <span class="dt">MyAction</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-97" data-line-number="97">  <span class="kw">type</span> <span class="dt">Card</span> <span class="dt">MyAction</span> <span class="fu">=</span> <span class="dt">Na</span></a>
<a class="sourceLine" id="cb4-98" data-line-number="98">  iso <span class="fu">=</span> <span class="dt">Iso</span> actToFin finToAct</a>
<a class="sourceLine" id="cb4-99" data-line-number="99"></a>
<a class="sourceLine" id="cb4-100" data-line-number="100"><span class="ot">actToFin ::</span> <span class="dt">MyAction</span> <span class="ot">-&gt;</span> <span class="dt">Finite</span> <span class="dt">Na</span></a>
<a class="sourceLine" id="cb4-101" data-line-number="101">actToFin <span class="fu">=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb4-102" data-line-number="102">  <span class="dt">Up</span> <span class="ot">-&gt;</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-103" data-line-number="103">  <span class="dt">Dn</span> <span class="ot">-&gt;</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-104" data-line-number="104">  <span class="dt">Rt</span> <span class="ot">-&gt;</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb4-105" data-line-number="105">  <span class="dt">Lt</span> <span class="ot">-&gt;</span> <span class="dv">3</span></a>
<a class="sourceLine" id="cb4-106" data-line-number="106">  <span class="dt">UL</span> <span class="ot">-&gt;</span> <span class="dv">4</span></a>
<a class="sourceLine" id="cb4-107" data-line-number="107">  <span class="dt">UR</span> <span class="ot">-&gt;</span> <span class="dv">5</span></a>
<a class="sourceLine" id="cb4-108" data-line-number="108">  <span class="dt">DL</span> <span class="ot">-&gt;</span> <span class="dv">6</span></a>
<a class="sourceLine" id="cb4-109" data-line-number="109">  <span class="dt">DR</span> <span class="ot">-&gt;</span> <span class="dv">7</span></a>
<a class="sourceLine" id="cb4-110" data-line-number="110">  <span class="dt">NM</span> <span class="ot">-&gt;</span> <span class="dv">8</span></a>
<a class="sourceLine" id="cb4-111" data-line-number="111"></a>
<a class="sourceLine" id="cb4-112" data-line-number="112"><span class="ot">finToAct ::</span> <span class="dt">Finite</span> <span class="dt">Na</span> <span class="ot">-&gt;</span> <span class="dt">MyAction</span></a>
<a class="sourceLine" id="cb4-113" data-line-number="113">finToAct <span class="fu">=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb4-114" data-line-number="114">  <span class="dv">0</span> <span class="ot">-&gt;</span> <span class="dt">Up</span></a>
<a class="sourceLine" id="cb4-115" data-line-number="115">  <span class="dv">1</span> <span class="ot">-&gt;</span> <span class="dt">Dn</span></a>
<a class="sourceLine" id="cb4-116" data-line-number="116">  <span class="dv">2</span> <span class="ot">-&gt;</span> <span class="dt">Rt</span></a>
<a class="sourceLine" id="cb4-117" data-line-number="117">  <span class="dv">3</span> <span class="ot">-&gt;</span> <span class="dt">Lt</span></a>
<a class="sourceLine" id="cb4-118" data-line-number="118">  <span class="dv">4</span> <span class="ot">-&gt;</span> <span class="dt">UL</span></a>
<a class="sourceLine" id="cb4-119" data-line-number="119">  <span class="dv">5</span> <span class="ot">-&gt;</span> <span class="dt">UR</span></a>
<a class="sourceLine" id="cb4-120" data-line-number="120">  <span class="dv">6</span> <span class="ot">-&gt;</span> <span class="dt">DL</span></a>
<a class="sourceLine" id="cb4-121" data-line-number="121">  <span class="dv">7</span> <span class="ot">-&gt;</span> <span class="dt">DR</span></a>
<a class="sourceLine" id="cb4-122" data-line-number="122">  _ <span class="ot">-&gt;</span> <span class="dt">NM</span></a>
<a class="sourceLine" id="cb4-123" data-line-number="123"></a>
<a class="sourceLine" id="cb4-124" data-line-number="124"><span class="co">-- | Show a function from `MyState` to `Bool`.</span></a>
<a class="sourceLine" id="cb4-125" data-line-number="125"><span class="ot">showFofState ::</span> (<span class="dt">Show</span> a, <span class="dt">Typeable</span> a) <span class="ot">=&gt;</span> (<span class="dt">MyState</span> <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb4-126" data-line-number="126">showFofState g <span class="fu">=</span> unlines</a>
<a class="sourceLine" id="cb4-127" data-line-number="127">  ( (<span class="st">&quot;\\begin{array}{|&quot;</span> <span class="fu">++</span> (intersperse <span class="ch">&#39;|&#39;</span> (replicate gNumCols <span class="ch">&#39;c&#39;</span>)) <span class="fu">++</span> <span class="st">&quot;|}&quot;</span>) <span class="fu">:</span></a>
<a class="sourceLine" id="cb4-128" data-line-number="128">    ( <span class="st">&quot;\\hline&quot;</span> <span class="fu">:</span></a>
<a class="sourceLine" id="cb4-129" data-line-number="129">      intersperse <span class="st">&quot;\\hline&quot;</span></a>
<a class="sourceLine" id="cb4-130" data-line-number="130">        ( map ((<span class="fu">++</span> <span class="st">&quot; \\\\&quot;</span>) <span class="fu">.</span> intercalate <span class="st">&quot; &amp; &quot;</span>)</a>
<a class="sourceLine" id="cb4-131" data-line-number="131">              [ map g&#39;</a>
<a class="sourceLine" id="cb4-132" data-line-number="132">                [ ( (finite <span class="fu">.</span> fromIntegral) r&#39;</a>
<a class="sourceLine" id="cb4-133" data-line-number="133">                  , (finite <span class="fu">.</span> fromIntegral) c</a>
<a class="sourceLine" id="cb4-134" data-line-number="134">                  )</a>
<a class="sourceLine" id="cb4-135" data-line-number="135">                <span class="fu">|</span> c <span class="ot">&lt;-</span> [<span class="dv">0</span><span class="fu">..</span>(gNumCols <span class="fu">-</span> <span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb4-136" data-line-number="136">                ]</a>
<a class="sourceLine" id="cb4-137" data-line-number="137">              <span class="fu">|</span> r <span class="ot">&lt;-</span> [<span class="dv">0</span><span class="fu">..</span>(gNumRows <span class="fu">-</span> <span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb4-138" data-line-number="138">              , <span class="kw">let</span> r&#39; <span class="fu">=</span> gNumRows <span class="fu">-</span> <span class="dv">1</span> <span class="fu">-</span> r</a>
<a class="sourceLine" id="cb4-139" data-line-number="139">              ]</a>
<a class="sourceLine" id="cb4-140" data-line-number="140">        )</a>
<a class="sourceLine" id="cb4-141" data-line-number="141">      <span class="fu">++</span> [<span class="st">&quot;\\hline&quot;</span>]</a>
<a class="sourceLine" id="cb4-142" data-line-number="142">      <span class="fu">++</span> [<span class="st">&quot;\\end{array}&quot;</span>]</a>
<a class="sourceLine" id="cb4-143" data-line-number="143">    )</a>
<a class="sourceLine" id="cb4-144" data-line-number="144">  )</a>
<a class="sourceLine" id="cb4-145" data-line-number="145">  <span class="kw">where</span> g&#39; s</a>
<a class="sourceLine" id="cb4-146" data-line-number="146">          <span class="fu">|</span> s <span class="ot">`elem`</span> initStates <span class="fu">=</span> <span class="st">&quot;S&quot;</span></a>
<a class="sourceLine" id="cb4-147" data-line-number="147">          <span class="fu">|</span> s <span class="ot">`elem`</span> termStates <span class="fu">=</span> <span class="st">&quot;G&quot;</span></a>
<a class="sourceLine" id="cb4-148" data-line-number="148">          <span class="fu">|</span> otherwise <span class="fu">=</span> toString (g s)</a>
<a class="sourceLine" id="cb4-149" data-line-number="149"></a>
<a class="sourceLine" id="cb4-150" data-line-number="150"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb4-151" data-line-number="151"><span class="co">  Command line options defintions.</span></a>
<a class="sourceLine" id="cb4-152" data-line-number="152"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb4-153" data-line-number="153"></a>
<a class="sourceLine" id="cb4-154" data-line-number="154"><span class="kw">data</span> <span class="dt">Opts</span> w <span class="fu">=</span> <span class="dt">Opts</span></a>
<a class="sourceLine" id="cb4-155" data-line-number="155">    {<span class="ot"> nIter ::</span> w <span class="ot">::</span><span class="fu">:</span> <span class="dt">Maybe</span> <span class="dt">Int</span> <span class="fu">&lt;?&gt;</span></a>
<a class="sourceLine" id="cb4-156" data-line-number="156">        <span class="st">&quot;The number of TD episodes&quot;</span></a>
<a class="sourceLine" id="cb4-157" data-line-number="157">    ,<span class="ot"> nEval ::</span> w <span class="ot">::</span><span class="fu">:</span> <span class="dt">Maybe</span> <span class="dt">Int</span> <span class="fu">&lt;?&gt;</span></a>
<a class="sourceLine" id="cb4-158" data-line-number="158">        <span class="st">&quot;The maximum number of state transitions allowed in each episode&quot;</span></a>
<a class="sourceLine" id="cb4-159" data-line-number="159">    ,<span class="ot"> nStep ::</span> w <span class="ot">::</span><span class="fu">:</span> <span class="dt">Maybe</span> <span class="dt">Int</span> <span class="fu">&lt;?&gt;</span></a>
<a class="sourceLine" id="cb4-160" data-line-number="160">        <span class="st">&quot;The &#39;n&#39; in n-step TD.&quot;</span></a>
<a class="sourceLine" id="cb4-161" data-line-number="161">    ,<span class="ot"> eps   ::</span> w <span class="ot">::</span><span class="fu">:</span> <span class="dt">Maybe</span> <span class="dt">Double</span> <span class="fu">&lt;?&gt;</span></a>
<a class="sourceLine" id="cb4-162" data-line-number="162">        <span class="st">&quot;Probability of chosing action randomly&quot;</span></a>
<a class="sourceLine" id="cb4-163" data-line-number="163">    ,<span class="ot"> dcy   ::</span> w <span class="ot">::</span><span class="fu">:</span> <span class="dt">Maybe</span> <span class="dt">Double</span> <span class="fu">&lt;?&gt;</span></a>
<a class="sourceLine" id="cb4-164" data-line-number="164">        <span class="st">&quot;The decay rate for epsilon/alpha&quot;</span></a>
<a class="sourceLine" id="cb4-165" data-line-number="165">    }</a>
<a class="sourceLine" id="cb4-166" data-line-number="166">    <span class="kw">deriving</span> (<span class="dt">Generic</span>)</a>
<a class="sourceLine" id="cb4-167" data-line-number="167"></a>
<a class="sourceLine" id="cb4-168" data-line-number="168"><span class="kw">instance</span> <span class="dt">ParseRecord</span> (<span class="dt">Opts</span> <span class="dt">Wrapped</span>)</a>
<a class="sourceLine" id="cb4-169" data-line-number="169"></a>
<a class="sourceLine" id="cb4-170" data-line-number="170"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb4-171" data-line-number="171"><span class="co">  main()</span></a>
<a class="sourceLine" id="cb4-172" data-line-number="172"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb4-173" data-line-number="173"></a>
<a class="sourceLine" id="cb4-174" data-line-number="174">mdFilename <span class="fu">=</span> <span class="st">&quot;other/windygrid.md&quot;</span></a>
<a class="sourceLine" id="cb4-175" data-line-number="175"></a>
<a class="sourceLine" id="cb4-176" data-line-number="176"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb4-177" data-line-number="177">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-178" data-line-number="178">  <span class="co">-- Process command line options.</span></a>
<a class="sourceLine" id="cb4-179" data-line-number="179"><span class="ot">  o ::</span> <span class="dt">Opts</span> <span class="dt">Unwrapped</span> <span class="ot">&lt;-</span></a>
<a class="sourceLine" id="cb4-180" data-line-number="180">    unwrapRecord <span class="st">&quot;A solution to Example 6.5 - Windy Gridworld.&quot;</span></a>
<a class="sourceLine" id="cb4-181" data-line-number="181">  <span class="kw">let</span> nIters <span class="fu">=</span> fromMaybe  <span class="dv">10000</span> (nIter o)</a>
<a class="sourceLine" id="cb4-182" data-line-number="182">      nEvals <span class="fu">=</span> fromMaybe     <span class="dv">20</span> (nEval o)</a>
<a class="sourceLine" id="cb4-183" data-line-number="183">      nSteps&#39; <span class="fu">=</span> fromMaybe     <span class="dv">0</span> (nStep o)</a>
<a class="sourceLine" id="cb4-184" data-line-number="184">      eps&#39;   <span class="fu">=</span> fromMaybe    <span class="fl">0.1</span> (eps   o)</a>
<a class="sourceLine" id="cb4-185" data-line-number="185">      beta&#39;  <span class="fu">=</span> fromMaybe    <span class="dv">0</span>   (dcy   o)</a>
<a class="sourceLine" id="cb4-186" data-line-number="186"></a>
<a class="sourceLine" id="cb4-187" data-line-number="187">  <span class="co">-- Calculate and display optimum policy.</span></a>
<a class="sourceLine" id="cb4-188" data-line-number="188">  writeFile mdFilename <span class="st">&quot;\n### DP Results\n\n&quot;</span></a>
<a class="sourceLine" id="cb4-189" data-line-number="189"></a>
<a class="sourceLine" id="cb4-190" data-line-number="190">  <span class="co">-- Run DP, to generate reference values.</span></a>
<a class="sourceLine" id="cb4-191" data-line-number="191">  <span class="kw">let</span> (fs, counts&#39;) <span class="fu">=</span> P.unzip <span class="fu">$</span> take <span class="dv">20</span></a>
<a class="sourceLine" id="cb4-192" data-line-number="192">                   <span class="fu">$</span> iterate</a>
<a class="sourceLine" id="cb4-193" data-line-number="193">                       ( optPol</a>
<a class="sourceLine" id="cb4-194" data-line-number="194">                           hypParamsDef</a>
<a class="sourceLine" id="cb4-195" data-line-number="195">                             { disc       <span class="fu">=</span> gGamma</a>
<a class="sourceLine" id="cb4-196" data-line-number="196">                             , epsilon    <span class="fu">=</span> <span class="fl">0.1</span></a>
<a class="sourceLine" id="cb4-197" data-line-number="197">                             , maxIter    <span class="fu">=</span> <span class="dv">20</span></a>
<a class="sourceLine" id="cb4-198" data-line-number="198">                             }</a>
<a class="sourceLine" id="cb4-199" data-line-number="199">                       ) (const (<span class="dt">Rt</span>, <span class="dv">0</span>), [])</a>
<a class="sourceLine" id="cb4-200" data-line-number="200">      counts <span class="fu">=</span> P.tail counts&#39;</a>
<a class="sourceLine" id="cb4-201" data-line-number="201">      acts   <span class="fu">=</span> map (\f <span class="ot">-&gt;</span> map (fst <span class="fu">.</span> f) states) fs</a>
<a class="sourceLine" id="cb4-202" data-line-number="202">      diffs  <span class="fu">=</span> map (map boolToDouble <span class="fu">.</span> uncurry (zipWith (<span class="fu">/=</span>)))</a>
<a class="sourceLine" id="cb4-203" data-line-number="203">                  <span class="fu">$</span> zip acts (P.tail acts)</a>
<a class="sourceLine" id="cb4-204" data-line-number="204"><span class="ot">      g&#39; ::</span> <span class="dt">MyState</span> <span class="ot">-&gt;</span> (<span class="dt">MyAction</span>, <span class="dt">Double</span>)</a>
<a class="sourceLine" id="cb4-205" data-line-number="205">      ((_, g&#39;), cnts&#39;) <span class="fu">=</span> first (fromMaybe (P.error <span class="st">&quot;main: Major failure!&quot;</span>)) <span class="fu">$</span></a>
<a class="sourceLine" id="cb4-206" data-line-number="206">        runWriter <span class="fu">$</span> withinOnM <span class="dv">0</span>  <span class="co">-- Temporary, to force `nIters` policy improvements.</span></a>
<a class="sourceLine" id="cb4-207" data-line-number="207">                              ( \ (dv, _) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb4-208" data-line-number="208">                                  maxAndNonZero dv</a>
<a class="sourceLine" id="cb4-209" data-line-number="209">                              ) <span class="fu">$</span> zip diffs (P.tail fs)</a>
<a class="sourceLine" id="cb4-210" data-line-number="210">      pol    <span class="fu">=</span> fst <span class="fu">.</span> g&#39;</a>
<a class="sourceLine" id="cb4-211" data-line-number="211">      val    <span class="fu">=</span> snd <span class="fu">.</span> g&#39;</a>
<a class="sourceLine" id="cb4-212" data-line-number="212">      cnts   <span class="fu">=</span> cnts&#39;</a>
<a class="sourceLine" id="cb4-213" data-line-number="213">      visits <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-214" data-line-number="214">        runEpisode <span class="dv">20</span> pol (((<span class="fu">.</span>) <span class="fu">.</span> (<span class="fu">.</span>)) (P.head <span class="fu">.</span> map fst) nextStates)</a>
<a class="sourceLine" id="cb4-215" data-line-number="215">          termStates <span class="fu">$</span> P.head initStates</a>
<a class="sourceLine" id="cb4-216" data-line-number="216"></a>
<a class="sourceLine" id="cb4-217" data-line-number="217">  appendFile mdFilename <span class="st">&quot;\n#### Final policy\n\n&quot;</span></a>
<a class="sourceLine" id="cb4-218" data-line-number="218">  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> showFofState pol</a>
<a class="sourceLine" id="cb4-219" data-line-number="219">  appendFile mdFilename <span class="st">&quot;\n#### Final value function\n\n&quot;</span></a>
<a class="sourceLine" id="cb4-220" data-line-number="220">  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> showFofState (<span class="dt">Pdouble</span> <span class="fu">.</span> val)</a>
<a class="sourceLine" id="cb4-221" data-line-number="221">  appendFile mdFilename <span class="st">&quot;\n#### Trajectory of final policy\n\n&quot;</span></a>
<a class="sourceLine" id="cb4-222" data-line-number="222">  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> showFofState <span class="fu">$</span> \s <span class="ot">-&gt;</span> <span class="kw">if</span> s <span class="ot">`elem`</span> visits</a>
<a class="sourceLine" id="cb4-223" data-line-number="223">                                                        <span class="kw">then</span> (<span class="st">&quot; \\cdot &quot;</span><span class="ot"> ::</span> <span class="dt">String</span>)</a>
<a class="sourceLine" id="cb4-224" data-line-number="224">                                                        <span class="kw">else</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb4-225" data-line-number="225">  <span class="co">-- Value/Action changes vs. Iteration</span></a>
<a class="sourceLine" id="cb4-226" data-line-number="226">  appendFile mdFilename <span class="st">&quot;\n#### Policy/Value Function Changes vs. Iteration\n\n&quot;</span></a>
<a class="sourceLine" id="cb4-227" data-line-number="227">  toFile def <span class="st">&quot;img/valueDiffs.png&quot;</span> <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-228" data-line-number="228">    layout_title <span class="fu">.=</span> <span class="st">&quot;Policy/Value Function Changes vs. Iteration&quot;</span></a>
<a class="sourceLine" id="cb4-229" data-line-number="229">    setColors <span class="fu">$</span> map opaque [blue, green, red, yellow, cyan, magenta, brown, gray, purple, black]</a>
<a class="sourceLine" id="cb4-230" data-line-number="230">    plot ( line <span class="st">&quot;Policy Changes&quot;</span></a>
<a class="sourceLine" id="cb4-231" data-line-number="231">                [ [ (x,y)</a>
<a class="sourceLine" id="cb4-232" data-line-number="232">                  <span class="fu">|</span> (x,y) <span class="ot">&lt;-</span> zip (map (<span class="fu">*</span> (length <span class="fu">$</span> P.head counts)) [(<span class="dv">0</span><span class="ot">::</span><span class="dt">Int</span>)<span class="fu">..</span>])</a>
<a class="sourceLine" id="cb4-233" data-line-number="233">                                 cnts</a>
<a class="sourceLine" id="cb4-234" data-line-number="234">                  ]</a>
<a class="sourceLine" id="cb4-235" data-line-number="235">                ]</a>
<a class="sourceLine" id="cb4-236" data-line-number="236">         )</a>
<a class="sourceLine" id="cb4-237" data-line-number="237">    plot ( line <span class="st">&quot;Value Changes&quot;</span></a>
<a class="sourceLine" id="cb4-238" data-line-number="238">                [ [ (x,y)</a>
<a class="sourceLine" id="cb4-239" data-line-number="239">                  <span class="fu">|</span> (x,y) <span class="ot">&lt;-</span> zip [(<span class="dv">0</span><span class="ot">::</span><span class="dt">Int</span>)<span class="fu">..</span>]</a>
<a class="sourceLine" id="cb4-240" data-line-number="240">                                 (concat counts)</a>
<a class="sourceLine" id="cb4-241" data-line-number="241">                  ]</a>
<a class="sourceLine" id="cb4-242" data-line-number="242">                ]</a>
<a class="sourceLine" id="cb4-243" data-line-number="243">         )</a>
<a class="sourceLine" id="cb4-244" data-line-number="244">  appendFile mdFilename <span class="st">&quot;\n![](img/valueDiffs.png)\n&quot;</span></a>
<a class="sourceLine" id="cb4-245" data-line-number="245"></a>
<a class="sourceLine" id="cb4-246" data-line-number="246">  <span class="co">-- Run all 3 flavors of TD, comparing results to DP.</span></a>
<a class="sourceLine" id="cb4-247" data-line-number="247">  appendFile mdFilename <span class="st">&quot;\n### TD Results\n\n&quot;</span></a>
<a class="sourceLine" id="cb4-248" data-line-number="248"></a>
<a class="sourceLine" id="cb4-249" data-line-number="249">  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> printf <span class="st">&quot;epsilon = %4.2f  \n&quot;</span> eps&#39;</a>
<a class="sourceLine" id="cb4-250" data-line-number="250">  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> printf <span class="st">&quot;beta = %8.6f  \n&quot;</span> beta&#39;</a>
<a class="sourceLine" id="cb4-251" data-line-number="251"></a>
<a class="sourceLine" id="cb4-252" data-line-number="252">  <span class="co">-- let r :: ( [[[Double]]]</span></a>
<a class="sourceLine" id="cb4-253" data-line-number="253">  <span class="co">--          , [[TDRetT MyState MyAction Double (Card MyState) (Card (ActionT MyState))]]</span></a>
<a class="sourceLine" id="cb4-254" data-line-number="254">  <span class="co">--          )</span></a>
<a class="sourceLine" id="cb4-255" data-line-number="255">  <span class="kw">let</span> (erss, resss) <span class="fu">=</span> unzip <span class="fu">$</span> for [<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.5</span>] <span class="fu">$</span> \ alp <span class="ot">-&gt;</span>        </a>
<a class="sourceLine" id="cb4-256" data-line-number="256">        <span class="kw">let</span> myHypParams <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-257" data-line-number="257">              hypParamsDef</a>
<a class="sourceLine" id="cb4-258" data-line-number="258">                { disc       <span class="fu">=</span> gGamma</a>
<a class="sourceLine" id="cb4-259" data-line-number="259">                , epsilon    <span class="fu">=</span> eps&#39;</a>
<a class="sourceLine" id="cb4-260" data-line-number="260">                , alpha      <span class="fu">=</span> alp</a>
<a class="sourceLine" id="cb4-261" data-line-number="261">                , beta       <span class="fu">=</span> beta&#39;</a>
<a class="sourceLine" id="cb4-262" data-line-number="262">                , maxIter    <span class="fu">=</span> nEvals</a>
<a class="sourceLine" id="cb4-263" data-line-number="263">                , tdStepType <span class="fu">=</span> <span class="dt">Qlearn</span></a>
<a class="sourceLine" id="cb4-264" data-line-number="264">                , nSteps     <span class="fu">=</span> nSteps&#39;</a>
<a class="sourceLine" id="cb4-265" data-line-number="265">                }</a>
<a class="sourceLine" id="cb4-266" data-line-number="266">            <span class="co">-- ress :: [TDRetT MyState MyAction Double (Card MyState) (Card (ActionT MyState))]</span></a>
<a class="sourceLine" id="cb4-267" data-line-number="267">            ress <span class="fu">=</span> for [<span class="dt">Sarsa</span>, <span class="dt">Qlearn</span>, <span class="dt">ExpSarsa</span>] <span class="fu">$</span></a>
<a class="sourceLine" id="cb4-268" data-line-number="268">                       \ stepT <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb4-269" data-line-number="269">                         doTD myHypParams{tdStepType <span class="fu">=</span> stepT} nIters</a>
<a class="sourceLine" id="cb4-270" data-line-number="270">            vss  <span class="fu">=</span> map valFuncs ress</a>
<a class="sourceLine" id="cb4-271" data-line-number="271">            ers  <span class="fu">=</span> map ( map ( \ v <span class="ot">-&gt;</span> (<span class="fu">/</span> dpNorm) <span class="fu">.</span> mean <span class="fu">$</span></a>
<a class="sourceLine" id="cb4-272" data-line-number="272">                                        [ sqr (v s <span class="fu">-</span> val s)</a>
<a class="sourceLine" id="cb4-273" data-line-number="273">                                        <span class="fu">|</span> s <span class="ot">&lt;-</span> states</a>
<a class="sourceLine" id="cb4-274" data-line-number="274">                                        ]</a>
<a class="sourceLine" id="cb4-275" data-line-number="275">                             )</a>
<a class="sourceLine" id="cb4-276" data-line-number="276">                       ) vss</a>
<a class="sourceLine" id="cb4-277" data-line-number="277">            <span class="co">-- dbgss = map debugs ress</span></a>
<a class="sourceLine" id="cb4-278" data-line-number="278">         <span class="kw">in</span> (ers, ress)</a>
<a class="sourceLine" id="cb4-279" data-line-number="279">      dpNorm <span class="fu">=</span> mean [ sqr (val s)</a>
<a class="sourceLine" id="cb4-280" data-line-number="280">                    <span class="fu">|</span> s <span class="ot">&lt;-</span> states</a>
<a class="sourceLine" id="cb4-281" data-line-number="281">                    ]</a>
<a class="sourceLine" id="cb4-282" data-line-number="282"></a>
<a class="sourceLine" id="cb4-283" data-line-number="283">  <span class="co">-- Value function error vs. Iteration</span></a>
<a class="sourceLine" id="cb4-284" data-line-number="284">  appendFile mdFilename <span class="st">&quot;\n#### Mean Square Value Function Error vs. DP\n\n&quot;</span></a>
<a class="sourceLine" id="cb4-285" data-line-number="285">  toFile def <span class="st">&quot;img/vFuncErr.png&quot;</span> <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-286" data-line-number="286">    layout_title <span class="fu">.=</span> <span class="st">&quot;Mean Square Value Function Error vs. Iteration&quot;</span></a>
<a class="sourceLine" id="cb4-287" data-line-number="287">    forM_ (zip (P.init erss) [<span class="dt">PointShapeCircle</span>, <span class="dt">PointShapePlus</span>]) <span class="fu">$</span> \ (ers, ptShape) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-288" data-line-number="288">      setColors <span class="fu">$</span> map opaque [blue, green, red]</a>
<a class="sourceLine" id="cb4-289" data-line-number="289">      setShapes [ptShape]</a>
<a class="sourceLine" id="cb4-290" data-line-number="290">      forM_ (zip [<span class="st">&quot;Sarsa&quot;</span>, <span class="st">&quot;Qlearn&quot;</span>, <span class="st">&quot;ExpSarsa&quot;</span>] ers) <span class="fu">$</span> \ (lbl, er) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb4-291" data-line-number="291">           plot ( points lbl</a>
<a class="sourceLine" id="cb4-292" data-line-number="292">                         [ (x,y)</a>
<a class="sourceLine" id="cb4-293" data-line-number="293">                         <span class="fu">|</span> (x,y) <span class="ot">&lt;-</span> takeEvery (nIters <span class="ot">`div`</span> <span class="dv">100</span>) <span class="fu">$</span> zip [(<span class="dv">0</span><span class="ot">::</span><span class="dt">Int</span>)<span class="fu">..</span>] er</a>
<a class="sourceLine" id="cb4-294" data-line-number="294">                         ]</a>
<a class="sourceLine" id="cb4-295" data-line-number="295">                )</a>
<a class="sourceLine" id="cb4-296" data-line-number="296">    forM_ (zip [<span class="st">&quot;Sarsa&quot;</span>, <span class="st">&quot;Qlearn&quot;</span>, <span class="st">&quot;ExpSarsa&quot;</span>] (P.last erss)) <span class="fu">$</span> \ (lbl, er) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb4-297" data-line-number="297">         plot ( line lbl</a>
<a class="sourceLine" id="cb4-298" data-line-number="298">                       [[ (x,y)</a>
<a class="sourceLine" id="cb4-299" data-line-number="299">                        <span class="fu">|</span> (x,y) <span class="ot">&lt;-</span> zip [(<span class="dv">0</span><span class="ot">::</span><span class="dt">Int</span>)<span class="fu">..</span>] er</a>
<a class="sourceLine" id="cb4-300" data-line-number="300">                       ]]</a>
<a class="sourceLine" id="cb4-301" data-line-number="301">              )</a>
<a class="sourceLine" id="cb4-302" data-line-number="302">  appendFile mdFilename <span class="st">&quot;\n![](img/vFuncErr.png)  \n&quot;</span></a>
<a class="sourceLine" id="cb4-303" data-line-number="303">  appendFile mdFilename <span class="st">&quot;circle: alpha=0.1  \n&quot;</span></a>
<a class="sourceLine" id="cb4-304" data-line-number="304">  appendFile mdFilename <span class="st">&quot;plus: alpha=0.2  \n&quot;</span></a>
<a class="sourceLine" id="cb4-305" data-line-number="305">  appendFile mdFilename <span class="st">&quot;line: alpha=0.5  \n&quot;</span></a>
<a class="sourceLine" id="cb4-306" data-line-number="306"></a>
<a class="sourceLine" id="cb4-307" data-line-number="307">  <span class="co">-- DEBUGGING</span></a>
<a class="sourceLine" id="cb4-308" data-line-number="308">  <span class="co">-- print $ map (rwd . P.head) . P.last . P.last $ dbgssss</span></a>
<a class="sourceLine" id="cb4-309" data-line-number="309">  <span class="co">-- print $ map (rwd . P.last) . P.last . P.last $ dbgssss</span></a>
<a class="sourceLine" id="cb4-310" data-line-number="310"></a>
<a class="sourceLine" id="cb4-311" data-line-number="311">  appendFile mdFilename <span class="st">&quot;\n## debug\n\n&quot;</span></a>
<a class="sourceLine" id="cb4-312" data-line-number="312"></a>
<a class="sourceLine" id="cb4-313" data-line-number="313">  appendFile mdFilename <span class="st">&quot;\n#### State Visits\n\n&quot;</span></a>
<a class="sourceLine" id="cb4-314" data-line-number="314">  <span class="kw">let</span> qM <span class="fu">=</span> P.last <span class="fu">$</span> qMats <span class="fu">$</span> P.last <span class="fu">$</span> P.last resss</a>
<a class="sourceLine" id="cb4-315" data-line-number="315">      qS <span class="fu">=</span> VS.map (VS.sum <span class="fu">.</span> VS.map snd) qM</a>
<a class="sourceLine" id="cb4-316" data-line-number="316">      q  <span class="fu">=</span> fromMaybe (P.error <span class="st">&quot;VS.fromList failure!&quot;</span>) <span class="fu">$</span></a>
<a class="sourceLine" id="cb4-317" data-line-number="317">             VS.fromList</a>
<a class="sourceLine" id="cb4-318" data-line-number="318">             [ fromMaybe (P.error <span class="st">&quot;VS.fromList failure!&quot;</span>) <span class="fu">$</span></a>
<a class="sourceLine" id="cb4-319" data-line-number="319">                 VS.fromList</a>
<a class="sourceLine" id="cb4-320" data-line-number="320">                 [ qS <span class="ot">`VS.index`</span> (finite <span class="fu">$</span> fromIntegral (r <span class="fu">*</span> gNumCols <span class="fu">+</span> c))</a>
<a class="sourceLine" id="cb4-321" data-line-number="321">                 <span class="fu">|</span> c <span class="ot">&lt;-</span> [<span class="dv">0</span><span class="fu">..</span>(gNumCols<span class="fu">-</span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb4-322" data-line-number="322">                 ]</a>
<a class="sourceLine" id="cb4-323" data-line-number="323">             <span class="fu">|</span> r <span class="ot">&lt;-</span> [<span class="dv">0</span><span class="fu">..</span>(gNumRows<span class="fu">-</span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb4-324" data-line-number="324">             ]</a>
<a class="sourceLine" id="cb4-325" data-line-number="325">  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> showFofState <span class="fu">$</span> uncurry (appFm q)</a>
<a class="sourceLine" id="cb4-326" data-line-number="326">    <span class="co">-- \ s -&gt; snd $ appFm q s</span></a>
<a class="sourceLine" id="cb4-327" data-line-number="327">    </a>
<a class="sourceLine" id="cb4-328" data-line-number="328"></a>
<a class="sourceLine" id="cb4-329" data-line-number="329"><span class="ot">#if 0</span></a>
<a class="sourceLine" id="cb4-330" data-line-number="330">  <span class="co">-- Terminal states values vs. Iteration</span></a>
<a class="sourceLine" id="cb4-331" data-line-number="331">  appendFile mdFilename <span class="st">&quot;\n#### Terminal States - Values vs. Iteration\n\n&quot;</span></a>
<a class="sourceLine" id="cb4-332" data-line-number="332">  toFile def <span class="st">&quot;img/termVals.png&quot;</span> <span class="fu">$</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-333" data-line-number="333">    layout_title <span class="fu">.=</span> <span class="st">&quot;Terminal States - Values vs. Iteration&quot;</span></a>
<a class="sourceLine" id="cb4-334" data-line-number="334">    forM_ (zip (P.init termValss) [<span class="dt">PointShapeCircle</span>, <span class="dt">PointShapePlus</span>]) <span class="fu">$</span> \ (termVals, ptShape) <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-335" data-line-number="335">      setColors <span class="fu">$</span> map opaque [blue, green, red]</a>
<a class="sourceLine" id="cb4-336" data-line-number="336">      setShapes [ptShape]</a>
<a class="sourceLine" id="cb4-337" data-line-number="337">      forM_ (zip [<span class="st">&quot;Sarsa&quot;</span>, <span class="st">&quot;Qlearn&quot;</span>, <span class="st">&quot;ExpSarsa&quot;</span>] termVals) <span class="fu">$</span> \ (lbl, er) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb4-338" data-line-number="338">           plot ( points lbl</a>
<a class="sourceLine" id="cb4-339" data-line-number="339">                         [ (x,y)</a>
<a class="sourceLine" id="cb4-340" data-line-number="340">                         <span class="fu">|</span> (x,y) <span class="ot">&lt;-</span> takeEvery (nIters <span class="ot">`div`</span> <span class="dv">100</span>) <span class="fu">$</span> zip [(<span class="dv">0</span><span class="ot">::</span><span class="dt">Int</span>)<span class="fu">..</span>] er</a>
<a class="sourceLine" id="cb4-341" data-line-number="341">                         ]</a>
<a class="sourceLine" id="cb4-342" data-line-number="342">                )</a>
<a class="sourceLine" id="cb4-343" data-line-number="343">    forM_ (zip [<span class="st">&quot;Sarsa&quot;</span>, <span class="st">&quot;Qlearn&quot;</span>, <span class="st">&quot;ExpSarsa&quot;</span>] (P.last termValss)) <span class="fu">$</span> \ (lbl, er) <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb4-344" data-line-number="344">         plot ( line lbl</a>
<a class="sourceLine" id="cb4-345" data-line-number="345">                       [[ (x,y)</a>
<a class="sourceLine" id="cb4-346" data-line-number="346">                        <span class="fu">|</span> (x,y) <span class="ot">&lt;-</span> zip [(<span class="dv">0</span><span class="ot">::</span><span class="dt">Int</span>)<span class="fu">..</span>] er</a>
<a class="sourceLine" id="cb4-347" data-line-number="347">                       ]]</a>
<a class="sourceLine" id="cb4-348" data-line-number="348">              )</a>
<a class="sourceLine" id="cb4-349" data-line-number="349">  appendFile mdFilename <span class="st">&quot;\n![](img/termVals.png)  \n&quot;</span></a>
<a class="sourceLine" id="cb4-350" data-line-number="350">  appendFile mdFilename <span class="st">&quot;circle: alpha=0.1  \n&quot;</span></a>
<a class="sourceLine" id="cb4-351" data-line-number="351">  appendFile mdFilename <span class="st">&quot;plus: alpha=0.2  \n&quot;</span></a>
<a class="sourceLine" id="cb4-352" data-line-number="352">  appendFile mdFilename <span class="st">&quot;line: alpha=0.5  \n&quot;</span></a>
<a class="sourceLine" id="cb4-353" data-line-number="353"><span class="ot">#endif</span></a></code></pre></div>
<h2 id="output">output</h2>
<h3 id="dp-results">DP Results</h3>
<h4 id="final-policy">Final policy</h4>
<span class="math display">\[\begin{array}{|c|c|c|c|c|c|c|c|c|c|}
\hline
\downarrow  &amp; \downarrow  &amp; \downarrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \rightarrow  &amp; \rightarrow  &amp; \searrow  &amp; \downarrow  \\
\hline
\downarrow  &amp; \downarrow  &amp; \downarrow  &amp; \swarrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \downarrow  \\
\hline
\searrow  &amp; \downarrow  &amp; \downarrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \swarrow  &amp; \downarrow  \\
\hline
S &amp; \searrow  &amp; \downarrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; G &amp; \swarrow  &amp; \swarrow  \\
\hline
\rightarrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \downarrow  &amp; \swarrow  &amp; \leftarrow  \\
\hline
\rightarrow  &amp; \rightarrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \downarrow  &amp; \leftarrow  &amp; \leftarrow  \\
\hline
\rightarrow  &amp; \rightarrow  &amp; \rightarrow  &amp; \searrow  &amp; \searrow  &amp; \searrow  &amp; \rightarrow  &amp; \cdot  &amp; \nwarrow  &amp; \leftarrow  \\
\hline
\end{array}\]</span>
<h4 id="final-value-function">Final value function</h4>
<span class="math display">\[\begin{array}{|c|c|c|c|c|c|c|c|c|c|}
\hline
-12.5 &amp; -12.5 &amp; -12.5 &amp; -13.1 &amp; -12.2 &amp; -11.3 &amp; -10.3 &amp; -9.3 &amp; -8.3 &amp; -7.6 \\
\hline
-11.5 &amp; -11.5 &amp; -11.5 &amp; -12.5 &amp; -11.8 &amp; -11.1 &amp; -10.2 &amp; -9.1 &amp; -7.6 &amp; -6.6 \\
\hline
-10.5 &amp; -10.5 &amp; -10.5 &amp; -11.5 &amp; -10.7 &amp; -9.9 &amp; -9.9 &amp; -8.5 &amp; -6.5 &amp; -5.6 \\
\hline
S &amp; -9.5 &amp; -9.5 &amp; -10.1 &amp; -9.1 &amp; -8.2 &amp; -6.5 &amp; G &amp; -5.2 &amp; -4.6 \\
\hline
-10.0 &amp; -9.0 &amp; -8.5 &amp; -8.6 &amp; -7.5 &amp; -6.1 &amp; -5.2 &amp; -5.2 &amp; -3.6 &amp; -4.6 \\
\hline
-10.0 &amp; -9.0 &amp; -8.0 &amp; -7.5 &amp; -6.3 &amp; -5.2 &amp; -3.6 &amp; -3.6 &amp; -3.6 &amp; -4.6 \\
\hline
-10.0 &amp; -9.0 &amp; -8.0 &amp; -7.0 &amp; -5.8 &amp; -4.6 &amp; -3.6 &amp; -3.6 &amp; -3.6 &amp; -4.6 \\
\hline
\end{array}\]</span>
<h4 id="trajectory-of-final-policy">Trajectory of final policy</h4>
<span class="math display">\[\begin{array}{|c|c|c|c|c|c|c|c|c|c|}
\hline
 &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  \\
\hline
 &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  \\
\hline
 &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  \\
\hline
S &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp; G &amp;  &amp;  \\
\hline
 &amp;  \cdot  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  &amp;  \\
\hline
 &amp;  &amp;  \cdot  &amp;  &amp;  &amp;  &amp;  &amp;  \cdot  &amp;  &amp;  \\
\hline
 &amp;  &amp;  &amp;  \cdot  &amp;  \cdot  &amp;  \cdot  &amp;  \cdot  &amp;  &amp;  &amp;  \\
\hline
\end{array}\]</span>
<h4 id="policyvalue-function-changes-vs.-iteration">Policy/Value Function Changes vs. Iteration</h4>
<figure>
<img src="img/valueDiffs.png" />
</figure>
<h3 id="td-results">TD Results</h3>
<p>epsilon = 0.10<br />
beta = 0.000050</p>
<h4 id="mean-square-value-function-error-vs.-dp">Mean Square Value Function Error vs. DP</h4>
<p><img src="img/vFuncErr.png" /><br />
circle: alpha=0.1<br />
plus: alpha=0.2<br />
line: alpha=0.5</p>
<h2 id="debug">debug</h2>
<h4 id="state-visits">State Visits</h4>
<span class="math display">\[\begin{array}{|c|c|c|c|c|c|c|c|c|c|}
\hline
160847 &amp; 7417 &amp; 405 &amp; 30 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\hline
10469 &amp; 404 &amp; 25 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\hline
10039 &amp; 116 &amp; 5 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\hline
S &amp; 58 &amp; 4 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; G &amp; 0 &amp; 0 \\
\hline
49 &amp; 23 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\hline
2 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\hline
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\hline
\end{array}\]</span>
<hr />
<div class="footer">
<p>Powered by <a href="https://haskell-lang.org/">haskell</a>, <a href="https://docs.haskellstack.org/en/stable/README/">stack</a> and <a href="http://pandoc.org/">pandoc</a>.</p>
</div>

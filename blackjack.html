<meta charset="utf-8"> <link rel="stylesheet" href="other/lhs.css">
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<h1 id="haskell-rl-blackjack-problem-example-5.3">haskell-rl : Blackjack Problem (Example 5.3)</h1>
<p>This <a href="https://wiki.haskell.org/Literate_programming">literate Haskell</a> document provides a solution to Example 5.3 in <em>Reinforcement Learning</em> by Sutton &amp; Barto.</p>
<p>Original author: <a href="mailto:David.Banas@target.com">David Banas</a><br />
Original date: May 17, 2018</p>
<p>Copyright Â© 2018 Target Corp.; all rights reserved World wide.</p>
<h2 id="contents">Contents</h2>
<ul class="incremental">
<li><a href="#code">Code</a></li>
<li><a href="#output">Output</a></li>
</ul>
<h2 id="code">code</h2>
<h2 id="ghc-options"><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/flags.html#flag-reference">ghc options</a></h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="ot">{-# OPTIONS_GHC -Wall #-}</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="ot">{-# OPTIONS_GHC -fno-warn-type-defaults #-}</span></a></code></pre></div>
<h2 id="pragmas"><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/lang.html">pragmas</a></h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">-- doctest doesn&#39;t look at the cabal file, so you need pragmas here</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="ot">{-# LANGUAGE NoImplicitPrelude #-}</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="ot">{-# LANGUAGE DataKinds #-}</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="ot">{-# LANGUAGE DeriveGeneric #-}</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="ot">{-# LANGUAGE FlexibleContexts #-}</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="ot">{-# LANGUAGE RecordWildCards #-}</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="ot">{-# LANGUAGE ScopedTypeVariables #-}</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="ot">{-# LANGUAGE TypeOperators #-}</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="ot">{-# LANGUAGE TypeFamilies #-}</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="ot">{-# LANGUAGE FlexibleInstances #-}</span></a></code></pre></div>
<h2 id="libraries"><a href="https://www.stackage.org/">libraries</a></h2>
<ul class="incremental">
<li><a href="https://www.stackage.org/package/protolude">protolude</a></li>
<li><a href="https://www.stackage.org/package/optparse-generic">optparse-generic</a></li>
<li><a href="https://www.stackage.org/package/vector-sized">vector-sized</a></li>
<li><a href="https://www.stackage.org/package/finite-typelits">finite-typelits</a></li>
<li><a href="https://www.stackage.org/package/Chart">Chart</a></li>
<li><a href="https://www.stackage.org/package/Chart-cairo">Chart-cairo</a></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Prelude</span> <span class="kw">as</span> <span class="dt">P</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">import</span> <span class="dt">Prelude</span> (unlines, <span class="dt">Show</span>(..), <span class="dt">String</span>, error, (!!))</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">import</span> <span class="dt">Protolude</span>  <span class="kw">hiding</span> (show, for)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">import</span> <span class="dt">Options.Generic</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Vector.Sized</span> <span class="kw">as</span> <span class="dt">VS</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="kw">import</span> <span class="dt">Control.Arrow</span>          ((&amp;&amp;&amp;), (***))</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="kw">import</span> <span class="dt">Control.Monad.Writer</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Data.Vector.Sized</span>      (<span class="dt">Vector</span>, (//), index)</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="kw">import</span> <span class="dt">Data.Finite</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="kw">import</span> <span class="dt">Data.Text</span>              (pack)</a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="kw">import</span> <span class="dt">System.Random.Shuffle</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="kw">import</span> <span class="dt">Text.Printf</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="kw">import</span> <span class="dt">Useful.IO</span>              (rand)</a></code></pre></div>
<h2 id="code-1">code</h2>
<ul class="incremental">
<li><a href="https://www.stackage.org/package/hoogle">hoogle</a></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">  Problem specific definitions</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="kw">data</span> <span class="dt">BJState</span> <span class="fu">=</span> <span class="dt">BJState</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">  {<span class="ot"> playerSum  ::</span> <span class="dt">Int</span>   <span class="co">-- 12 - 21</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">  ,<span class="ot"> usableAce  ::</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">  ,<span class="ot"> dealerCard ::</span> <span class="dt">Int</span>   <span class="co">-- 1 - 10</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">  ,<span class="ot"> dealerSum  ::</span> <span class="dt">Int</span>   <span class="co">-- For debugging only; not used for learning.</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">  ,<span class="ot"> polHit     ::</span> <span class="dt">Bool</span>  <span class="co">-- For debugging only; not used for learning.</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">  ,<span class="ot"> didHit     ::</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">  } <span class="kw">deriving</span> (<span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb4-14" data-line-number="14"></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="ot">stateDef ::</span> <span class="dt">BJState</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">stateDef <span class="fu">=</span> <span class="dt">BJState</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17">  { playerSum  <span class="fu">=</span> <span class="dv">12</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18">  , usableAce  <span class="fu">=</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19">  , dealerCard <span class="fu">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20">  , dealerSum  <span class="fu">=</span> <span class="dv">12</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21">  , polHit     <span class="fu">=</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22">  , didHit     <span class="fu">=</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23">  }</a>
<a class="sourceLine" id="cb4-24" data-line-number="24"></a>
<a class="sourceLine" id="cb4-25" data-line-number="25"><span class="kw">newtype</span> <span class="dt">BJAction</span> <span class="fu">=</span> <span class="dt">BJAction</span> {<span class="ot"> act ::</span> <span class="dt">Bool</span> }  <span class="co">-- Hit?</span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26"></a>
<a class="sourceLine" id="cb4-27" data-line-number="27"><span class="kw">instance</span> <span class="dt">Show</span> <span class="dt">BJAction</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-28" data-line-number="28">  show (<span class="dt">BJAction</span> x) <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-29" data-line-number="29">    <span class="kw">if</span> x <span class="kw">then</span> <span class="st">&quot;H&quot;</span></a>
<a class="sourceLine" id="cb4-30" data-line-number="30">         <span class="kw">else</span> <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb4-31" data-line-number="31"></a>
<a class="sourceLine" id="cb4-32" data-line-number="32"><span class="ot">allActs ::</span> [<span class="dt">BJAction</span>]</a>
<a class="sourceLine" id="cb4-33" data-line-number="33">allActs <span class="fu">=</span> map <span class="dt">BJAction</span> [<span class="dt">False</span>, <span class="dt">True</span>]</a>
<a class="sourceLine" id="cb4-34" data-line-number="34"></a>
<a class="sourceLine" id="cb4-35" data-line-number="35"><span class="kw">type</span> <span class="dt">BJPolicy</span> <span class="fu">=</span> <span class="dt">BJState</span> <span class="ot">-&gt;</span> <span class="dt">BJAction</span></a>
<a class="sourceLine" id="cb4-36" data-line-number="36"></a>
<a class="sourceLine" id="cb4-37" data-line-number="37"><span class="ot">appPolV ::</span> <span class="dt">Vector</span> <span class="dv">200</span> <span class="dt">BJAction</span> <span class="ot">-&gt;</span> <span class="dt">BJPolicy</span></a>
<a class="sourceLine" id="cb4-38" data-line-number="38">appPolV v <span class="fu">=</span> \s <span class="ot">-&gt;</span> v <span class="ot">`index`</span> enumState s</a>
<a class="sourceLine" id="cb4-39" data-line-number="39"></a>
<a class="sourceLine" id="cb4-40" data-line-number="40"><span class="ot">enumState ::</span> <span class="dt">BJState</span> <span class="ot">-&gt;</span> <span class="dt">Finite</span> <span class="dv">200</span></a>
<a class="sourceLine" id="cb4-41" data-line-number="41">enumState s<span class="fu">@</span><span class="dt">BJState</span>{<span class="fu">..</span>} <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-42" data-line-number="42">  <span class="kw">let</span> offset <span class="fu">=</span> (dealerCard <span class="fu">-</span> <span class="dv">1</span>) <span class="fu">*</span> <span class="dv">10</span> <span class="fu">+</span> playerSum <span class="fu">-</span> <span class="dv">12</span></a>
<a class="sourceLine" id="cb4-43" data-line-number="43">   <span class="kw">in</span> <span class="kw">if</span> offset <span class="fu">&lt;</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-44" data-line-number="44">        <span class="kw">then</span> error (show s)</a>
<a class="sourceLine" id="cb4-45" data-line-number="45">        <span class="kw">else</span> <span class="kw">if</span> usableAce</a>
<a class="sourceLine" id="cb4-46" data-line-number="46">               <span class="kw">then</span> finite <span class="fu">.</span> fromIntegral <span class="fu">$</span> <span class="dv">100</span> <span class="fu">+</span> offset</a>
<a class="sourceLine" id="cb4-47" data-line-number="47">               <span class="kw">else</span> finite <span class="fu">.</span> fromIntegral <span class="fu">$</span> offset</a>
<a class="sourceLine" id="cb4-48" data-line-number="48"></a>
<a class="sourceLine" id="cb4-49" data-line-number="49"><span class="ot">validStates ::</span> [<span class="dt">BJState</span>] <span class="ot">-&gt;</span> [<span class="dt">BJState</span>]</a>
<a class="sourceLine" id="cb4-50" data-line-number="50">validStates <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-51" data-line-number="51">  filter ( \ <span class="dt">BJState</span>{<span class="fu">..</span>} <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb4-52" data-line-number="52">                playerSum  <span class="fu">&gt;=</span> <span class="dv">12</span> <span class="fu">&amp;&amp;</span> playerSum  <span class="fu">&lt;=</span> <span class="dv">21</span></a>
<a class="sourceLine" id="cb4-53" data-line-number="53">             <span class="fu">&amp;&amp;</span> dealerCard <span class="fu">&gt;=</span> <span class="dv">1</span>  <span class="fu">&amp;&amp;</span> dealerCard <span class="fu">&lt;=</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb4-54" data-line-number="54">         )</a>
<a class="sourceLine" id="cb4-55" data-line-number="55"></a>
<a class="sourceLine" id="cb4-56" data-line-number="56"><span class="kw">data</span> <span class="dt">DbgT</span> <span class="fu">=</span> <span class="dt">DbgT</span></a>
<a class="sourceLine" id="cb4-57" data-line-number="57">  {<span class="ot"> upCard ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-58" data-line-number="58">  ,<span class="ot"> states ::</span> [<span class="dt">BJState</span>]</a>
<a class="sourceLine" id="cb4-59" data-line-number="59">  ,<span class="ot"> reward ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-60" data-line-number="60">  }</a>
<a class="sourceLine" id="cb4-61" data-line-number="61"></a>
<a class="sourceLine" id="cb4-62" data-line-number="62"><span class="ot">play ::</span> <span class="dt">BJPolicy</span> <span class="ot">-&gt;</span> [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">BJAction</span> <span class="ot">-&gt;</span> <span class="dt">Writer</span> [<span class="dt">DbgT</span>] (<span class="dt">Int</span>, [<span class="dt">BJState</span>])</a>
<a class="sourceLine" id="cb4-63" data-line-number="63">play pol cards randAct <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-64" data-line-number="64">  <span class="kw">do</span> <span class="kw">let</span> (r, ss) <span class="fu">|</span> pTot <span class="fu">==</span> <span class="dv">21</span> <span class="fu">=</span> <span class="kw">if</span> dTot <span class="fu">==</span> <span class="dv">21</span></a>
<a class="sourceLine" id="cb4-65" data-line-number="65">                                  <span class="kw">then</span> (<span class="dv">0</span>, [])</a>
<a class="sourceLine" id="cb4-66" data-line-number="66">                                  <span class="kw">else</span> (<span class="dv">1</span>, [])</a>
<a class="sourceLine" id="cb4-67" data-line-number="67">                 <span class="fu">|</span> dTot <span class="fu">==</span> <span class="dv">21</span> <span class="fu">=</span> (<span class="fu">-</span><span class="dv">1</span>, [])</a>
<a class="sourceLine" id="cb4-68" data-line-number="68">                 <span class="fu">|</span> otherwise <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-69" data-line-number="69">                   runWriter <span class="fu">$</span> play&#39; pol (drop <span class="dv">4</span> cards) dCards pCards <span class="dt">Init</span> randAct</a>
<a class="sourceLine" id="cb4-70" data-line-number="70">     tell [ <span class="dt">DbgT</span> { upCard <span class="fu">=</span> cards <span class="fu">!!</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb4-71" data-line-number="71">                 , states <span class="fu">=</span> ss</a>
<a class="sourceLine" id="cb4-72" data-line-number="72">                 , reward <span class="fu">=</span> r</a>
<a class="sourceLine" id="cb4-73" data-line-number="73">                 }</a>
<a class="sourceLine" id="cb4-74" data-line-number="74">          ]</a>
<a class="sourceLine" id="cb4-75" data-line-number="75">     return (r, ss)</a>
<a class="sourceLine" id="cb4-76" data-line-number="76">  <span class="kw">where</span> (pTot, _) <span class="fu">=</span> cardSum pCards</a>
<a class="sourceLine" id="cb4-77" data-line-number="77">        (dTot, _) <span class="fu">=</span> cardSum dCards</a>
<a class="sourceLine" id="cb4-78" data-line-number="78">        dCards    <span class="fu">=</span> take <span class="dv">2</span> <span class="fu">$</span> drop <span class="dv">2</span> cards</a>
<a class="sourceLine" id="cb4-79" data-line-number="79">        pCards    <span class="fu">=</span> take <span class="dv">2</span> cards</a>
<a class="sourceLine" id="cb4-80" data-line-number="80"></a>
<a class="sourceLine" id="cb4-81" data-line-number="81"><span class="kw">data</span> <span class="dt">PlayPhase</span> <span class="fu">=</span> <span class="dt">Init</span>    <span class="co">-- Bringing player&#39;s sum &gt; 11.</span></a>
<a class="sourceLine" id="cb4-82" data-line-number="82">               <span class="fu">|</span> <span class="dt">Player</span>  <span class="co">-- Player is hitting/standing.</span></a>
<a class="sourceLine" id="cb4-83" data-line-number="83">               <span class="fu">|</span> <span class="dt">Dealer</span>  <span class="co">-- Dealer is hitting/standing.</span></a>
<a class="sourceLine" id="cb4-84" data-line-number="84"></a>
<a class="sourceLine" id="cb4-85" data-line-number="85"><span class="ot">play&#39; ::</span> <span class="dt">BJPolicy</span>   <span class="co">-- current policy</span></a>
<a class="sourceLine" id="cb4-86" data-line-number="86">      <span class="ot">-&gt;</span> [<span class="dt">Int</span>]      <span class="co">-- remaining deck of cards</span></a>
<a class="sourceLine" id="cb4-87" data-line-number="87">      <span class="ot">-&gt;</span> [<span class="dt">Int</span>]      <span class="co">-- dealer&#39;s cards</span></a>
<a class="sourceLine" id="cb4-88" data-line-number="88">      <span class="ot">-&gt;</span> [<span class="dt">Int</span>]      <span class="co">-- player&#39;s cards</span></a>
<a class="sourceLine" id="cb4-89" data-line-number="89">      <span class="ot">-&gt;</span> <span class="dt">PlayPhase</span>  <span class="co">-- phase of the game</span></a>
<a class="sourceLine" id="cb4-90" data-line-number="90">      <span class="ot">-&gt;</span> <span class="dt">BJAction</span>   <span class="co">-- randomly chosen action to be performed by player at his first free turn</span></a>
<a class="sourceLine" id="cb4-91" data-line-number="91">      <span class="ot">-&gt;</span> <span class="dt">Writer</span> [<span class="dt">BJState</span>] <span class="dt">Int</span></a>
<a class="sourceLine" id="cb4-92" data-line-number="92">play&#39; pol cards dCards pCards phs randAct <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-93" data-line-number="93">  <span class="kw">case</span> phs <span class="kw">of</span></a>
<a class="sourceLine" id="cb4-94" data-line-number="94">    <span class="dt">Init</span> <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb4-95" data-line-number="95">      <span class="kw">if</span> pTot <span class="fu">&gt;</span> <span class="dv">11</span></a>
<a class="sourceLine" id="cb4-96" data-line-number="96">        <span class="kw">then</span> <span class="kw">do</span> tell [s{didHit <span class="fu">=</span> act randAct}]</a>
<a class="sourceLine" id="cb4-97" data-line-number="97">                <span class="kw">if</span> act randAct  <span class="co">-- Is first (randomly chosen) player action &quot;hit&quot;?</span></a>
<a class="sourceLine" id="cb4-98" data-line-number="98">                  <span class="kw">then</span> play&#39; pol (P.tail cards) dCards (P.head cards <span class="fu">:</span> pCards) <span class="dt">Player</span> randAct</a>
<a class="sourceLine" id="cb4-99" data-line-number="99">                  <span class="kw">else</span> play&#39; pol cards dCards pCards <span class="dt">Dealer</span> randAct</a>
<a class="sourceLine" id="cb4-100" data-line-number="100">        <span class="kw">else</span> play&#39; pol (P.tail cards) dCards (P.head cards <span class="fu">:</span> pCards) <span class="dt">Init</span> randAct</a>
<a class="sourceLine" id="cb4-101" data-line-number="101"></a>
<a class="sourceLine" id="cb4-102" data-line-number="102">    <span class="dt">Player</span> <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb4-103" data-line-number="103">      <span class="kw">do</span> tell [s]</a>
<a class="sourceLine" id="cb4-104" data-line-number="104">         <span class="kw">if</span> pTot <span class="fu">&gt;</span> <span class="dv">21</span>        <span class="co">-- Player go bust yet?</span></a>
<a class="sourceLine" id="cb4-105" data-line-number="105">           <span class="kw">then</span> return (<span class="fu">-</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb4-106" data-line-number="106">           <span class="kw">else</span> <span class="kw">if</span> polHit    <span class="co">-- Does policy dictate a hit?</span></a>
<a class="sourceLine" id="cb4-107" data-line-number="107">                  <span class="kw">then</span> play&#39; pol (P.tail cards) dCards (P.head cards <span class="fu">:</span> pCards) <span class="dt">Player</span> randAct</a>
<a class="sourceLine" id="cb4-108" data-line-number="108">                  <span class="kw">else</span> play&#39; pol cards dCards pCards <span class="dt">Dealer</span> randAct</a>
<a class="sourceLine" id="cb4-109" data-line-number="109"></a>
<a class="sourceLine" id="cb4-110" data-line-number="110">    <span class="dt">Dealer</span> <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb4-111" data-line-number="111">      <span class="kw">do</span> tell [s]</a>
<a class="sourceLine" id="cb4-112" data-line-number="112">         <span class="kw">if</span> dTot <span class="fu">&gt;</span> <span class="dv">21</span>        <span class="co">-- Dealer go bust yet?</span></a>
<a class="sourceLine" id="cb4-113" data-line-number="113">           <span class="kw">then</span> return <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-114" data-line-number="114">           <span class="kw">else</span> <span class="kw">if</span> dTot <span class="fu">&lt;</span> <span class="dv">17</span>        <span class="co">-- Must dealer take a hit?</span></a>
<a class="sourceLine" id="cb4-115" data-line-number="115">                  <span class="kw">then</span> play&#39; pol (P.tail cards) (P.head cards <span class="fu">:</span> dCards) pCards <span class="dt">Dealer</span> randAct</a>
<a class="sourceLine" id="cb4-116" data-line-number="116">                  <span class="kw">else</span> <span class="kw">case</span> compare pTot dTot <span class="kw">of</span></a>
<a class="sourceLine" id="cb4-117" data-line-number="117">                         <span class="dt">GT</span> <span class="ot">-&gt;</span> return   <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-118" data-line-number="118">                         <span class="dt">EQ</span> <span class="ot">-&gt;</span> return   <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-119" data-line-number="119">                         _  <span class="ot">-&gt;</span> return (<span class="fu">-</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb4-120" data-line-number="120"></a>
<a class="sourceLine" id="cb4-121" data-line-number="121">  <span class="kw">where</span> (pTot, ace) <span class="fu">=</span> cardSum pCards</a>
<a class="sourceLine" id="cb4-122" data-line-number="122">        (dTot, _)   <span class="fu">=</span> cardSum dCards</a>
<a class="sourceLine" id="cb4-123" data-line-number="123">        s&#39;          <span class="fu">=</span> stateDef</a>
<a class="sourceLine" id="cb4-124" data-line-number="124">                        { playerSum  <span class="fu">=</span> pTot</a>
<a class="sourceLine" id="cb4-125" data-line-number="125">                        , usableAce  <span class="fu">=</span> ace</a>
<a class="sourceLine" id="cb4-126" data-line-number="126">                        , dealerCard <span class="fu">=</span> P.last dCards</a>
<a class="sourceLine" id="cb4-127" data-line-number="127">                        , dealerSum  <span class="fu">=</span> dTot</a>
<a class="sourceLine" id="cb4-128" data-line-number="128">                        }</a>
<a class="sourceLine" id="cb4-129" data-line-number="129">        s           <span class="fu">=</span> s&#39;</a>
<a class="sourceLine" id="cb4-130" data-line-number="130">                        { polHit <span class="fu">=</span> polHit</a>
<a class="sourceLine" id="cb4-131" data-line-number="131">                        , didHit <span class="fu">=</span> polHit</a>
<a class="sourceLine" id="cb4-132" data-line-number="132">                        }</a>
<a class="sourceLine" id="cb4-133" data-line-number="133">        polHit      <span class="fu">=</span> (act <span class="fu">.</span> pol) s&#39;</a>
<a class="sourceLine" id="cb4-134" data-line-number="134"></a>
<a class="sourceLine" id="cb4-135" data-line-number="135"><span class="ot">cardSum ::</span> [<span class="dt">Int</span>] <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Bool</span>)</a>
<a class="sourceLine" id="cb4-136" data-line-number="136">cardSum cards <span class="fu">=</span></a>
<a class="sourceLine" id="cb4-137" data-line-number="137">  <span class="kw">if</span> tot <span class="fu">&lt;</span> <span class="dv">12</span> <span class="fu">&amp;&amp;</span> <span class="dv">1</span> <span class="ot">`elem`</span> cards</a>
<a class="sourceLine" id="cb4-138" data-line-number="138">    <span class="kw">then</span> (tot <span class="fu">+</span> <span class="dv">10</span>, <span class="dt">True</span>)</a>
<a class="sourceLine" id="cb4-139" data-line-number="139">    <span class="kw">else</span> (tot,      <span class="dt">False</span>)</a>
<a class="sourceLine" id="cb4-140" data-line-number="140">  <span class="kw">where</span> tot <span class="fu">=</span> sum cards</a>
<a class="sourceLine" id="cb4-141" data-line-number="141"></a>
<a class="sourceLine" id="cb4-142" data-line-number="142"><span class="ot">showVofState ::</span> (<span class="dt">Show</span> a) <span class="ot">=&gt;</span> <span class="dt">Vector</span> <span class="dv">200</span> a <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb4-143" data-line-number="143">showVofState v <span class="fu">=</span> intercalate <span class="st">&quot;\n\n&quot;</span> <span class="fu">$</span> map (showVofState&#39; v) [<span class="dt">True</span>, <span class="dt">False</span>]</a>
<a class="sourceLine" id="cb4-144" data-line-number="144"></a>
<a class="sourceLine" id="cb4-145" data-line-number="145"><span class="ot">showVofState&#39; ::</span> <span class="dt">Show</span> a <span class="ot">=&gt;</span> <span class="dt">Vector</span> <span class="dv">200</span> a <span class="ot">-&gt;</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb4-146" data-line-number="146">showVofState&#39; v ace <span class="fu">=</span> unlines <span class="fu">$</span></a>
<a class="sourceLine" id="cb4-147" data-line-number="147">  (<span class="kw">if</span> ace</a>
<a class="sourceLine" id="cb4-148" data-line-number="148">     <span class="kw">then</span> <span class="st">&quot;With usable ace:&quot;</span></a>
<a class="sourceLine" id="cb4-149" data-line-number="149">     <span class="kw">else</span> <span class="st">&quot;No usable ace:&quot;</span>)</a>
<a class="sourceLine" id="cb4-150" data-line-number="150">  <span class="fu">:</span> ( <span class="st">&quot;\\begin{array}{c|c|c|c|c|c|c|c|c|c}&quot;</span> <span class="fu">:</span></a>
<a class="sourceLine" id="cb4-151" data-line-number="151">      ( (<span class="st">&quot;\\text{Player&#39;s Total} &amp;&quot;</span> <span class="fu">++</span> intersperse <span class="ch">&#39;&amp;&#39;</span> (replicate <span class="dv">10</span> <span class="ch">&#39; &#39;</span>) <span class="fu">++</span> <span class="st">&quot; \\\\&quot;</span>) <span class="fu">:</span></a>
<a class="sourceLine" id="cb4-152" data-line-number="152">        [<span class="st">&quot;\\hline&quot;</span>] <span class="fu">++</span></a>
<a class="sourceLine" id="cb4-153" data-line-number="153">        intersperse <span class="st">&quot;\\hline&quot;</span></a>
<a class="sourceLine" id="cb4-154" data-line-number="154">          ( map ((<span class="fu">++</span> <span class="st">&quot; \\\\&quot;</span>) <span class="fu">.</span> intercalate <span class="st">&quot; &amp; &quot;</span>)</a>
<a class="sourceLine" id="cb4-155" data-line-number="155">                [ (show pTot <span class="fu">:</span>) <span class="fu">$</span> map show</a>
<a class="sourceLine" id="cb4-156" data-line-number="156">                  [ v <span class="ot">`index`</span> enumState s</a>
<a class="sourceLine" id="cb4-157" data-line-number="157">                  <span class="fu">|</span> dCard <span class="ot">&lt;-</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">10</span>]</a>
<a class="sourceLine" id="cb4-158" data-line-number="158">                  , <span class="kw">let</span> s <span class="fu">=</span> stateDef { playerSum  <span class="fu">=</span> pTot</a>
<a class="sourceLine" id="cb4-159" data-line-number="159">                                     , usableAce  <span class="fu">=</span> ace</a>
<a class="sourceLine" id="cb4-160" data-line-number="160">                                     , dealerCard <span class="fu">=</span> dCard</a>
<a class="sourceLine" id="cb4-161" data-line-number="161">                                     }</a>
<a class="sourceLine" id="cb4-162" data-line-number="162">                  ]</a>
<a class="sourceLine" id="cb4-163" data-line-number="163">                <span class="fu">|</span> pTot <span class="ot">&lt;-</span> [<span class="dv">12</span><span class="fu">..</span><span class="dv">21</span>]</a>
<a class="sourceLine" id="cb4-164" data-line-number="164">                ]</a>
<a class="sourceLine" id="cb4-165" data-line-number="165">          )</a>
<a class="sourceLine" id="cb4-166" data-line-number="166">        <span class="fu">++</span> [<span class="st">&quot;\\hline&quot;</span>]</a>
<a class="sourceLine" id="cb4-167" data-line-number="167">        <span class="fu">++</span> [intercalate <span class="st">&quot; &amp; &quot;</span> <span class="fu">$</span> <span class="st">&quot;\\text{Dealer&#39;s Card:} &quot;</span> <span class="fu">:</span> [show n <span class="fu">|</span> n <span class="ot">&lt;-</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">10</span>]]]</a>
<a class="sourceLine" id="cb4-168" data-line-number="168">        <span class="fu">++</span> [<span class="st">&quot;\\end{array}&quot;</span>]</a>
<a class="sourceLine" id="cb4-169" data-line-number="169">      )</a>
<a class="sourceLine" id="cb4-170" data-line-number="170">    )</a>
<a class="sourceLine" id="cb4-171" data-line-number="171"></a>
<a class="sourceLine" id="cb4-172" data-line-number="172"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb4-173" data-line-number="173"><span class="co">  Command line options defintions.</span></a>
<a class="sourceLine" id="cb4-174" data-line-number="174"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb4-175" data-line-number="175"></a>
<a class="sourceLine" id="cb4-176" data-line-number="176"><span class="kw">data</span> <span class="dt">Opts</span> w <span class="fu">=</span> <span class="dt">Opts</span></a>
<a class="sourceLine" id="cb4-177" data-line-number="177">    {<span class="ot"> nGames ::</span> w <span class="ot">::</span><span class="fu">:</span> <span class="dt">Maybe</span> <span class="dt">Int</span> <span class="fu">&lt;?&gt;</span></a>
<a class="sourceLine" id="cb4-178" data-line-number="178">        <span class="st">&quot;The number of games to play.&quot;</span></a>
<a class="sourceLine" id="cb4-179" data-line-number="179">    }</a>
<a class="sourceLine" id="cb4-180" data-line-number="180">    <span class="kw">deriving</span> (<span class="dt">Generic</span>)</a>
<a class="sourceLine" id="cb4-181" data-line-number="181"></a>
<a class="sourceLine" id="cb4-182" data-line-number="182"><span class="kw">instance</span> <span class="dt">ParseRecord</span> (<span class="dt">Opts</span> <span class="dt">Wrapped</span>)</a>
<a class="sourceLine" id="cb4-183" data-line-number="183"></a>
<a class="sourceLine" id="cb4-184" data-line-number="184"></a>
<a class="sourceLine" id="cb4-185" data-line-number="185"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb4-186" data-line-number="186"><span class="co">  main()</span></a>
<a class="sourceLine" id="cb4-187" data-line-number="187"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb4-188" data-line-number="188"></a>
<a class="sourceLine" id="cb4-189" data-line-number="189"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb4-190" data-line-number="190">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-191" data-line-number="191">  <span class="co">-- Process command line options.</span></a>
<a class="sourceLine" id="cb4-192" data-line-number="192"><span class="ot">  o ::</span> <span class="dt">Opts</span> <span class="dt">Unwrapped</span> <span class="ot">&lt;-</span></a>
<a class="sourceLine" id="cb4-193" data-line-number="193">    unwrapRecord <span class="st">&quot;A solution to the &#39;Blackjack&#39; problem (Example 5.3).&quot;</span></a>
<a class="sourceLine" id="cb4-194" data-line-number="194">  <span class="kw">let</span> nG <span class="fu">=</span> fromMaybe <span class="dv">10000</span> (nGames o)</a>
<a class="sourceLine" id="cb4-195" data-line-number="195"></a>
<a class="sourceLine" id="cb4-196" data-line-number="196">  <span class="co">-- Initialize policy and state/action values.</span></a>
<a class="sourceLine" id="cb4-197" data-line-number="197">  <span class="kw">let</span> qs  <span class="fu">=</span> VS.replicate ((<span class="dv">0</span>,<span class="dv">0</span>), (<span class="dv">0</span>,<span class="dv">0</span>))  <span class="co">-- Initialize all state/action values to zero.</span></a>
<a class="sourceLine" id="cb4-198" data-line-number="198">      pol <span class="fu">=</span> VS.replicate (<span class="dt">BJAction</span> <span class="dt">True</span>)</a>
<a class="sourceLine" id="cb4-199" data-line-number="199">        <span class="fu">//</span> [ (enumState s, <span class="dt">BJAction</span> <span class="dt">False</span>)</a>
<a class="sourceLine" id="cb4-200" data-line-number="200">           <span class="fu">|</span> s <span class="ot">&lt;-</span> [ stateDef { playerSum <span class="fu">=</span> pTot</a>
<a class="sourceLine" id="cb4-201" data-line-number="201">                             , usableAce <span class="fu">=</span> ace</a>
<a class="sourceLine" id="cb4-202" data-line-number="202">                             , dealerCard <span class="fu">=</span> dCard</a>
<a class="sourceLine" id="cb4-203" data-line-number="203">                             }</a>
<a class="sourceLine" id="cb4-204" data-line-number="204">                  <span class="fu">|</span> pTot  <span class="ot">&lt;-</span> [<span class="dv">20</span>, <span class="dv">21</span>]</a>
<a class="sourceLine" id="cb4-205" data-line-number="205">                  , ace   <span class="ot">&lt;-</span> [<span class="dt">False</span>, <span class="dt">True</span>]</a>
<a class="sourceLine" id="cb4-206" data-line-number="206">                  , dCard <span class="ot">&lt;-</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">10</span>]</a>
<a class="sourceLine" id="cb4-207" data-line-number="207">                  ]</a>
<a class="sourceLine" id="cb4-208" data-line-number="208">           ]</a>
<a class="sourceLine" id="cb4-209" data-line-number="209"></a>
<a class="sourceLine" id="cb4-210" data-line-number="210">  <span class="co">-- Play many games, updating policy and state/action values after each.</span></a>
<a class="sourceLine" id="cb4-211" data-line-number="211">  (results, _) <span class="ot">&lt;-</span> runWriterT <span class="fu">$</span> iterateM&#39; nG optPol (qs, pol)</a>
<a class="sourceLine" id="cb4-212" data-line-number="212">  writeFile  <span class="st">&quot;other/blackjack.md&quot;</span> <span class="st">&quot;\n### Final State Action Values (stand, hit)\n\n&quot;</span></a>
<a class="sourceLine" id="cb4-213" data-line-number="213">  appendFile <span class="st">&quot;other/blackjack.md&quot;</span> <span class="fu">$</span> pack</a>
<a class="sourceLine" id="cb4-214" data-line-number="214">                                  <span class="fu">$</span> showVofState</a>
<a class="sourceLine" id="cb4-215" data-line-number="215">                                  <span class="fu">$</span> VS.map ( toBoth</a>
<a class="sourceLine" id="cb4-216" data-line-number="216">                                             <span class="fu">$</span> <span class="dt">PrettyFloat</span></a>
<a class="sourceLine" id="cb4-217" data-line-number="217">                                             <span class="fu">.</span> uncurry safeDiv</a>
<a class="sourceLine" id="cb4-218" data-line-number="218">                                             <span class="fu">.</span> (fromIntegral <span class="fu">***</span> fromIntegral)</a>
<a class="sourceLine" id="cb4-219" data-line-number="219">                                           )</a>
<a class="sourceLine" id="cb4-220" data-line-number="220">                                  <span class="fu">$</span> fst results</a>
<a class="sourceLine" id="cb4-221" data-line-number="221">  appendFile <span class="st">&quot;other/blackjack.md&quot;</span> <span class="st">&quot;\n### Final Policy (H = hit)\n\n&quot;</span></a>
<a class="sourceLine" id="cb4-222" data-line-number="222">  appendFile <span class="st">&quot;other/blackjack.md&quot;</span> <span class="fu">$</span> pack</a>
<a class="sourceLine" id="cb4-223" data-line-number="223">                                  <span class="fu">$</span> showVofState</a>
<a class="sourceLine" id="cb4-224" data-line-number="224">                                  <span class="fu">$</span> snd results</a>
<a class="sourceLine" id="cb4-225" data-line-number="225">  appendFile <span class="st">&quot;other/blackjack.md&quot;</span> <span class="st">&quot;\n### Debugging Info\n\n&quot;</span></a>
<a class="sourceLine" id="cb4-226" data-line-number="226">  appendFile <span class="st">&quot;other/blackjack.md&quot;</span> <span class="st">&quot;\n### State Action Visits (stand, hit)\n\n&quot;</span></a>
<a class="sourceLine" id="cb4-227" data-line-number="227">  appendFile <span class="st">&quot;other/blackjack.md&quot;</span> <span class="fu">$</span> pack</a>
<a class="sourceLine" id="cb4-228" data-line-number="228">                                  <span class="fu">$</span> showVofState</a>
<a class="sourceLine" id="cb4-229" data-line-number="229">                                  <span class="fu">$</span> VS.map ( toBoth snd )</a>
<a class="sourceLine" id="cb4-230" data-line-number="230">                                  <span class="fu">$</span> fst results</a>
<a class="sourceLine" id="cb4-231" data-line-number="231"></a>
<a class="sourceLine" id="cb4-232" data-line-number="232"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb4-233" data-line-number="233"><span class="co">  Monte Carlo optimizer</span></a>
<a class="sourceLine" id="cb4-234" data-line-number="234"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb4-235" data-line-number="235"></a>
<a class="sourceLine" id="cb4-236" data-line-number="236"><span class="co">-- | Play one game of Blackjack and return improved state-action value</span></a>
<a class="sourceLine" id="cb4-237" data-line-number="237"><span class="co">-- and policy estimates.</span></a>
<a class="sourceLine" id="cb4-238" data-line-number="238"><span class="co">--</span></a>
<a class="sourceLine" id="cb4-239" data-line-number="239"><span class="co">-- Note that the Q vector contains not only the running expectation for</span></a>
<a class="sourceLine" id="cb4-240" data-line-number="240"><span class="co">-- hitting/standing at each state, but also the number of times that</span></a>
<a class="sourceLine" id="cb4-241" data-line-number="241"><span class="co">-- particular state-action pair has been visited. This is needed for</span></a>
<a class="sourceLine" id="cb4-242" data-line-number="242"><span class="co">-- proper normalization across multiple episodes.</span></a>
<a class="sourceLine" id="cb4-243" data-line-number="243"><span class="ot">optPol ::</span> ( <span class="dt">Vector</span> <span class="dv">200</span> ((<span class="dt">Int</span>, <span class="dt">Integer</span>), (<span class="dt">Int</span>, <span class="dt">Integer</span>))</a>
<a class="sourceLine" id="cb4-244" data-line-number="244">          , <span class="dt">Vector</span> <span class="dv">200</span> <span class="dt">BJAction</span></a>
<a class="sourceLine" id="cb4-245" data-line-number="245">          )</a>
<a class="sourceLine" id="cb4-246" data-line-number="246">       <span class="ot">-&gt;</span> <span class="dt">WriterT</span> [[<span class="dt">DbgT</span>]]</a>
<a class="sourceLine" id="cb4-247" data-line-number="247">            <span class="dt">IO</span> ( <span class="dt">Vector</span> <span class="dv">200</span> ((<span class="dt">Int</span>, <span class="dt">Integer</span>), (<span class="dt">Int</span>, <span class="dt">Integer</span>))</a>
<a class="sourceLine" id="cb4-248" data-line-number="248">               , <span class="dt">Vector</span> <span class="dv">200</span> <span class="dt">BJAction</span></a>
<a class="sourceLine" id="cb4-249" data-line-number="249">               )</a>
<a class="sourceLine" id="cb4-250" data-line-number="250">optPol (qs, pol) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-251" data-line-number="251">  randAct <span class="ot">&lt;-</span> lift <span class="fu">$</span> rand allActs</a>
<a class="sourceLine" id="cb4-252" data-line-number="252">  cards <span class="ot">&lt;-</span> shuffleM <span class="fu">$</span> concat [replicate  <span class="dv">4</span>  n <span class="fu">|</span> n <span class="ot">&lt;-</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">9</span>]]</a>
<a class="sourceLine" id="cb4-253" data-line-number="253">                           <span class="fu">++</span> replicate <span class="dv">16</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb4-254" data-line-number="254">  <span class="kw">let</span> ((r, ss), dbgs) <span class="fu">=</span> runWriter <span class="fu">$</span> play (appPolV pol) cards randAct</a>
<a class="sourceLine" id="cb4-255" data-line-number="255">      ixs             <span class="fu">=</span> (nubOn fst <span class="fu">.</span> map (enumState <span class="fu">&amp;&amp;&amp;</span> didHit) <span class="fu">.</span> validStates) ss</a>
<a class="sourceLine" id="cb4-256" data-line-number="256">      (qs&#39;, pol&#39;)     <span class="fu">=</span> VS.unzip <span class="fu">$</span> VS.zip qs pol <span class="fu">//</span></a>
<a class="sourceLine" id="cb4-257" data-line-number="257">                          [ (i, (q&#39;, p&#39;))</a>
<a class="sourceLine" id="cb4-258" data-line-number="258">                          <span class="fu">|</span> (i, hit) <span class="ot">&lt;-</span> ixs</a>
<a class="sourceLine" id="cb4-259" data-line-number="259">                          , <span class="kw">let</span> q  <span class="fu">=</span> qs  <span class="ot">`index`</span> i</a>
<a class="sourceLine" id="cb4-260" data-line-number="260">                                q&#39; <span class="fu">=</span> ( <span class="kw">if</span> hit</a>
<a class="sourceLine" id="cb4-261" data-line-number="261">                                         <span class="kw">then</span> second</a>
<a class="sourceLine" id="cb4-262" data-line-number="262">                                         <span class="kw">else</span> first</a>
<a class="sourceLine" id="cb4-263" data-line-number="263">                                     ) ((<span class="fu">+</span> r) <span class="fu">***</span> (<span class="fu">+</span> <span class="dv">1</span>)) q</a>
<a class="sourceLine" id="cb4-264" data-line-number="264">                                p&#39; <span class="fu">=</span> <span class="kw">case</span> uncurry compare</a>
<a class="sourceLine" id="cb4-265" data-line-number="265">                                          <span class="fu">$</span> toBoth ( uncurry (<span class="fu">/</span>)</a>
<a class="sourceLine" id="cb4-266" data-line-number="266">                                                   <span class="fu">.</span> (fromIntegral <span class="fu">***</span> fromIntegral)</a>
<a class="sourceLine" id="cb4-267" data-line-number="267">                                                   ) q&#39;</a>
<a class="sourceLine" id="cb4-268" data-line-number="268">                                     <span class="kw">of</span></a>
<a class="sourceLine" id="cb4-269" data-line-number="269">                                       <span class="dt">GT</span> <span class="ot">-&gt;</span> <span class="dt">BJAction</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb4-270" data-line-number="270">                                       _  <span class="ot">-&gt;</span> <span class="dt">BJAction</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb4-271" data-line-number="271">                          ]</a>
<a class="sourceLine" id="cb4-272" data-line-number="272">  tell [dbgs]</a>
<a class="sourceLine" id="cb4-273" data-line-number="273">  return (qs&#39;, pol&#39;)</a>
<a class="sourceLine" id="cb4-274" data-line-number="274"></a>
<a class="sourceLine" id="cb4-275" data-line-number="275"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb4-276" data-line-number="276"><span class="co">  Misc.</span></a>
<a class="sourceLine" id="cb4-277" data-line-number="277"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb4-278" data-line-number="278"></a>
<a class="sourceLine" id="cb4-279" data-line-number="279"><span class="ot">iterateM&#39; ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> m a) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb4-280" data-line-number="280">iterateM&#39; <span class="dv">0</span> _ a <span class="fu">=</span> return a</a>
<a class="sourceLine" id="cb4-281" data-line-number="281">iterateM&#39; n f a <span class="fu">=</span> f a <span class="fu">&gt;&gt;=</span> iterateM&#39; (n<span class="fu">-</span><span class="dv">1</span>) f</a>
<a class="sourceLine" id="cb4-282" data-line-number="282"></a>
<a class="sourceLine" id="cb4-283" data-line-number="283"><span class="ot">toBoth ::</span> (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> (a,a) <span class="ot">-&gt;</span> (b,b)</a>
<a class="sourceLine" id="cb4-284" data-line-number="284">toBoth f (x,y) <span class="fu">=</span> (f x, f y)</a>
<a class="sourceLine" id="cb4-285" data-line-number="285"></a>
<a class="sourceLine" id="cb4-286" data-line-number="286"><span class="ot">safeDiv ::</span> (<span class="dt">Fractional</span> a, <span class="dt">Eq</span> a)</a>
<a class="sourceLine" id="cb4-287" data-line-number="287">        <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb4-288" data-line-number="288">safeDiv x y <span class="fu">=</span> <span class="kw">if</span> y <span class="fu">==</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-289" data-line-number="289">                <span class="kw">then</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-290" data-line-number="290">                <span class="kw">else</span> x <span class="fu">/</span> y</a>
<a class="sourceLine" id="cb4-291" data-line-number="291"></a>
<a class="sourceLine" id="cb4-292" data-line-number="292"><span class="kw">newtype</span> <span class="dt">PrettyFloat</span> <span class="fu">=</span> <span class="dt">PrettyFloat</span> <span class="dt">Float</span></a>
<a class="sourceLine" id="cb4-293" data-line-number="293"></a>
<a class="sourceLine" id="cb4-294" data-line-number="294"><span class="kw">instance</span> <span class="dt">Show</span> <span class="dt">PrettyFloat</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb4-295" data-line-number="295">  show (<span class="dt">PrettyFloat</span> x) <span class="fu">=</span> printf <span class="st">&quot;%+5.2f&quot;</span> x</a>
<a class="sourceLine" id="cb4-296" data-line-number="296"></a>
<a class="sourceLine" id="cb4-297" data-line-number="297"><span class="ot">nubOn ::</span> <span class="dt">Eq</span> b <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [a]</a>
<a class="sourceLine" id="cb4-298" data-line-number="298">nubOn _ []     <span class="fu">=</span> []</a>
<a class="sourceLine" id="cb4-299" data-line-number="299">nubOn f (x<span class="fu">:</span>xs) <span class="fu">=</span> x <span class="fu">:</span> filter ((<span class="fu">/=</span> f x) <span class="fu">.</span> f) xs</a></code></pre></div>
<h2 id="output">output</h2>
<h3 id="final-state-action-values-stand-hit">Final State Action Values (stand, hit)</h3>
With usable ace:
<span class="math display">\[\begin{array}{c|c|c|c|c|c|c|c|c|c}
\text{Player&#39;s Total} &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp;  \\
\hline
12 &amp; (-0.68,-0.09) &amp; (-0.19,-0.03) &amp; (-0.26,+0.04) &amp; (-0.23,+0.04) &amp; (-0.29,-0.04) &amp; (-0.19,+0.12) &amp; (-0.43,+0.20) &amp; (-0.56,+0.04) &amp; (-0.49,-0.07) &amp; (-0.52,+0.01) \\
\hline
13 &amp; (-0.58,-0.13) &amp; (-0.18,+0.11) &amp; (-0.33,+0.08) &amp; (-0.21,+0.13) &amp; (-0.08,+0.17) &amp; (-0.10,+0.14) &amp; (-0.45,+0.09) &amp; (-0.44,+0.08) &amp; (-0.53,-0.03) &amp; (-0.56,-0.13) \\
\hline
14 &amp; (-0.70,-0.03) &amp; (-0.41,-0.08) &amp; (-0.31,-0.01) &amp; (-0.14,+0.08) &amp; (-0.09,+0.10) &amp; (-0.11,+0.10) &amp; (-0.45,+0.17) &amp; (-0.54,+0.00) &amp; (-0.61,-0.08) &amp; (-0.50,-0.12) \\
\hline
15 &amp; (-0.66,-0.11) &amp; (-0.27,+0.01) &amp; (-0.17,+0.10) &amp; (-0.11,+0.05) &amp; (-0.18,+0.12) &amp; (-0.09,+0.06) &amp; (-0.39,+0.06) &amp; (-0.60,-0.05) &amp; (-0.57,-0.16) &amp; (-0.58,-0.15) \\
\hline
16 &amp; (-0.56,-0.22) &amp; (-0.16,-0.06) &amp; (-0.22,-0.02) &amp; (-0.22,-0.00) &amp; (-0.09,+0.11) &amp; (-0.18,+0.00) &amp; (-0.45,-0.05) &amp; (-0.46,-0.04) &amp; (-0.45,-0.12) &amp; (-0.59,-0.24) \\
\hline
17 &amp; (-0.54,-0.25) &amp; (-0.18,-0.01) &amp; (-0.10,+0.07) &amp; (-0.03,+0.09) &amp; (-0.02,+0.09) &amp; (-0.09,+0.14) &amp; (-0.12,+0.02) &amp; (-0.35,-0.03) &amp; (-0.45,-0.10) &amp; (-0.42,-0.22) \\
\hline
18 &amp; (-0.10,-0.16) &amp; (+0.10,-0.04) &amp; (+0.20,+0.14) &amp; (+0.32,+0.11) &amp; (+0.27,+0.18) &amp; (+0.20,+0.20) &amp; (+0.41,+0.15) &amp; (+0.08,+0.01) &amp; (-0.31,-0.01) &amp; (-0.20,-0.15) \\
\hline
19 &amp; (+0.25,+0.06) &amp; (+0.44,+0.15) &amp; (+0.38,+0.21) &amp; (+0.44,+0.20) &amp; (+0.44,+0.15) &amp; (+0.50,+0.23) &amp; (+0.60,+0.30) &amp; (+0.56,+0.29) &amp; (+0.27,+0.11) &amp; (+0.04,-0.09) \\
\hline
20 &amp; (+0.64,+0.17) &amp; (+0.63,+0.15) &amp; (+0.62,+0.21) &amp; (+0.61,+0.18) &amp; (+0.65,+0.22) &amp; (+0.64,+0.28) &amp; (+0.79,+0.26) &amp; (+0.82,+0.14) &amp; (+0.75,+0.01) &amp; (+0.56,-0.01) \\
\hline
21 &amp; (+0.92,+0.19) &amp; (+0.85,+0.20) &amp; (+0.88,+0.34) &amp; (+0.90,+0.18) &amp; (+0.90,+0.47) &amp; (+0.88,+0.39) &amp; (+0.92,+0.25) &amp; (+0.91,+0.10) &amp; (+0.92,+0.22) &amp; (+0.97,+0.14) \\
\hline
\text{Dealer&#39;s Card:}  &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 &amp; 6 &amp; 7 &amp; 8 &amp; 9 &amp; 10
\end{array}\]</span>
No usable ace:
<span class="math display">\[\begin{array}{c|c|c|c|c|c|c|c|c|c}
\text{Player&#39;s Total} &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp;  \\
\hline
12 &amp; (-0.63,-0.37) &amp; (-0.27,-0.23) &amp; (-0.23,-0.23) &amp; (-0.22,-0.21) &amp; (-0.15,-0.15) &amp; (-0.14,-0.20) &amp; (-0.51,-0.22) &amp; (-0.51,-0.31) &amp; (-0.53,-0.39) &amp; (-0.54,-0.38) \\
\hline
13 &amp; (-0.65,-0.40) &amp; (-0.29,-0.35) &amp; (-0.25,-0.30) &amp; (-0.18,-0.23) &amp; (-0.16,-0.23) &amp; (-0.14,-0.25) &amp; (-0.49,-0.28) &amp; (-0.51,-0.34) &amp; (-0.53,-0.39) &amp; (-0.53,-0.41) \\
\hline
14 &amp; (-0.63,-0.47) &amp; (-0.28,-0.34) &amp; (-0.21,-0.33) &amp; (-0.18,-0.33) &amp; (-0.14,-0.29) &amp; (-0.17,-0.33) &amp; (-0.50,-0.35) &amp; (-0.55,-0.38) &amp; (-0.54,-0.43) &amp; (-0.55,-0.45) \\
\hline
15 &amp; (-0.65,-0.52) &amp; (-0.30,-0.43) &amp; (-0.25,-0.42) &amp; (-0.15,-0.44) &amp; (-0.15,-0.38) &amp; (-0.17,-0.35) &amp; (-0.46,-0.40) &amp; (-0.52,-0.39) &amp; (-0.54,-0.46) &amp; (-0.53,-0.49) \\
\hline
16 &amp; (-0.66,-0.51) &amp; (-0.29,-0.45) &amp; (-0.26,-0.45) &amp; (-0.18,-0.43) &amp; (-0.10,-0.47) &amp; (-0.15,-0.42) &amp; (-0.48,-0.42) &amp; (-0.56,-0.42) &amp; (-0.54,-0.50) &amp; (-0.55,-0.53) \\
\hline
17 &amp; (-0.48,-0.58) &amp; (-0.11,-0.54) &amp; (-0.09,-0.54) &amp; (-0.06,-0.55) &amp; (-0.03,-0.52) &amp; (+0.05,-0.50) &amp; (-0.09,-0.49) &amp; (-0.41,-0.52) &amp; (-0.44,-0.53) &amp; (-0.40,-0.56) \\
\hline
18 &amp; (-0.05,-0.66) &amp; (+0.13,-0.66) &amp; (+0.17,-0.66) &amp; (+0.20,-0.63) &amp; (+0.24,-0.61) &amp; (+0.26,-0.62) &amp; (+0.39,-0.55) &amp; (+0.12,-0.56) &amp; (-0.20,-0.61) &amp; (-0.17,-0.61) \\
\hline
19 &amp; (+0.31,-0.71) &amp; (+0.37,-0.77) &amp; (+0.40,-0.69) &amp; (+0.39,-0.71) &amp; (+0.45,-0.69) &amp; (+0.47,-0.73) &amp; (+0.63,-0.69) &amp; (+0.61,-0.71) &amp; (+0.26,-0.67) &amp; (+0.07,-0.71) \\
\hline
20 &amp; (+0.66,-0.89) &amp; (+0.64,-0.86) &amp; (+0.64,-0.83) &amp; (+0.67,-0.83) &amp; (+0.69,-0.85) &amp; (+0.70,-0.83) &amp; (+0.78,-0.85) &amp; (+0.79,-0.85) &amp; (+0.74,-0.82) &amp; (+0.57,-0.82) \\
\hline
21 &amp; (+0.94,-1.00) &amp; (+0.88,-1.00) &amp; (+0.90,-1.00) &amp; (+0.89,-1.00) &amp; (+0.90,-1.00) &amp; (+0.89,-1.00) &amp; (+0.93,-1.00) &amp; (+0.94,-1.00) &amp; (+0.95,-1.00) &amp; (+0.96,-1.00) \\
\hline
\text{Dealer&#39;s Card:}  &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 &amp; 6 &amp; 7 &amp; 8 &amp; 9 &amp; 10
\end{array}\]</span>
<h3 id="final-policy-h-hit">Final Policy (H = hit)</h3>
With usable ace:
<span class="math display">\[\begin{array}{c|c|c|c|c|c|c|c|c|c}
\text{Player&#39;s Total} &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp;  \\
\hline
12 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
13 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
14 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
15 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
16 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
17 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
18 &amp;   &amp;   &amp;   &amp;   &amp;   &amp; H &amp;   &amp;   &amp; H &amp; H \\
\hline
19 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
20 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
21 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
\text{Dealer&#39;s Card:}  &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 &amp; 6 &amp; 7 &amp; 8 &amp; 9 &amp; 10
\end{array}\]</span>
No usable ace:
<span class="math display">\[\begin{array}{c|c|c|c|c|c|c|c|c|c}
\text{Player&#39;s Total} &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp;  \\
\hline
12 &amp; H &amp; H &amp;   &amp; H &amp; H &amp;   &amp; H &amp; H &amp; H &amp; H \\
\hline
13 &amp; H &amp;   &amp;   &amp;   &amp;   &amp;   &amp; H &amp; H &amp; H &amp; H \\
\hline
14 &amp; H &amp;   &amp;   &amp;   &amp;   &amp;   &amp; H &amp; H &amp; H &amp; H \\
\hline
15 &amp; H &amp;   &amp;   &amp;   &amp;   &amp;   &amp; H &amp; H &amp; H &amp; H \\
\hline
16 &amp; H &amp;   &amp;   &amp;   &amp;   &amp;   &amp; H &amp; H &amp; H &amp; H \\
\hline
17 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
18 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
19 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
20 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
21 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
\text{Dealer&#39;s Card:}  &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 &amp; 6 &amp; 7 &amp; 8 &amp; 9 &amp; 10
\end{array}\]</span>
<h3 id="debugging-info">Debugging Info</h3>
<h3 id="state-action-visits-stand-hit">State Action Visits (stand, hit)</h3>
With usable ace:
<span class="math display">\[\begin{array}{c|c|c|c|c|c|c|c|c|c}
\text{Player&#39;s Total} &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp;  \\
\hline
12 &amp; (44,23) &amp; (104,93) &amp; (84,93) &amp; (94,96) &amp; (99,75) &amp; (91,82) &amp; (95,103) &amp; (95,89) &amp; (99,85) &amp; (355,346) \\
\hline
13 &amp; (124,127) &amp; (196,185) &amp; (255,255) &amp; (242,230) &amp; (270,236) &amp; (250,252) &amp; (260,225) &amp; (238,271) &amp; (253,239) &amp; (843,939) \\
\hline
14 &amp; (125,117) &amp; (256,246) &amp; (178,227) &amp; (252,258) &amp; (224,273) &amp; (263,242) &amp; (228,265) &amp; (264,266) &amp; (233,256) &amp; (900,992) \\
\hline
15 &amp; (137,144) &amp; (248,258) &amp; (235,261) &amp; (195,229) &amp; (260,256) &amp; (249,251) &amp; (231,294) &amp; (266,303) &amp; (244,290) &amp; (922,1108) \\
\hline
16 &amp; (146,138) &amp; (282,275) &amp; (272,303) &amp; (260,287) &amp; (194,256) &amp; (272,346) &amp; (246,352) &amp; (276,340) &amp; (252,336) &amp; (1014,1177) \\
\hline
17 &amp; (116,179) &amp; (287,314) &amp; (288,334) &amp; (295,281) &amp; (296,318) &amp; (203,281) &amp; (284,335) &amp; (255,358) &amp; (288,359) &amp; (1010,1303) \\
\hline
18 &amp; (191,141) &amp; (393,285) &amp; (386,304) &amp; (395,270) &amp; (414,257) &amp; (378,297) &amp; (303,269) &amp; (373,350) &amp; (305,393) &amp; (1165,1423) \\
\hline
19 &amp; (206,163) &amp; (402,282) &amp; (425,317) &amp; (431,292) &amp; (412,279) &amp; (385,295) &amp; (421,302) &amp; (349,230) &amp; (398,317) &amp; (1633,1049) \\
\hline
20 &amp; (253,138) &amp; (442,336) &amp; (459,269) &amp; (431,283) &amp; (430,312) &amp; (443,295) &amp; (466,303) &amp; (467,315) &amp; (445,220) &amp; (1835,1142) \\
\hline
21 &amp; (129,36) &amp; (215,61) &amp; (224,58) &amp; (215,83) &amp; (218,73) &amp; (249,76) &amp; (276,85) &amp; (255,77) &amp; (246,90) &amp; (1000,308) \\
\hline
\text{Dealer&#39;s Card:}  &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 &amp; 6 &amp; 7 &amp; 8 &amp; 9 &amp; 10
\end{array}\]</span>
No usable ace:
<span class="math display">\[\begin{array}{c|c|c|c|c|c|c|c|c|c}
\text{Player&#39;s Total} &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp;  \\
\hline
12 &amp; (1451,1524) &amp; (1880,2044) &amp; (2285,2022) &amp; (2027,2199) &amp; (2175,2150) &amp; (2336,2129) &amp; (2126,2286) &amp; (1986,2361) &amp; (2107,2249) &amp; (7793,8487) \\
\hline
13 &amp; (1420,1663) &amp; (2318,2002) &amp; (2138,1776) &amp; (2333,1978) &amp; (2347,1957) &amp; (2462,1911) &amp; (1914,2455) &amp; (2048,2336) &amp; (2014,2397) &amp; (7218,8970) \\
\hline
14 &amp; (1307,1637) &amp; (2303,1852) &amp; (2314,1812) &amp; (2187,1660) &amp; (2389,1823) &amp; (2352,1884) &amp; (1840,2300) &amp; (1805,2486) &amp; (1898,2463) &amp; (6791,9146) \\
\hline
15 &amp; (1250,1722) &amp; (2371,1820) &amp; (2390,1729) &amp; (2458,1784) &amp; (2218,1598) &amp; (2495,1777) &amp; (1880,2498) &amp; (1742,2470) &amp; (1887,2624) &amp; (6589,9754) \\
\hline
16 &amp; (1213,1717) &amp; (2381,1610) &amp; (2480,1710) &amp; (2485,1633) &amp; (2418,1692) &amp; (2309,1469) &amp; (1647,2447) &amp; (1592,2632) &amp; (1632,2432) &amp; (6211,9581) \\
\hline
17 &amp; (1852,1137) &amp; (2461,1576) &amp; (2478,1590) &amp; (2475,1613) &amp; (2462,1601) &amp; (2432,1560) &amp; (2453,1329) &amp; (2685,1577) &amp; (2783,1608) &amp; (10135,5880) \\
\hline
18 &amp; (1835,999) &amp; (2448,1417) &amp; (2406,1421) &amp; (2314,1385) &amp; (2404,1464) &amp; (2411,1456) &amp; (2648,1399) &amp; (2358,1231) &amp; (2692,1402) &amp; (9821,5280) \\
\hline
19 &amp; (1811,1004) &amp; (2447,1369) &amp; (2387,1356) &amp; (2457,1392) &amp; (2336,1391) &amp; (2383,1321) &amp; (2629,1393) &amp; (2616,1384) &amp; (2462,1104) &amp; (10072,4831) \\
\hline
20 &amp; (2587,1538) &amp; (3293,2149) &amp; (3335,2156) &amp; (3334,2103) &amp; (3325,2187) &amp; (3319,2154) &amp; (3468,2193) &amp; (3592,2201) &amp; (3486,2179) &amp; (12396,7209) \\
\hline
21 &amp; (1287,269) &amp; (1610,353) &amp; (1600,354) &amp; (1664,367) &amp; (1616,381) &amp; (1588,365) &amp; (1763,353) &amp; (1815,348) &amp; (1849,348) &amp; (6979,1310) \\
\hline
\text{Dealer&#39;s Card:}  &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 &amp; 6 &amp; 7 &amp; 8 &amp; 9 &amp; 10
\end{array}\]</span>
<hr />
<div class="footer">
<p>Powered by <a href="https://haskell-lang.org/">haskell</a>, <a href="https://docs.haskellstack.org/en/stable/README/">stack</a> and <a href="http://pandoc.org/">pandoc</a>.</p>
</div>

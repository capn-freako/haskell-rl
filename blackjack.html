<meta charset="utf-8"> <link rel="stylesheet" href="other/lhs.css">
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<h1 id="haskell-rl-blackjack-problem-example-5.3">haskell-rl : Blackjack Problem (Example 5.3)</h1>
<p>This <a href="https://wiki.haskell.org/Literate_programming">literate Haskell</a> document provides a solution to Example 5.3 in <em>Reinforcement Learning</em> by Sutton &amp; Barto.</p>
<p>Original author: <a href="mailto:David.Banas@target.com">David Banas</a><br />
Original date: May 17, 2018</p>
<p>Copyright Â© 2018 Target Corp.; all rights reserved World wide.</p>
<h2 id="contents">Contents</h2>
<ul class="incremental">
<li><a href="#code">Code</a></li>
<li><a href="#output">Output</a></li>
</ul>
<h2 id="code">code</h2>
<h2 id="ghc-options"><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/flags.html#flag-reference">ghc options</a></h2>
<div class="sourceCode"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><span class="ot">{-# OPTIONS_GHC -Wall #-}</span>
<span class="ot">{-# OPTIONS_GHC -Wno-missing-signatures #-}</span>
<span class="ot">{-# OPTIONS_GHC -fno-warn-type-defaults #-}</span></code></pre></div>
<h2 id="pragmas"><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/lang.html">pragmas</a></h2>
<div class="sourceCode"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><span class="co">-- doctest doesn&#39;t look at the cabal file, so you need pragmas here</span>
<span class="ot">{-# LANGUAGE NoImplicitPrelude #-}</span>
<span class="ot">{-# LANGUAGE OverloadedStrings #-}</span>
<span class="ot">{-# LANGUAGE DataKinds #-}</span>
<span class="ot">{-# LANGUAGE DeriveGeneric #-}</span>
<span class="ot">{-# LANGUAGE FlexibleContexts #-}</span>
<span class="ot">{-# LANGUAGE RecordWildCards #-}</span>
<span class="ot">{-# LANGUAGE ScopedTypeVariables #-}</span>
<span class="ot">{-# LANGUAGE TypeOperators #-}</span>
<span class="ot">{-# LANGUAGE TypeFamilies #-}</span>
<span class="ot">{-# LANGUAGE FlexibleInstances #-}</span>
<span class="ot">{-# LANGUAGE LambdaCase #-}</span></code></pre></div>
<h2 id="libraries"><a href="https://www.stackage.org/">libraries</a></h2>
<ul class="incremental">
<li><a href="https://www.stackage.org/package/protolude">protolude</a></li>
<li><a href="https://www.stackage.org/package/optparse-generic">optparse-generic</a></li>
<li><a href="https://www.stackage.org/package/vector-sized">vector-sized</a></li>
<li><a href="https://www.stackage.org/package/finite-typelits">finite-typelits</a></li>
<li><a href="https://www.stackage.org/package/Chart">Chart</a></li>
<li><a href="https://www.stackage.org/package/Chart-cairo">Chart-cairo</a></li>
</ul>
<div class="sourceCode"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><span class="kw">import qualified</span> <span class="dt">Prelude</span> <span class="kw">as</span> <span class="dt">P</span>
<span class="kw">import </span><span class="dt">Prelude</span> (unlines, <span class="dt">Show</span>(..), <span class="dt">String</span>)

<span class="kw">import </span><span class="dt">Protolude</span>  <span class="kw">hiding</span> (show, for)
<span class="kw">import </span><span class="dt">Options.Generic</span>

<span class="kw">import qualified</span> <span class="dt">Data.Vector.Sized</span> <span class="kw">as</span> <span class="dt">VS</span>

<span class="kw">import </span><span class="dt">Control.Arrow</span>          ((***), (&amp;&amp;&amp;))
<span class="kw">import </span><span class="dt">Data.MemoTrie</span>
<span class="kw">import </span><span class="dt">Data.Finite</span>
<span class="kw">import </span><span class="dt">Data.Text</span>              (pack)
<span class="kw">import </span><span class="dt">Data.Vector.Sized</span>      (<span class="dt">Vector</span>, index)
<span class="kw">import </span><span class="dt">Graphics.Rendering.Chart.Easy</span> <span class="kw">hiding</span>   (<span class="dt">Wrapped</span>, <span class="dt">Unwrapped</span>, <span class="dt">Empty</span>, <span class="dt">Iso</span>, <span class="dt">Vector</span>, index)
<span class="kw">import </span><span class="dt">Graphics.Rendering.Chart.Backend.Cairo</span>
<span class="kw">import </span><span class="dt">Text.Printf</span>

<span class="kw">import </span><span class="dt">ConCat.TArr</span>
<span class="kw">import </span><span class="dt">ConCat.Isomorphism</span>

<span class="kw">import </span><span class="dt">RL.MDP</span>
<span class="kw">import </span><span class="dt">RL.GPI</span>
<span class="kw">import </span><span class="dt">RL.Util</span></code></pre></div>
<h2 id="code-1">code</h2>
<ul class="incremental">
<li><a href="https://www.stackage.org/package/hoogle">hoogle</a></li>
</ul>
<div class="sourceCode"><pre class="sourceCode literate haskell"><code class="sourceCode haskell">
<span class="co">{----------------------------------------------------------------------</span>
<span class="co">  State definitions &amp; instances.</span>
<span class="co">----------------------------------------------------------------------}</span>

<span class="kw">type</span> <span class="dt">Nstates</span> <span class="fu">=</span> <span class="dv">440</span>

<span class="kw">data</span> <span class="dt">BJState</span> <span class="fu">=</span> <span class="dt">BJState</span>
  {<span class="ot"> playerSum  ::</span> <span class="dt">Finite</span> <span class="dv">11</span>  <span class="co">-- ^ Represents the range: 12 - 22</span>
  ,<span class="ot"> usableAce  ::</span> <span class="dt">Bool</span>       <span class="co">-- ^ A &quot;usable&quot; ace is one currently counted as 11.</span>
  ,<span class="ot"> dealerCard ::</span> <span class="dt">Finite</span> <span class="dv">10</span>  <span class="co">-- ^ &quot;0&quot; is an ace; all face cards are &quot;9&quot;.</span>
  ,<span class="ot"> done       ::</span> <span class="dt">Bool</span>       <span class="co">-- ^ Flags a game as complete when true.</span>
  } <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Ord</span>, <span class="dt">Generic</span>)

<span class="kw">instance</span> <span class="dt">HasFin</span> <span class="dt">BJState</span> <span class="kw">where</span>
  <span class="kw">type</span> <span class="dt">Card</span> <span class="dt">BJState</span> <span class="fu">=</span> <span class="dt">Nstates</span>
  iso <span class="fu">=</span> <span class="dt">Iso</span> stToFin finToSt

<span class="ot">stToFin ::</span> <span class="dt">BJState</span> <span class="ot">-&gt;</span> <span class="dt">Finite</span> <span class="dt">Nstates</span>
stToFin <span class="dt">BJState</span>{<span class="fu">..</span>} <span class="fu">=</span> finite <span class="fu">$</span>
  getFinite playerSum     <span class="fu">*</span> <span class="dv">40</span> <span class="fu">+</span>
  boolToInteger usableAce <span class="fu">*</span> <span class="dv">20</span> <span class="fu">+</span>
  getFinite dealerCard    <span class="fu">*</span> <span class="dv">2</span> <span class="fu">+</span>
  boolToInteger done
  
<span class="ot">finToSt ::</span> <span class="dt">Finite</span> <span class="dt">Nstates</span> <span class="ot">-&gt;</span> <span class="dt">BJState</span>
finToSt n <span class="fu">=</span>
  <span class="kw">let</span> (pSum,  r)    <span class="fu">=</span> divMod (getFinite n) <span class="dv">40</span>
      (ace,   r&#39;)   <span class="fu">=</span> divMod r <span class="dv">20</span>
      (dCard, done) <span class="fu">=</span> divMod r&#39; <span class="dv">2</span>
   <span class="kw">in</span> <span class="kw">if</span> pSum <span class="fu">&gt;</span> <span class="dv">10</span>
         <span class="kw">then</span> P.error <span class="st">&quot;finToSt: Blew out a Finite 11!&quot;</span>
         <span class="kw">else</span> <span class="dt">BJState</span> (finite pSum) (integerToBool ace) (finite dCard) (integerToBool done)

<span class="co">-- | The @&#39;MDP&#39;@ instance for @&#39;BJState&#39;@.</span>
<span class="kw">instance</span> <span class="dt">MDP</span> <span class="dt">BJState</span> <span class="kw">where</span>
  <span class="kw">type</span> <span class="dt">ActionT</span> <span class="dt">BJState</span> <span class="fu">=</span> <span class="dt">BJAction</span>
  states  <span class="fu">=</span> allStates
  actions <span class="fu">=</span> \<span class="dt">BJState</span>{<span class="fu">..</span>} <span class="ot">-&gt;</span>
    <span class="kw">if</span> playerSum <span class="fu">&gt;</span> <span class="dv">8</span> <span class="fu">||</span> done <span class="fu">==</span> <span class="dt">True</span>  <span class="co">-- If we&#39;re made or bust then we have to stand.</span>
      <span class="kw">then</span> [<span class="dt">Stand</span>]
      <span class="kw">else</span> [<span class="dt">Hit</span>, <span class="dt">Stand</span>]
  jointPMF st act <span class="fu">=</span> <span class="kw">case</span> act <span class="kw">of</span>
    <span class="dt">Hit</span> <span class="ot">-&gt;</span> hit   st
    _   <span class="ot">-&gt;</span> stand st
  termStates <span class="fu">=</span> filter (\<span class="dt">BJState</span>{<span class="fu">..</span>} <span class="ot">-&gt;</span> done <span class="fu">==</span> <span class="dt">True</span>)                   allStates
  initStates <span class="fu">=</span> filter (\<span class="dt">BJState</span>{<span class="fu">..</span>} <span class="ot">-&gt;</span> done <span class="fu">/=</span> <span class="dt">True</span> <span class="fu">&amp;&amp;</span> playerSum <span class="fu">&lt;</span> <span class="dv">10</span>) allStates

<span class="ot">allStates ::</span> [<span class="dt">BJState</span>]
allStates <span class="fu">=</span>
  [ <span class="dt">BJState</span> (finite pSum) ace (finite dlrCrd) dn
  <span class="fu">|</span> pSum   <span class="ot">&lt;-</span> [<span class="dv">0</span><span class="fu">..</span><span class="dv">10</span>]
  , ace    <span class="ot">&lt;-</span> [<span class="dt">False</span>, <span class="dt">True</span>]
  , dlrCrd <span class="ot">&lt;-</span> [<span class="dv">0</span><span class="fu">..</span><span class="dv">9</span>]
  , dn     <span class="ot">&lt;-</span> [<span class="dt">False</span>, <span class="dt">True</span>]
  ]

<span class="ot">stateDef ::</span> <span class="dt">BJState</span>
stateDef <span class="fu">=</span> <span class="dt">BJState</span>
  { playerSum  <span class="fu">=</span> finite <span class="dv">0</span>
  , usableAce  <span class="fu">=</span> <span class="dt">False</span>
  , dealerCard <span class="fu">=</span> finite <span class="dv">9</span>
  , done       <span class="fu">=</span> <span class="dt">False</span>
  }

<span class="co">{----------------------------------------------------------------------</span>
<span class="co">  Actions</span>
<span class="co">----------------------------------------------------------------------}</span>

<span class="kw">type</span> <span class="dt">Nacts</span> <span class="fu">=</span> <span class="dv">2</span>

<span class="kw">data</span> <span class="dt">BJAction</span> <span class="fu">=</span> <span class="dt">Hit</span>
              <span class="fu">|</span> <span class="dt">Stand</span>
  <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Generic</span>)

<span class="kw">instance</span> <span class="dt">Show</span> <span class="dt">BJAction</span> <span class="kw">where</span>
  show <span class="fu">=</span> \<span class="kw">case</span>
    <span class="dt">Hit</span> <span class="ot">-&gt;</span> <span class="st">&quot;H&quot;</span>
    _   <span class="ot">-&gt;</span> <span class="st">&quot; &quot;</span>

<span class="kw">instance</span> <span class="dt">HasTrie</span> <span class="dt">BJAction</span> <span class="kw">where</span>
  <span class="kw">newtype</span> (<span class="dt">BJAction</span> <span class="fu">:-&gt;:</span> b) <span class="fu">=</span> <span class="dt">BJActionTrie</span> {<span class="ot"> unBJActionTrie ::</span> <span class="dt">Reg</span> <span class="dt">BJAction</span> <span class="fu">:-&gt;:</span> b } 
  trie      <span class="fu">=</span> trieGeneric      <span class="dt">BJActionTrie</span> 
  untrie    <span class="fu">=</span> untrieGeneric    unBJActionTrie
  enumerate <span class="fu">=</span> enumerateGeneric unBJActionTrie

<span class="kw">instance</span> <span class="dt">HasFin</span> <span class="dt">BJAction</span> <span class="kw">where</span>
  <span class="kw">type</span> <span class="dt">Card</span> <span class="dt">BJAction</span> <span class="fu">=</span> <span class="dt">Nacts</span>
  iso <span class="fu">=</span> <span class="dt">Iso</span> actToFin finToAct

<span class="ot">actToFin ::</span> <span class="dt">BJAction</span> <span class="ot">-&gt;</span> <span class="dt">Finite</span> <span class="dt">Nacts</span>
actToFin <span class="fu">=</span> \<span class="kw">case</span>
  <span class="dt">Hit</span> <span class="ot">-&gt;</span> <span class="dv">0</span>
  _   <span class="ot">-&gt;</span> <span class="dv">1</span>

<span class="ot">finToAct ::</span> <span class="dt">Finite</span> <span class="dt">Nacts</span> <span class="ot">-&gt;</span> <span class="dt">BJAction</span>
finToAct <span class="fu">=</span> \<span class="kw">case</span>
  <span class="dv">0</span> <span class="ot">-&gt;</span> <span class="dt">Hit</span>
  _ <span class="ot">-&gt;</span> <span class="dt">Stand</span>

<span class="co">{----------------------------------------------------------------------</span>
<span class="co">  Helper functions.</span>
<span class="co">----------------------------------------------------------------------}</span>

<span class="ot">hit ::</span> <span class="dt">BJState</span> <span class="ot">-&gt;</span> [((<span class="dt">BJState</span>, <span class="dt">Double</span>), <span class="dt">Double</span>)]
hit st<span class="fu">@</span><span class="dt">BJState</span>{<span class="fu">..</span>} <span class="fu">=</span>
  [ ((nxtSt, <span class="dv">0</span>), <span class="fl">0.0769</span>)           <span class="co">-- 0.0769 = 1/13.</span>
  <span class="fu">|</span> card <span class="ot">&lt;-</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">10</span>] <span class="fu">++</span> [<span class="dv">10</span>,<span class="dv">10</span>,<span class="dv">10</span>]  <span class="co">-- Ten, Jack, Queen, and King = 10.</span>
  , <span class="kw">let</span> (tot, ace) <span class="fu">=</span> cardSum (getFinite playerSum <span class="fu">+</span> <span class="dv">12</span>) usableAce card
        nxtSt      <span class="fu">=</span> st{ playerSum <span class="fu">=</span> finite <span class="fu">$</span> min <span class="dv">10</span> (tot <span class="fu">-</span> <span class="dv">12</span>)
                       , usableAce <span class="fu">=</span> ace
                       }
  ]

<span class="ot">stand ::</span> <span class="dt">BJState</span> <span class="ot">-&gt;</span> [((<span class="dt">BJState</span>, <span class="dt">Double</span>), <span class="dt">Double</span>)]
stand st<span class="fu">@</span><span class="dt">BJState</span>{<span class="fu">..</span>} <span class="fu">=</span>
  [ ((st&#39;, <span class="fu">-</span><span class="dv">1</span>), <span class="dv">1</span> <span class="fu">-</span> pWin <span class="fu">-</span> pDraw)
  , ((st&#39;,  <span class="dv">0</span>), pDraw)
  , ((st&#39;,  <span class="dv">1</span>), pWin)
  ]
  <span class="kw">where</span>
    st&#39;  <span class="fu">=</span> st{done <span class="fu">=</span> <span class="dt">True</span>}
    pTot <span class="fu">=</span> getFinite playerSum <span class="fu">+</span> <span class="dv">12</span>
    pWin <span class="fu">=</span>
      <span class="kw">if</span> pTot <span class="fu">&gt;</span> <span class="dv">21</span>
        <span class="kw">then</span> <span class="dv">0</span>
        <span class="kw">else</span> sum <span class="fu">.</span> map snd <span class="fu">$</span>
               filter ((\x <span class="ot">-&gt;</span> x <span class="fu">&lt;</span> pTot <span class="fu">||</span> x <span class="fu">&gt;</span> <span class="dv">21</span>) <span class="fu">.</span> fst) dlrHnds
    pDraw       <span class="fu">=</span> sum <span class="fu">.</span> map snd <span class="fu">$</span> filter ((<span class="fu">==</span> pTot) <span class="fu">.</span> fst) dlrHnds
    dlrHnds     <span class="fu">=</span> map (first (min <span class="dv">22</span>)) <span class="fu">$</span> playHand init ace <span class="dv">1</span>
    (init, ace) <span class="fu">=</span> <span class="kw">if</span> dealerCard <span class="fu">==</span> <span class="dv">0</span>
                    <span class="kw">then</span> (<span class="dv">11</span>, <span class="dt">True</span>)
                    <span class="kw">else</span> (getFinite dealerCard <span class="fu">+</span> <span class="dv">1</span>, <span class="dt">False</span>)

<span class="co">-- | Adjust the total count of a hand after taking a card.</span>
<span class="co">--</span>
<span class="co">-- Make use of a &quot;usable ace&quot; to avoid going bust.</span>
<span class="co">-- (A &quot;usable ace&quot; is one that is currently being counted as 11.)</span>
<span class="ot">cardSum ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> (<span class="dt">Integer</span>, <span class="dt">Bool</span>)
cardSum acc ace card <span class="fu">=</span> (acc&#39;, ace&#39;)
  <span class="kw">where</span> (acc&#39;, ace&#39;) <span class="fu">=</span> <span class="kw">case</span> card <span class="kw">of</span>
          <span class="dv">1</span> <span class="ot">-&gt;</span> <span class="kw">case</span> ace <span class="kw">of</span>
            <span class="dt">True</span> <span class="ot">-&gt;</span> <span class="kw">if</span> acc <span class="fu">+</span> <span class="dv">1</span> <span class="fu">&gt;</span> <span class="dv">21</span>
                      <span class="kw">then</span> (acc <span class="fu">-</span> <span class="dv">9</span>, <span class="dt">False</span>)  <span class="co">-- Use our usable ace to avoid bust.</span>
                      <span class="kw">else</span> (acc <span class="fu">+</span> <span class="dv">1</span>, <span class="dt">True</span>)
            _    <span class="ot">-&gt;</span> <span class="kw">if</span> acc <span class="fu">+</span> <span class="dv">11</span> <span class="fu">&lt;=</span> <span class="dv">21</span>
                      <span class="kw">then</span> (acc <span class="fu">+</span> <span class="dv">11</span>, <span class="dt">True</span>)  <span class="co">-- Count the ace as 11.</span>
                      <span class="kw">else</span> (acc <span class="fu">+</span>  <span class="dv">1</span>, <span class="dt">False</span>)
          _ <span class="ot">-&gt;</span> <span class="kw">case</span> ace <span class="kw">of</span>
            <span class="dt">True</span> <span class="ot">-&gt;</span> <span class="kw">if</span> acc <span class="fu">+</span> card <span class="fu">&gt;</span> <span class="dv">21</span>
                      <span class="kw">then</span> (acc <span class="fu">+</span> card <span class="fu">-</span> <span class="dv">10</span>, <span class="dt">False</span>)
                      <span class="kw">else</span> (acc <span class="fu">+</span> card,      <span class="dt">True</span>)
            _    <span class="ot">-&gt;</span> (acc <span class="fu">+</span> card, <span class="dt">False</span>)

<span class="co">-- | Play out the dealer&#39;s hand.</span>
<span class="co">--</span>
<span class="co">-- Take as input:</span>
<span class="co">--   - the current total,</span>
<span class="co">--   - a flag indicating a usable ace, and</span>
<span class="co">--   - the accumulated probability so far.</span>
<span class="co">--</span>
<span class="co">-- Return a list of pairs, each containing the final tally and its probability.</span>
<span class="ot">playHand ::</span> <span class="dt">Integer</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> [(<span class="dt">Integer</span>, <span class="dt">Double</span>)]
playHand tot ace p <span class="fu">=</span>
  <span class="kw">if</span> tot <span class="fu">&gt;</span> <span class="dv">16</span>
    <span class="kw">then</span> [(tot, p)]
    <span class="kw">else</span> concat [ playHand tot&#39; ace&#39; (p<span class="fu">/</span><span class="dv">13</span>)
                <span class="fu">|</span> card <span class="ot">&lt;-</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">10</span>] <span class="fu">++</span> [<span class="dv">10</span>,<span class="dv">10</span>,<span class="dv">10</span>]
                , <span class="kw">let</span> (tot&#39;, ace&#39;) <span class="fu">=</span> cardSum tot ace card
                ]
  
<span class="ot">showFofState ::</span> <span class="dt">Show</span> a <span class="ot">=&gt;</span> (<span class="dt">BJState</span> <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> <span class="dt">String</span>
showFofState f <span class="fu">=</span> intercalate <span class="st">&quot;\n\n&quot;</span> <span class="fu">$</span> map (showFofState&#39; f) [<span class="dt">True</span>, <span class="dt">False</span>]

<span class="ot">showFofState&#39; ::</span> <span class="dt">Show</span> a <span class="ot">=&gt;</span> (<span class="dt">BJState</span> <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
showFofState&#39; f ace <span class="fu">=</span> unlines <span class="fu">$</span>
  (<span class="kw">if</span> ace
     <span class="kw">then</span> <span class="st">&quot;With usable ace:&quot;</span>
     <span class="kw">else</span> <span class="st">&quot;No usable ace:&quot;</span>)
  <span class="fu">:</span> ( <span class="st">&quot;\\begin{array}{c|c|c|c|c|c|c|c|c|c}&quot;</span> <span class="fu">:</span>
      ( (<span class="st">&quot;\\text{Player&#39;s Total} &amp;&quot;</span> <span class="fu">++</span> intersperse <span class="ch">&#39;&amp;&#39;</span> (replicate <span class="dv">10</span> <span class="ch">&#39; &#39;</span>) <span class="fu">++</span> <span class="st">&quot; \\\\&quot;</span>) <span class="fu">:</span>
        [<span class="st">&quot;\\hline&quot;</span>] <span class="fu">++</span>
        intersperse <span class="st">&quot;\\hline&quot;</span>
          ( map ((<span class="fu">++</span> <span class="st">&quot; \\\\&quot;</span>) <span class="fu">.</span> intercalate <span class="st">&quot; &amp; &quot;</span>)
                [ (show pTot <span class="fu">:</span>) <span class="fu">$</span> map show
                  [ f s
                  <span class="fu">|</span> dCard <span class="ot">&lt;-</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">10</span>]
                  , <span class="kw">let</span> s <span class="fu">=</span> stateDef { playerSum  <span class="fu">=</span> finite <span class="fu">$</span> pTot <span class="fu">-</span> <span class="dv">12</span>
                                     , usableAce  <span class="fu">=</span> ace
                                     , dealerCard <span class="fu">=</span> finite <span class="fu">$</span> dCard <span class="fu">-</span> <span class="dv">1</span>
                                     }
                  ]
                <span class="fu">|</span> pTot <span class="ot">&lt;-</span> [<span class="dv">12</span><span class="fu">..</span><span class="dv">21</span>]
                ]
          )
        <span class="fu">++</span> [<span class="st">&quot;\\hline&quot;</span>]
        <span class="fu">++</span> [intercalate <span class="st">&quot; &amp; &quot;</span> <span class="fu">$</span> <span class="st">&quot;\\text{Dealer&#39;s Card:} &quot;</span> <span class="fu">:</span> [show n <span class="fu">|</span> n <span class="ot">&lt;-</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">10</span>]]]
        <span class="fu">++</span> [<span class="st">&quot;\\end{array}&quot;</span>]
      )
    )

<span class="ot">showVofState ::</span> (<span class="dt">Show</span> a) <span class="ot">=&gt;</span> <span class="dt">Vector</span> <span class="dt">Nstates</span> a <span class="ot">-&gt;</span> <span class="dt">String</span>
showVofState v <span class="fu">=</span> intercalate <span class="st">&quot;\n\n&quot;</span> <span class="fu">$</span> map (showVofState&#39; v) [<span class="dt">True</span>, <span class="dt">False</span>]

<span class="ot">showVofState&#39; ::</span> <span class="dt">Show</span> a <span class="ot">=&gt;</span> <span class="dt">Vector</span> <span class="dt">Nstates</span> a <span class="ot">-&gt;</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">String</span>
showVofState&#39; v ace <span class="fu">=</span> unlines <span class="fu">$</span>
  (<span class="kw">if</span> ace
     <span class="kw">then</span> <span class="st">&quot;With usable ace:&quot;</span>
     <span class="kw">else</span> <span class="st">&quot;No usable ace:&quot;</span>)
  <span class="fu">:</span> ( <span class="st">&quot;\\begin{array}{c|c|c|c|c|c|c|c|c|c}&quot;</span> <span class="fu">:</span>
      ( (<span class="st">&quot;\\text{Player&#39;s Total} &amp;&quot;</span> <span class="fu">++</span> intersperse <span class="ch">&#39;&amp;&#39;</span> (replicate <span class="dv">10</span> <span class="ch">&#39; &#39;</span>) <span class="fu">++</span> <span class="st">&quot; \\\\&quot;</span>) <span class="fu">:</span>
        [<span class="st">&quot;\\hline&quot;</span>] <span class="fu">++</span>
        intersperse <span class="st">&quot;\\hline&quot;</span>
          ( map ((<span class="fu">++</span> <span class="st">&quot; \\\\&quot;</span>) <span class="fu">.</span> intercalate <span class="st">&quot; &amp; &quot;</span>)
                [ (show pTot <span class="fu">:</span>) <span class="fu">$</span> map show
                  [ v <span class="ot">`index`</span> toFin s
                  <span class="fu">|</span> dCard <span class="ot">&lt;-</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">10</span>]
                  , <span class="kw">let</span> s <span class="fu">=</span> stateDef { playerSum  <span class="fu">=</span> finite <span class="fu">$</span> pTot <span class="fu">-</span> <span class="dv">12</span>
                                     , usableAce  <span class="fu">=</span> ace
                                     , dealerCard <span class="fu">=</span> finite <span class="fu">$</span> dCard <span class="fu">-</span> <span class="dv">1</span>
                                     }
                  ]
                <span class="fu">|</span> pTot <span class="ot">&lt;-</span> [<span class="dv">12</span><span class="fu">..</span><span class="dv">21</span>]
                ]
          )
        <span class="fu">++</span> [<span class="st">&quot;\\hline&quot;</span>]
        <span class="fu">++</span> [intercalate <span class="st">&quot; &amp; &quot;</span> <span class="fu">$</span> <span class="st">&quot;\\text{Dealer&#39;s Card:} &quot;</span> <span class="fu">:</span> [show n <span class="fu">|</span> n <span class="ot">&lt;-</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">10</span>]]]
        <span class="fu">++</span> [<span class="st">&quot;\\end{array}&quot;</span>]
      )
    )

<span class="co">{----------------------------------------------------------------------</span>
<span class="co">  Command line options defintions.</span>
<span class="co">----------------------------------------------------------------------}</span>

<span class="kw">data</span> <span class="dt">Opts</span> w <span class="fu">=</span> <span class="dt">Opts</span>
    {<span class="ot"> nGames  ::</span> w <span class="ot">::</span><span class="fu">:</span> <span class="dt">Maybe</span> <span class="dt">Int</span> <span class="fu">&lt;?&gt;</span>
        <span class="st">&quot;The number of games to play.&quot;</span>
    ,<span class="ot"> eps     ::</span> w <span class="ot">::</span><span class="fu">:</span> <span class="dt">Maybe</span> <span class="dt">Double</span> <span class="fu">&lt;?&gt;</span>
        <span class="st">&quot;Epsilon in epsilon-greedy.&quot;</span>
    ,<span class="ot"> dcy     ::</span> w <span class="ot">::</span><span class="fu">:</span> <span class="dt">Maybe</span> <span class="dt">Double</span> <span class="fu">&lt;?&gt;</span>
        <span class="st">&quot;The decay rate for epsilon&quot;</span>
    }
    <span class="kw">deriving</span> (<span class="dt">Generic</span>)

<span class="kw">instance</span> <span class="dt">ParseRecord</span> (<span class="dt">Opts</span> <span class="dt">Wrapped</span>)


<span class="co">{----------------------------------------------------------------------</span>
<span class="co">  main()</span>
<span class="co">----------------------------------------------------------------------}</span>

mdFilename   <span class="fu">=</span> <span class="st">&quot;other/blackjack.md&quot;</span>
plotFilename <span class="fu">=</span> <span class="st">&quot;img/blackjackPlot.png&quot;</span>

<span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> <span class="kw">do</span>
  <span class="co">-- Process command line options.</span>
<span class="ot">  o ::</span> <span class="dt">Opts</span> <span class="dt">Unwrapped</span> <span class="ot">&lt;-</span>
    unwrapRecord <span class="st">&quot;A solution to the &#39;Blackjack&#39; problem (Example 5.3).&quot;</span>
  <span class="kw">let</span> nG     <span class="fu">=</span> fromMaybe <span class="dv">10000</span>     (nGames o)
      eps&#39;   <span class="fu">=</span> fromMaybe     <span class="fl">0.1</span>   (eps    o)
      beta&#39;  <span class="fu">=</span> fromMaybe     <span class="dv">0</span>     (dcy    o)
      
  <span class="co">-- Play many games, updating policy and state/action values after each.</span>
  <span class="co">-- (results, _) &lt;- runWriterT $ iterateM&#39; nG optPol (qs, pol)</span>
  <span class="kw">let</span> myHypParams <span class="fu">=</span>
        hypParamsDef
          { tdStepType <span class="fu">=</span> <span class="dt">Qlearn</span>
          , epsilon    <span class="fu">=</span> eps&#39;
          , beta       <span class="fu">=</span> beta&#39;
          , maxIter    <span class="fu">=</span> <span class="dv">1</span>       <span class="co">-- Because we&#39;re using Monte Carlo (i.e. - ending in a terminal state).</span>
          , nSteps     <span class="fu">=</span> <span class="dv">10</span>      <span class="co">-- No game should require more than 10 hits.</span>
          , mode       <span class="fu">=</span> <span class="dt">MC</span>      <span class="co">-- Monte Carlo</span>
          }
      <span class="co">-- ress :: [TDRetT MyState MyAction Double (Card MyState) (Card (ActionT MyState))]</span>
      res  <span class="fu">=</span> doTD myHypParams nG
      qMat <span class="fu">=</span> P.last <span class="fu">$</span> qMats  res
      dbgs <span class="fu">=</span> P.last <span class="fu">$</span> debugs res
      maxN <span class="fu">=</span> maximum <span class="fu">$</span> map length <span class="fu">$</span> debugs res

  <span class="co">-- Output the results.</span>
  writeFile  mdFilename <span class="st">&quot;\n### Final Policy (H = hit)\n\n&quot;</span>
  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> showFofState <span class="fu">$</span> P.last <span class="fu">$</span> polFuncs res

  <span class="co">-- Value/Action changes vs. Iteration</span>
  appendFile mdFilename <span class="st">&quot;\n### Policy/Value Function Changes vs. Iteration\n\n&quot;</span>
  toFile def plotFilename <span class="fu">$</span> <span class="kw">do</span>
    layoutlr_title <span class="fu">.=</span> <span class="st">&quot;Policy/Value Function Changes vs. Iteration&quot;</span>
    setColors <span class="fu">$</span> map opaque [blue, red, green, yellow, cyan, magenta, brown, gray, purple, black]
    plotLeft  ( line <span class="st">&quot;Policy Changes&quot;</span>
                 [ [ (x,y)
                   <span class="fu">|</span> (x,y) <span class="ot">&lt;-</span> zip [(<span class="dv">0</span><span class="ot">::</span><span class="dt">Int</span>)<span class="fu">..</span>]
                                  ((winMean <span class="dv">100</span> <span class="fu">$</span> map fromIntegral <span class="fu">$</span> polXCnts res)<span class="ot"> ::</span> [<span class="dt">Double</span>])
                   ]
                 ]
              )
    plotRight ( line <span class="st">&quot;Value Changes&quot;</span>
                [ [ (x,y)
                  <span class="fu">|</span> (x,y) <span class="ot">&lt;-</span> zip [(<span class="dv">0</span><span class="ot">::</span><span class="dt">Int</span>)<span class="fu">..</span>]
                                 (winMean <span class="dv">100</span> <span class="fu">$</span> valErrs res)
                  ]
                ]
              )
  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> printf <span class="st">&quot;\n![](%s)\n&quot;</span> plotFilename

  <span class="co">-- Debugging Info</span>
  appendFile mdFilename <span class="st">&quot;\n### Debugging Info\n\n&quot;</span>

  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> printf <span class="st">&quot;**Number of games played:** %d  \n&quot;</span> nG
  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> printf <span class="st">&quot;**Epsilon:** %f  \n&quot;</span> eps&#39;
  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> printf <span class="st">&quot;**Beta:** %f\n\n&quot;</span> beta&#39;

  appendFile mdFilename <span class="st">&quot;**Last game sequence:**  \n&quot;</span>
  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> unlines <span class="fu">$</span>
    map ( \<span class="dt">Dbg</span>{<span class="fu">..</span>} <span class="ot">-&gt;</span>
            printf <span class="st">&quot;\tTotal: %2d, Action: %s, Reward: %3.1f  &quot;</span>            
                   (<span class="dv">12</span> <span class="fu">+</span> (getFinite <span class="fu">.</span> playerSum) curSt)
                   (<span class="kw">if</span> act <span class="fu">==</span> <span class="dt">Hit</span> <span class="kw">then</span> (<span class="st">&quot;H&quot;</span><span class="ot"> ::</span> <span class="dt">String</span>) <span class="kw">else</span> <span class="st">&quot;S&quot;</span>)
                   (rwd)
        ) dbgs
      
  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> printf <span class="st">&quot;\n**Max. game length:** %d\n\n&quot;</span> maxN

  appendFile  mdFilename <span class="st">&quot;**Final State Action Values (stand, hit):**\n\n&quot;</span>
  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> showVofState
    <span class="fu">$</span> VS.map (((<span class="dt">Pdouble</span> <span class="fu">.</span> fst) <span class="fu">***</span> (<span class="dt">Pdouble</span> <span class="fu">.</span> fst)) <span class="fu">.</span> ((<span class="ot">`index`</span> <span class="dv">1</span>) <span class="fu">&amp;&amp;&amp;</span> (<span class="ot">`index`</span> <span class="dv">0</span>))) qMat

  appendFile mdFilename <span class="st">&quot;\n**State Action Visits (stand, hit):**\n\n&quot;</span>
  appendFile mdFilename <span class="fu">$</span> pack <span class="fu">$</span> showVofState
    <span class="fu">$</span> VS.map ((snd <span class="fu">***</span> snd) <span class="fu">.</span> ((<span class="ot">`index`</span> <span class="dv">1</span>) <span class="fu">&amp;&amp;&amp;</span> (<span class="ot">`index`</span> <span class="dv">0</span>))) qMat

  <span class="co">-- appendFile mdFilename &quot;\n**Testing State Enumeration:**\n\n&quot;</span>
  <span class="co">-- appendFile mdFilename $ pack $ showFofState toFin</span></code></pre></div>
<h2 id="output">output</h2>
<h3 id="final-policy-h-hit">Final Policy (H = hit)</h3>
With usable ace:
<span class="math display">\[\begin{array}{c|c|c|c|c|c|c|c|c|c}
\text{Player&#39;s Total} &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp;  \\
\hline
12 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
13 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
14 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
15 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
16 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
17 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
18 &amp; H &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp; H &amp; H \\
\hline
19 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
20 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
21 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
\text{Dealer&#39;s Card:}  &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 &amp; 6 &amp; 7 &amp; 8 &amp; 9 &amp; 10
\end{array}\]</span>
No usable ace:
<span class="math display">\[\begin{array}{c|c|c|c|c|c|c|c|c|c}
\text{Player&#39;s Total} &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp;  \\
\hline
12 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
13 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
14 &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H &amp; H \\
\hline
15 &amp; H &amp; H &amp; H &amp; H &amp;   &amp;   &amp; H &amp; H &amp; H &amp; H \\
\hline
16 &amp; H &amp; H &amp;   &amp;   &amp;   &amp;   &amp; H &amp; H &amp; H &amp; H \\
\hline
17 &amp; H &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp; H &amp; H &amp;   \\
\hline
18 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
19 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
20 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
21 &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   &amp;   \\
\hline
\text{Dealer&#39;s Card:}  &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 &amp; 6 &amp; 7 &amp; 8 &amp; 9 &amp; 10
\end{array}\]</span>
<h3 id="policyvalue-function-changes-vs.-iteration">Policy/Value Function Changes vs. Iteration</h3>
<div class="figure">
<img src="img/blackjackPlot.png" />

</div>
<h3 id="debugging-info">Debugging Info</h3>
<p><strong>Number of games played:</strong> 100000<br />
<strong>Epsilon:</strong> 0.5<br />
<strong>Beta:</strong> 0.0</p>
<p><strong>Last game sequence:</strong><br />
Total: 14, Action: H, Reward: 0.0<br />
Total: 21, Action: S, Reward: 0.9</p>
<p><strong>Max. game length:</strong> 7</p>
<p><strong>Final State Action Values (stand, hit):</strong></p>
With usable ace:
<span class="math display">\[\begin{array}{c|c|c|c|c|c|c|c|c|c}
\text{Player&#39;s Total} &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp;  \\
\hline
12 &amp; (-0.77,-0.19) &amp; (-0.29, 0.15) &amp; (-0.25, 0.15) &amp; (-0.21, 0.18) &amp; (-0.17, 0.20) &amp; (-0.15, 0.24) &amp; (-0.48, 0.21) &amp; (-0.51, 0.15) &amp; (-0.54, 0.11) &amp; (-0.58,-0.03) \\
\hline
13 &amp; (-0.77,-0.21) &amp; (-0.29, 0.10) &amp; (-0.25, 0.12) &amp; (-0.21, 0.10) &amp; (-0.17, 0.22) &amp; (-0.15, 0.21) &amp; (-0.48, 0.24) &amp; (-0.51, 0.09) &amp; (-0.54, 0.00) &amp; (-0.58,-0.10) \\
\hline
14 &amp; (-0.77,-0.28) &amp; (-0.29, 0.04) &amp; (-0.25, 0.06) &amp; (-0.21, 0.12) &amp; (-0.17, 0.15) &amp; (-0.15, 0.11) &amp; (-0.48, 0.20) &amp; (-0.51, 0.10) &amp; (-0.54,-0.02) &amp; (-0.58,-0.13) \\
\hline
15 &amp; (-0.77,-0.33) &amp; (-0.29, 0.03) &amp; (-0.25, 0.11) &amp; (-0.21, 0.12) &amp; (-0.17, 0.09) &amp; (-0.15, 0.18) &amp; (-0.48, 0.11) &amp; (-0.51, 0.10) &amp; (-0.54,-0.03) &amp; (-0.58,-0.19) \\
\hline
16 &amp; (-0.77,-0.29) &amp; (-0.29, 0.05) &amp; (-0.25,-0.00) &amp; (-0.21, 0.04) &amp; (-0.17, 0.04) &amp; (-0.15, 0.16) &amp; (-0.48, 0.11) &amp; (-0.51, 0.05) &amp; (-0.54,-0.15) &amp; (-0.58,-0.25) \\
\hline
17 &amp; (-0.64,-0.35) &amp; (-0.15, 0.03) &amp; (-0.12, 0.04) &amp; (-0.08, 0.11) &amp; (-0.04, 0.12) &amp; ( 0.01, 0.13) &amp; (-0.11, 0.07) &amp; (-0.38, 0.03) &amp; (-0.42,-0.10) &amp; (-0.46,-0.24) \\
\hline
18 &amp; (-0.38,-0.28) &amp; ( 0.12, 0.08) &amp; ( 0.15, 0.09) &amp; ( 0.18, 0.10) &amp; ( 0.20, 0.15) &amp; ( 0.28, 0.22) &amp; ( 0.40, 0.23) &amp; ( 0.11, 0.09) &amp; (-0.18,-0.05) &amp; (-0.24,-0.17) \\
\hline
19 &amp; (-0.12,-0.18) &amp; ( 0.39, 0.19) &amp; ( 0.40, 0.16) &amp; ( 0.42, 0.20) &amp; ( 0.44, 0.21) &amp; ( 0.50, 0.24) &amp; ( 0.62, 0.27) &amp; ( 0.59, 0.21) &amp; ( 0.29, 0.12) &amp; (-0.02,-0.09) \\
\hline
20 &amp; ( 0.15,-0.20) &amp; ( 0.64, 0.20) &amp; ( 0.65, 0.26) &amp; ( 0.66, 0.21) &amp; ( 0.67, 0.25) &amp; ( 0.70, 0.29) &amp; ( 0.77, 0.30) &amp; ( 0.79, 0.33) &amp; ( 0.76, 0.18) &amp; ( 0.43, 0.02) \\
\hline
21 &amp; ( 0.64, 0.00) &amp; ( 0.88, 0.00) &amp; ( 0.89, 0.00) &amp; ( 0.89, 0.00) &amp; ( 0.89, 0.00) &amp; ( 0.90, 0.00) &amp; ( 0.93, 0.00) &amp; ( 0.93, 0.00) &amp; ( 0.94, 0.00) &amp; ( 0.89, 0.00) \\
\hline
\text{Dealer&#39;s Card:}  &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 &amp; 6 &amp; 7 &amp; 8 &amp; 9 &amp; 10
\end{array}\]</span>
No usable ace:
<span class="math display">\[\begin{array}{c|c|c|c|c|c|c|c|c|c}
\text{Player&#39;s Total} &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp;  \\
\hline
12 &amp; (-0.77,-0.49) &amp; (-0.29,-0.12) &amp; (-0.25,-0.08) &amp; (-0.21,-0.10) &amp; (-0.17,-0.06) &amp; (-0.15,-0.00) &amp; (-0.48,-0.07) &amp; (-0.51,-0.17) &amp; (-0.54,-0.19) &amp; (-0.58,-0.31) \\
\hline
13 &amp; (-0.77,-0.44) &amp; (-0.29,-0.14) &amp; (-0.25,-0.17) &amp; (-0.21,-0.10) &amp; (-0.17,-0.05) &amp; (-0.15,-0.05) &amp; (-0.48,-0.08) &amp; (-0.51,-0.13) &amp; (-0.54,-0.29) &amp; (-0.58,-0.38) \\
\hline
14 &amp; (-0.77,-0.52) &amp; (-0.29,-0.19) &amp; (-0.25,-0.17) &amp; (-0.21,-0.14) &amp; (-0.17,-0.15) &amp; (-0.15,-0.12) &amp; (-0.48,-0.19) &amp; (-0.51,-0.17) &amp; (-0.54,-0.34) &amp; (-0.58,-0.38) \\
\hline
15 &amp; (-0.77,-0.52) &amp; (-0.29,-0.18) &amp; (-0.25,-0.19) &amp; (-0.21,-0.15) &amp; (-0.17,-0.17) &amp; (-0.15,-0.16) &amp; (-0.48,-0.22) &amp; (-0.51,-0.26) &amp; (-0.54,-0.37) &amp; (-0.58,-0.42) \\
\hline
16 &amp; (-0.77,-0.54) &amp; (-0.29,-0.25) &amp; (-0.25,-0.28) &amp; (-0.21,-0.24) &amp; (-0.17,-0.23) &amp; (-0.15,-0.18) &amp; (-0.48,-0.26) &amp; (-0.51,-0.28) &amp; (-0.54,-0.38) &amp; (-0.58,-0.49) \\
\hline
17 &amp; (-0.64,-0.56) &amp; (-0.15,-0.31) &amp; (-0.12,-0.31) &amp; (-0.08,-0.25) &amp; (-0.04,-0.22) &amp; ( 0.01,-0.21) &amp; (-0.11,-0.27) &amp; (-0.38,-0.31) &amp; (-0.42,-0.41) &amp; (-0.46,-0.50) \\
\hline
18 &amp; (-0.38,-0.65) &amp; ( 0.12,-0.30) &amp; ( 0.15,-0.27) &amp; ( 0.18,-0.28) &amp; ( 0.20,-0.26) &amp; ( 0.28,-0.27) &amp; ( 0.40,-0.41) &amp; ( 0.11,-0.39) &amp; (-0.18,-0.41) &amp; (-0.24,-0.50) \\
\hline
19 &amp; (-0.12,-0.65) &amp; ( 0.39,-0.44) &amp; ( 0.40,-0.39) &amp; ( 0.42,-0.40) &amp; ( 0.44,-0.38) &amp; ( 0.50,-0.37) &amp; ( 0.62,-0.48) &amp; ( 0.59,-0.56) &amp; ( 0.29,-0.53) &amp; (-0.02,-0.53) \\
\hline
20 &amp; ( 0.15,-0.88) &amp; ( 0.64,-0.65) &amp; ( 0.65,-0.63) &amp; ( 0.66,-0.61) &amp; ( 0.67,-0.58) &amp; ( 0.70,-0.58) &amp; ( 0.77,-0.74) &amp; ( 0.79,-0.76) &amp; ( 0.76,-0.77) &amp; ( 0.43,-0.79) \\
\hline
21 &amp; ( 0.64, 0.00) &amp; ( 0.88, 0.00) &amp; ( 0.89, 0.00) &amp; ( 0.89, 0.00) &amp; ( 0.89, 0.00) &amp; ( 0.90, 0.00) &amp; ( 0.93, 0.00) &amp; ( 0.93, 0.00) &amp; ( 0.94, 0.00) &amp; ( 0.89, 0.00) \\
\hline
\text{Dealer&#39;s Card:}  &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 &amp; 6 &amp; 7 &amp; 8 &amp; 9 &amp; 10
\end{array}\]</span>
<p><strong>State Action Visits (stand, hit):</strong></p>
With usable ace:
<span class="math display">\[\begin{array}{c|c|c|c|c|c|c|c|c|c}
\text{Player&#39;s Total} &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp;  \\
\hline
12 &amp; (257,241) &amp; (236,243) &amp; (244,252) &amp; (241,278) &amp; (258,278) &amp; (253,258) &amp; (215,237) &amp; (245,245) &amp; (259,222) &amp; (227,238) \\
\hline
13 &amp; (253,277) &amp; (256,265) &amp; (280,276) &amp; (251,286) &amp; (252,261) &amp; (257,242) &amp; (260,270) &amp; (245,284) &amp; (258,243) &amp; (258,259) \\
\hline
14 &amp; (260,279) &amp; (254,296) &amp; (269,278) &amp; (251,290) &amp; (245,294) &amp; (267,292) &amp; (260,304) &amp; (255,289) &amp; (266,292) &amp; (270,280) \\
\hline
15 &amp; (251,319) &amp; (248,341) &amp; (253,346) &amp; (223,285) &amp; (267,316) &amp; (252,295) &amp; (233,309) &amp; (234,296) &amp; (253,256) &amp; (259,322) \\
\hline
16 &amp; (251,357) &amp; (223,324) &amp; (267,357) &amp; (280,318) &amp; (234,352) &amp; (257,331) &amp; (249,341) &amp; (244,329) &amp; (264,283) &amp; (246,301) \\
\hline
17 &amp; (272,357) &amp; (253,343) &amp; (236,386) &amp; (249,377) &amp; (256,343) &amp; (245,369) &amp; (244,414) &amp; (281,371) &amp; (255,344) &amp; (277,376) \\
\hline
18 &amp; (282,393) &amp; (345,322) &amp; (387,273) &amp; (386,265) &amp; (399,255) &amp; (410,251) &amp; (397,264) &amp; (389,273) &amp; (252,379) &amp; (280,370) \\
\hline
19 &amp; (457,251) &amp; (391,216) &amp; (409,272) &amp; (405,282) &amp; (416,226) &amp; (410,251) &amp; (397,240) &amp; (410,255) &amp; (396,253) &amp; (371,239) \\
\hline
20 &amp; (403,246) &amp; (436,246) &amp; (413,252) &amp; (448,225) &amp; (427,261) &amp; (409,247) &amp; (419,242) &amp; (431,263) &amp; (431,220) &amp; (454,233) \\
\hline
21 &amp; (734,0) &amp; (725,0) &amp; (687,0) &amp; (695,0) &amp; (748,0) &amp; (667,0) &amp; (688,0) &amp; (678,0) &amp; (661,0) &amp; (677,0) \\
\hline
\text{Dealer&#39;s Card:}  &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 &amp; 6 &amp; 7 &amp; 8 &amp; 9 &amp; 10
\end{array}\]</span>
No usable ace:
<span class="math display">\[\begin{array}{c|c|c|c|c|c|c|c|c|c}
\text{Player&#39;s Total} &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp; &amp;  \\
\hline
12 &amp; (252,509) &amp; (268,464) &amp; (269,523) &amp; (354,424) &amp; (278,529) &amp; (243,506) &amp; (243,478) &amp; (255,494) &amp; (250,514) &amp; (229,476) \\
\hline
13 &amp; (255,540) &amp; (265,523) &amp; (351,445) &amp; (260,516) &amp; (274,473) &amp; (354,391) &amp; (240,516) &amp; (264,538) &amp; (239,568) &amp; (238,533) \\
\hline
14 &amp; (272,571) &amp; (266,564) &amp; (258,617) &amp; (301,528) &amp; (315,501) &amp; (248,517) &amp; (239,581) &amp; (232,514) &amp; (284,551) &amp; (243,581) \\
\hline
15 &amp; (262,617) &amp; (231,581) &amp; (267,596) &amp; (263,559) &amp; (375,457) &amp; (566,226) &amp; (253,640) &amp; (255,537) &amp; (255,583) &amp; (271,580) \\
\hline
16 &amp; (252,590) &amp; (289,552) &amp; (552,328) &amp; (443,433) &amp; (592,246) &amp; (560,258) &amp; (261,587) &amp; (268,597) &amp; (234,579) &amp; (284,543) \\
\hline
17 &amp; (261,648) &amp; (664,252) &amp; (617,260) &amp; (610,306) &amp; (540,261) &amp; (555,237) &amp; (654,257) &amp; (359,520) &amp; (284,590) &amp; (699,245) \\
\hline
18 &amp; (704,242) &amp; (603,248) &amp; (565,245) &amp; (570,230) &amp; (524,255) &amp; (513,243) &amp; (631,230) &amp; (599,229) &amp; (622,276) &amp; (649,253) \\
\hline
19 &amp; (650,254) &amp; (546,242) &amp; (616,251) &amp; (624,251) &amp; (529,264) &amp; (524,283) &amp; (611,218) &amp; (668,240) &amp; (667,225) &amp; (569,223) \\
\hline
20 &amp; (625,227) &amp; (584,249) &amp; (612,261) &amp; (550,245) &amp; (564,268) &amp; (539,227) &amp; (586,243) &amp; (656,229) &amp; (643,235) &amp; (591,235) \\
\hline
21 &amp; (825,0) &amp; (742,0) &amp; (758,0) &amp; (709,0) &amp; (703,0) &amp; (718,0) &amp; (819,0) &amp; (778,0) &amp; (767,0) &amp; (795,0) \\
\hline
\text{Dealer&#39;s Card:}  &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 &amp; 6 &amp; 7 &amp; 8 &amp; 9 &amp; 10
\end{array}\]</span>
<hr />
<div class="footer">
<p>Powered by <a href="https://haskell-lang.org/">haskell</a>, <a href="https://docs.haskellstack.org/en/stable/README/">stack</a> and <a href="http://pandoc.org/">pandoc</a>.</p>
</div>

<pre class="include"><code>other/header.md</code></pre>
<h1 id="haskell-rl-blackjack-problem-example-5.3">haskell-rl : Blackjack Problem (Example 5.3)</h1>
<p>This <a href="https://wiki.haskell.org/Literate_programming">literate Haskell</a> document provides a solution to Example 5.3 in <em>Reinforcement Learning</em> by Sutton &amp; Barto.</p>
<p>Original author: <a href="mailto:capn.freako@gmail.com">David Banas</a><br />
Original date: May 17, 2018</p>
<p>Copyright Â© 2018 David Banas; all rights reserved World wide.</p>
<h2 id="contents">Contents</h2>
<ul class="incremental">
<li><a href="#code">Code</a></li>
<li><a href="#output">Output</a></li>
</ul>
<h2 id="code">code</h2>
<h2 id="ghc-options"><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/flags.html#flag-reference">ghc options</a></h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="ot">{-# OPTIONS_GHC -Wall #-}</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="ot">{-# OPTIONS_GHC -fno-warn-type-defaults #-}</span></a></code></pre></div>
<h2 id="pragmas"><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/lang.html">pragmas</a></h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">-- doctest doesn&#39;t look at the cabal file, so you need pragmas here</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="ot">{-# LANGUAGE NoImplicitPrelude #-}</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="ot">{-# LANGUAGE DataKinds #-}</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="ot">{-# LANGUAGE DeriveGeneric #-}</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="ot">{-# LANGUAGE FlexibleContexts #-}</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="ot">{-# LANGUAGE RecordWildCards #-}</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="ot">{-# LANGUAGE ScopedTypeVariables #-}</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="ot">{-# LANGUAGE TypeOperators #-}</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="ot">{-# LANGUAGE TypeFamilies #-}</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="ot">{-# LANGUAGE FlexibleInstances #-}</span></a></code></pre></div>
<h2 id="libraries"><a href="https://www.stackage.org/">libraries</a></h2>
<ul class="incremental">
<li><a href="https://www.stackage.org/package/protolude">protolude</a></li>
<li><a href="https://www.stackage.org/package/optparse-generic">optparse-generic</a></li>
<li><a href="https://www.stackage.org/package/vector-sized">vector-sized</a></li>
<li><a href="https://www.stackage.org/package/finite-typelits">finite-typelits</a></li>
<li><a href="https://www.stackage.org/package/Chart">Chart</a></li>
<li><a href="https://www.stackage.org/package/Chart-cairo">Chart-cairo</a></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Prelude</span> <span class="kw">as</span> <span class="dt">P</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw">import</span> <span class="dt">Prelude</span> (unlines, <span class="dt">Show</span>(..), <span class="dt">String</span>, error, (!!))</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="kw">import</span> <span class="dt">Protolude</span>  <span class="kw">hiding</span> (show, for)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="kw">import</span> <span class="dt">Options.Generic</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Vector.Sized</span> <span class="kw">as</span> <span class="dt">VS</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="kw">import</span> <span class="dt">Control.Arrow</span>          ((&amp;&amp;&amp;), (***))</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="kw">import</span> <span class="dt">Control.Monad.Writer</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="kw">import</span> <span class="dt">Data.Vector.Sized</span>      (<span class="dt">Vector</span>, (//), index)</a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="kw">import</span> <span class="dt">Data.Finite</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="kw">import</span> <span class="dt">Data.Text</span>              (pack)</a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="kw">import</span> <span class="dt">System.Random.Shuffle</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="kw">import</span> <span class="dt">Text.Printf</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="kw">import</span> <span class="dt">Useful.IO</span>              (rand)</a></code></pre></div>
<h2 id="code-1">code</h2>
<ul class="incremental">
<li><a href="https://www.stackage.org/package/hoogle">hoogle</a></li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode literate haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1"></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">  Problem specific definitions</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="kw">data</span> <span class="dt">BJState</span> <span class="fu">=</span> <span class="dt">BJState</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  {<span class="ot"> playerSum  ::</span> <span class="dt">Int</span>   <span class="co">-- 12 - 21</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  ,<span class="ot"> usableAce  ::</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">  ,<span class="ot"> dealerCard ::</span> <span class="dt">Int</span>   <span class="co">-- 1 - 10</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10">  ,<span class="ot"> dealerSum  ::</span> <span class="dt">Int</span>   <span class="co">-- For debugging only; not used for learning.</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11">  ,<span class="ot"> polHit     ::</span> <span class="dt">Bool</span>  <span class="co">-- For debugging only; not used for learning.</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12">  ,<span class="ot"> didHit     ::</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13">  } <span class="kw">deriving</span> (<span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb5-14" data-line-number="14"></a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="ot">stateDef ::</span> <span class="dt">BJState</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16">stateDef <span class="fu">=</span> <span class="dt">BJState</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17">  { playerSum  <span class="fu">=</span> <span class="dv">12</span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18">  , usableAce  <span class="fu">=</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb5-19" data-line-number="19">  , dealerCard <span class="fu">=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb5-20" data-line-number="20">  , dealerSum  <span class="fu">=</span> <span class="dv">12</span></a>
<a class="sourceLine" id="cb5-21" data-line-number="21">  , polHit     <span class="fu">=</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb5-22" data-line-number="22">  , didHit     <span class="fu">=</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb5-23" data-line-number="23">  }</a>
<a class="sourceLine" id="cb5-24" data-line-number="24"></a>
<a class="sourceLine" id="cb5-25" data-line-number="25"><span class="kw">newtype</span> <span class="dt">BJAction</span> <span class="fu">=</span> <span class="dt">BJAction</span> {<span class="ot"> act ::</span> <span class="dt">Bool</span> }  <span class="co">-- Hit?</span></a>
<a class="sourceLine" id="cb5-26" data-line-number="26"></a>
<a class="sourceLine" id="cb5-27" data-line-number="27"><span class="kw">instance</span> <span class="dt">Show</span> <span class="dt">BJAction</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-28" data-line-number="28">  show (<span class="dt">BJAction</span> x) <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-29" data-line-number="29">    <span class="kw">if</span> x <span class="kw">then</span> <span class="st">&quot;H&quot;</span></a>
<a class="sourceLine" id="cb5-30" data-line-number="30">         <span class="kw">else</span> <span class="st">&quot; &quot;</span></a>
<a class="sourceLine" id="cb5-31" data-line-number="31"></a>
<a class="sourceLine" id="cb5-32" data-line-number="32"><span class="ot">allActs ::</span> [<span class="dt">BJAction</span>]</a>
<a class="sourceLine" id="cb5-33" data-line-number="33">allActs <span class="fu">=</span> map <span class="dt">BJAction</span> [<span class="dt">False</span>, <span class="dt">True</span>]</a>
<a class="sourceLine" id="cb5-34" data-line-number="34"></a>
<a class="sourceLine" id="cb5-35" data-line-number="35"><span class="kw">type</span> <span class="dt">BJPolicy</span> <span class="fu">=</span> <span class="dt">BJState</span> <span class="ot">-&gt;</span> <span class="dt">BJAction</span></a>
<a class="sourceLine" id="cb5-36" data-line-number="36"></a>
<a class="sourceLine" id="cb5-37" data-line-number="37"><span class="ot">appPolV ::</span> <span class="dt">Vector</span> <span class="dv">200</span> <span class="dt">BJAction</span> <span class="ot">-&gt;</span> <span class="dt">BJPolicy</span></a>
<a class="sourceLine" id="cb5-38" data-line-number="38">appPolV v <span class="fu">=</span> \s <span class="ot">-&gt;</span> v <span class="ot">`index`</span> enumState s</a>
<a class="sourceLine" id="cb5-39" data-line-number="39"></a>
<a class="sourceLine" id="cb5-40" data-line-number="40"><span class="ot">enumState ::</span> <span class="dt">BJState</span> <span class="ot">-&gt;</span> <span class="dt">Finite</span> <span class="dv">200</span></a>
<a class="sourceLine" id="cb5-41" data-line-number="41">enumState s<span class="fu">@</span><span class="dt">BJState</span>{<span class="fu">..</span>} <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-42" data-line-number="42">  <span class="kw">let</span> offset <span class="fu">=</span> (dealerCard <span class="fu">-</span> <span class="dv">1</span>) <span class="fu">*</span> <span class="dv">10</span> <span class="fu">+</span> playerSum <span class="fu">-</span> <span class="dv">12</span></a>
<a class="sourceLine" id="cb5-43" data-line-number="43">   <span class="kw">in</span> <span class="kw">if</span> offset <span class="fu">&lt;</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb5-44" data-line-number="44">        <span class="kw">then</span> error (show s)</a>
<a class="sourceLine" id="cb5-45" data-line-number="45">        <span class="kw">else</span> <span class="kw">if</span> usableAce</a>
<a class="sourceLine" id="cb5-46" data-line-number="46">               <span class="kw">then</span> finite <span class="fu">.</span> fromIntegral <span class="fu">$</span> <span class="dv">100</span> <span class="fu">+</span> offset</a>
<a class="sourceLine" id="cb5-47" data-line-number="47">               <span class="kw">else</span> finite <span class="fu">.</span> fromIntegral <span class="fu">$</span> offset</a>
<a class="sourceLine" id="cb5-48" data-line-number="48"></a>
<a class="sourceLine" id="cb5-49" data-line-number="49"><span class="ot">validStates ::</span> [<span class="dt">BJState</span>] <span class="ot">-&gt;</span> [<span class="dt">BJState</span>]</a>
<a class="sourceLine" id="cb5-50" data-line-number="50">validStates <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-51" data-line-number="51">  filter ( \ <span class="dt">BJState</span>{<span class="fu">..</span>} <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-52" data-line-number="52">                playerSum  <span class="fu">&gt;=</span> <span class="dv">12</span> <span class="fu">&amp;&amp;</span> playerSum  <span class="fu">&lt;=</span> <span class="dv">21</span></a>
<a class="sourceLine" id="cb5-53" data-line-number="53">             <span class="fu">&amp;&amp;</span> dealerCard <span class="fu">&gt;=</span> <span class="dv">1</span>  <span class="fu">&amp;&amp;</span> dealerCard <span class="fu">&lt;=</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb5-54" data-line-number="54">         )</a>
<a class="sourceLine" id="cb5-55" data-line-number="55"></a>
<a class="sourceLine" id="cb5-56" data-line-number="56"><span class="kw">data</span> <span class="dt">DbgT</span> <span class="fu">=</span> <span class="dt">DbgT</span></a>
<a class="sourceLine" id="cb5-57" data-line-number="57">  {<span class="ot"> upCard ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb5-58" data-line-number="58">  ,<span class="ot"> states ::</span> [<span class="dt">BJState</span>]</a>
<a class="sourceLine" id="cb5-59" data-line-number="59">  ,<span class="ot"> reward ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb5-60" data-line-number="60">  }</a>
<a class="sourceLine" id="cb5-61" data-line-number="61"></a>
<a class="sourceLine" id="cb5-62" data-line-number="62"><span class="ot">play ::</span> <span class="dt">BJPolicy</span> <span class="ot">-&gt;</span> [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">BJAction</span> <span class="ot">-&gt;</span> <span class="dt">Writer</span> [<span class="dt">DbgT</span>] (<span class="dt">Int</span>, [<span class="dt">BJState</span>])</a>
<a class="sourceLine" id="cb5-63" data-line-number="63">play pol cards randAct <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-64" data-line-number="64">  <span class="kw">do</span> <span class="kw">let</span> (r, ss) <span class="fu">|</span> pTot <span class="fu">==</span> <span class="dv">21</span> <span class="fu">=</span> <span class="kw">if</span> dTot <span class="fu">==</span> <span class="dv">21</span></a>
<a class="sourceLine" id="cb5-65" data-line-number="65">                                  <span class="kw">then</span> (<span class="dv">0</span>, [])</a>
<a class="sourceLine" id="cb5-66" data-line-number="66">                                  <span class="kw">else</span> (<span class="dv">1</span>, [])</a>
<a class="sourceLine" id="cb5-67" data-line-number="67">                 <span class="fu">|</span> dTot <span class="fu">==</span> <span class="dv">21</span> <span class="fu">=</span> (<span class="fu">-</span><span class="dv">1</span>, [])</a>
<a class="sourceLine" id="cb5-68" data-line-number="68">                 <span class="fu">|</span> otherwise <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-69" data-line-number="69">                   runWriter <span class="fu">$</span> play&#39; pol (drop <span class="dv">4</span> cards) dCards pCards <span class="dt">Init</span> randAct</a>
<a class="sourceLine" id="cb5-70" data-line-number="70">     tell [ <span class="dt">DbgT</span> { upCard <span class="fu">=</span> cards <span class="fu">!!</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb5-71" data-line-number="71">                 , states <span class="fu">=</span> ss</a>
<a class="sourceLine" id="cb5-72" data-line-number="72">                 , reward <span class="fu">=</span> r</a>
<a class="sourceLine" id="cb5-73" data-line-number="73">                 }</a>
<a class="sourceLine" id="cb5-74" data-line-number="74">          ]</a>
<a class="sourceLine" id="cb5-75" data-line-number="75">     return (r, ss)</a>
<a class="sourceLine" id="cb5-76" data-line-number="76">  <span class="kw">where</span> (pTot, _) <span class="fu">=</span> cardSum pCards</a>
<a class="sourceLine" id="cb5-77" data-line-number="77">        (dTot, _) <span class="fu">=</span> cardSum dCards</a>
<a class="sourceLine" id="cb5-78" data-line-number="78">        dCards    <span class="fu">=</span> take <span class="dv">2</span> <span class="fu">$</span> drop <span class="dv">2</span> cards</a>
<a class="sourceLine" id="cb5-79" data-line-number="79">        pCards    <span class="fu">=</span> take <span class="dv">2</span> cards</a>
<a class="sourceLine" id="cb5-80" data-line-number="80"></a>
<a class="sourceLine" id="cb5-81" data-line-number="81"><span class="kw">data</span> <span class="dt">PlayPhase</span> <span class="fu">=</span> <span class="dt">Init</span>    <span class="co">-- Bringing player&#39;s sum &gt; 11.</span></a>
<a class="sourceLine" id="cb5-82" data-line-number="82">               <span class="fu">|</span> <span class="dt">Player</span>  <span class="co">-- Player is hitting/standing.</span></a>
<a class="sourceLine" id="cb5-83" data-line-number="83">               <span class="fu">|</span> <span class="dt">Dealer</span>  <span class="co">-- Dealer is hitting/standing.</span></a>
<a class="sourceLine" id="cb5-84" data-line-number="84"></a>
<a class="sourceLine" id="cb5-85" data-line-number="85"><span class="ot">play&#39; ::</span> <span class="dt">BJPolicy</span>   <span class="co">-- current policy</span></a>
<a class="sourceLine" id="cb5-86" data-line-number="86">      <span class="ot">-&gt;</span> [<span class="dt">Int</span>]      <span class="co">-- remaining deck of cards</span></a>
<a class="sourceLine" id="cb5-87" data-line-number="87">      <span class="ot">-&gt;</span> [<span class="dt">Int</span>]      <span class="co">-- dealer&#39;s cards</span></a>
<a class="sourceLine" id="cb5-88" data-line-number="88">      <span class="ot">-&gt;</span> [<span class="dt">Int</span>]      <span class="co">-- player&#39;s cards</span></a>
<a class="sourceLine" id="cb5-89" data-line-number="89">      <span class="ot">-&gt;</span> <span class="dt">PlayPhase</span>  <span class="co">-- phase of the game</span></a>
<a class="sourceLine" id="cb5-90" data-line-number="90">      <span class="ot">-&gt;</span> <span class="dt">BJAction</span>   <span class="co">-- randomly chosen action to be performed by player at his first free turn</span></a>
<a class="sourceLine" id="cb5-91" data-line-number="91">      <span class="ot">-&gt;</span> <span class="dt">Writer</span> [<span class="dt">BJState</span>] <span class="dt">Int</span></a>
<a class="sourceLine" id="cb5-92" data-line-number="92">play&#39; pol cards dCards pCards phs randAct <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-93" data-line-number="93">  <span class="kw">case</span> phs <span class="kw">of</span></a>
<a class="sourceLine" id="cb5-94" data-line-number="94">    <span class="dt">Init</span> <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-95" data-line-number="95">      <span class="kw">if</span> pTot <span class="fu">&gt;</span> <span class="dv">11</span></a>
<a class="sourceLine" id="cb5-96" data-line-number="96">        <span class="kw">then</span> <span class="kw">do</span> tell [s{didHit <span class="fu">=</span> act randAct}]</a>
<a class="sourceLine" id="cb5-97" data-line-number="97">                <span class="kw">if</span> act randAct  <span class="co">-- Is first (randomly chosen) player action &quot;hit&quot;?</span></a>
<a class="sourceLine" id="cb5-98" data-line-number="98">                  <span class="kw">then</span> play&#39; pol (P.tail cards) dCards (P.head cards <span class="fu">:</span> pCards) <span class="dt">Player</span> randAct</a>
<a class="sourceLine" id="cb5-99" data-line-number="99">                  <span class="kw">else</span> play&#39; pol cards dCards pCards <span class="dt">Dealer</span> randAct</a>
<a class="sourceLine" id="cb5-100" data-line-number="100">        <span class="kw">else</span> play&#39; pol (P.tail cards) dCards (P.head cards <span class="fu">:</span> pCards) <span class="dt">Init</span> randAct</a>
<a class="sourceLine" id="cb5-101" data-line-number="101"></a>
<a class="sourceLine" id="cb5-102" data-line-number="102">    <span class="dt">Player</span> <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-103" data-line-number="103">      <span class="kw">do</span> tell [s]</a>
<a class="sourceLine" id="cb5-104" data-line-number="104">         <span class="kw">if</span> pTot <span class="fu">&gt;</span> <span class="dv">21</span>        <span class="co">-- Player go bust yet?</span></a>
<a class="sourceLine" id="cb5-105" data-line-number="105">           <span class="kw">then</span> return (<span class="fu">-</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-106" data-line-number="106">           <span class="kw">else</span> <span class="kw">if</span> polHit    <span class="co">-- Does policy dictate a hit?</span></a>
<a class="sourceLine" id="cb5-107" data-line-number="107">                  <span class="kw">then</span> play&#39; pol (P.tail cards) dCards (P.head cards <span class="fu">:</span> pCards) <span class="dt">Player</span> randAct</a>
<a class="sourceLine" id="cb5-108" data-line-number="108">                  <span class="kw">else</span> play&#39; pol cards dCards pCards <span class="dt">Dealer</span> randAct</a>
<a class="sourceLine" id="cb5-109" data-line-number="109"></a>
<a class="sourceLine" id="cb5-110" data-line-number="110">    <span class="dt">Dealer</span> <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb5-111" data-line-number="111">      <span class="kw">do</span> tell [s]</a>
<a class="sourceLine" id="cb5-112" data-line-number="112">         <span class="kw">if</span> dTot <span class="fu">&gt;</span> <span class="dv">21</span>        <span class="co">-- Dealer go bust yet?</span></a>
<a class="sourceLine" id="cb5-113" data-line-number="113">           <span class="kw">then</span> return <span class="dv">1</span></a>
<a class="sourceLine" id="cb5-114" data-line-number="114">           <span class="kw">else</span> <span class="kw">if</span> dTot <span class="fu">&lt;</span> <span class="dv">17</span>        <span class="co">-- Must dealer take a hit?</span></a>
<a class="sourceLine" id="cb5-115" data-line-number="115">                  <span class="kw">then</span> play&#39; pol (P.tail cards) (P.head cards <span class="fu">:</span> dCards) pCards <span class="dt">Dealer</span> randAct</a>
<a class="sourceLine" id="cb5-116" data-line-number="116">                  <span class="kw">else</span> <span class="kw">case</span> compare pTot dTot <span class="kw">of</span></a>
<a class="sourceLine" id="cb5-117" data-line-number="117">                         <span class="dt">GT</span> <span class="ot">-&gt;</span> return   <span class="dv">1</span></a>
<a class="sourceLine" id="cb5-118" data-line-number="118">                         <span class="dt">EQ</span> <span class="ot">-&gt;</span> return   <span class="dv">0</span></a>
<a class="sourceLine" id="cb5-119" data-line-number="119">                         _  <span class="ot">-&gt;</span> return (<span class="fu">-</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-120" data-line-number="120"></a>
<a class="sourceLine" id="cb5-121" data-line-number="121">  <span class="kw">where</span> (pTot, ace) <span class="fu">=</span> cardSum pCards</a>
<a class="sourceLine" id="cb5-122" data-line-number="122">        (dTot, _)   <span class="fu">=</span> cardSum dCards</a>
<a class="sourceLine" id="cb5-123" data-line-number="123">        s&#39;          <span class="fu">=</span> stateDef</a>
<a class="sourceLine" id="cb5-124" data-line-number="124">                        { playerSum  <span class="fu">=</span> pTot</a>
<a class="sourceLine" id="cb5-125" data-line-number="125">                        , usableAce  <span class="fu">=</span> ace</a>
<a class="sourceLine" id="cb5-126" data-line-number="126">                        , dealerCard <span class="fu">=</span> P.last dCards</a>
<a class="sourceLine" id="cb5-127" data-line-number="127">                        , dealerSum  <span class="fu">=</span> dTot</a>
<a class="sourceLine" id="cb5-128" data-line-number="128">                        }</a>
<a class="sourceLine" id="cb5-129" data-line-number="129">        s           <span class="fu">=</span> s&#39;</a>
<a class="sourceLine" id="cb5-130" data-line-number="130">                        { polHit <span class="fu">=</span> polHit</a>
<a class="sourceLine" id="cb5-131" data-line-number="131">                        , didHit <span class="fu">=</span> polHit</a>
<a class="sourceLine" id="cb5-132" data-line-number="132">                        }</a>
<a class="sourceLine" id="cb5-133" data-line-number="133">        polHit      <span class="fu">=</span> (act <span class="fu">.</span> pol) s&#39;</a>
<a class="sourceLine" id="cb5-134" data-line-number="134"></a>
<a class="sourceLine" id="cb5-135" data-line-number="135"><span class="ot">cardSum ::</span> [<span class="dt">Int</span>] <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Bool</span>)</a>
<a class="sourceLine" id="cb5-136" data-line-number="136">cardSum cards <span class="fu">=</span></a>
<a class="sourceLine" id="cb5-137" data-line-number="137">  <span class="kw">if</span> tot <span class="fu">&lt;</span> <span class="dv">12</span> <span class="fu">&amp;&amp;</span> <span class="dv">1</span> <span class="ot">`elem`</span> cards</a>
<a class="sourceLine" id="cb5-138" data-line-number="138">    <span class="kw">then</span> (tot <span class="fu">+</span> <span class="dv">10</span>, <span class="dt">True</span>)</a>
<a class="sourceLine" id="cb5-139" data-line-number="139">    <span class="kw">else</span> (tot,      <span class="dt">False</span>)</a>
<a class="sourceLine" id="cb5-140" data-line-number="140">  <span class="kw">where</span> tot <span class="fu">=</span> sum cards</a>
<a class="sourceLine" id="cb5-141" data-line-number="141"></a>
<a class="sourceLine" id="cb5-142" data-line-number="142"><span class="ot">showVofState ::</span> (<span class="dt">Show</span> a) <span class="ot">=&gt;</span> <span class="dt">Vector</span> <span class="dv">200</span> a <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb5-143" data-line-number="143">showVofState v <span class="fu">=</span> intercalate <span class="st">&quot;\n\n&quot;</span> <span class="fu">$</span> map (showVofState&#39; v) [<span class="dt">True</span>, <span class="dt">False</span>]</a>
<a class="sourceLine" id="cb5-144" data-line-number="144"></a>
<a class="sourceLine" id="cb5-145" data-line-number="145"><span class="ot">showVofState&#39; ::</span> <span class="dt">Show</span> a <span class="ot">=&gt;</span> <span class="dt">Vector</span> <span class="dv">200</span> a <span class="ot">-&gt;</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb5-146" data-line-number="146">showVofState&#39; v ace <span class="fu">=</span> unlines <span class="fu">$</span></a>
<a class="sourceLine" id="cb5-147" data-line-number="147">  (<span class="kw">if</span> ace</a>
<a class="sourceLine" id="cb5-148" data-line-number="148">     <span class="kw">then</span> <span class="st">&quot;With usable ace:&quot;</span></a>
<a class="sourceLine" id="cb5-149" data-line-number="149">     <span class="kw">else</span> <span class="st">&quot;No usable ace:&quot;</span>)</a>
<a class="sourceLine" id="cb5-150" data-line-number="150">  <span class="fu">:</span> ( <span class="st">&quot;\\begin{array}{c|c|c|c|c|c|c|c|c|c}&quot;</span> <span class="fu">:</span></a>
<a class="sourceLine" id="cb5-151" data-line-number="151">      ( (<span class="st">&quot;\\text{Player&#39;s Total} &amp;&quot;</span> <span class="fu">++</span> intersperse <span class="ch">&#39;&amp;&#39;</span> (replicate <span class="dv">10</span> <span class="ch">&#39; &#39;</span>) <span class="fu">++</span> <span class="st">&quot; \\\\&quot;</span>) <span class="fu">:</span></a>
<a class="sourceLine" id="cb5-152" data-line-number="152">        [<span class="st">&quot;\\hline&quot;</span>] <span class="fu">++</span></a>
<a class="sourceLine" id="cb5-153" data-line-number="153">        intersperse <span class="st">&quot;\\hline&quot;</span></a>
<a class="sourceLine" id="cb5-154" data-line-number="154">          ( map ((<span class="fu">++</span> <span class="st">&quot; \\\\&quot;</span>) <span class="fu">.</span> intercalate <span class="st">&quot; &amp; &quot;</span>)</a>
<a class="sourceLine" id="cb5-155" data-line-number="155">                [ (show pTot <span class="fu">:</span>) <span class="fu">$</span> map show</a>
<a class="sourceLine" id="cb5-156" data-line-number="156">                  [ v <span class="ot">`index`</span> enumState s</a>
<a class="sourceLine" id="cb5-157" data-line-number="157">                  <span class="fu">|</span> dCard <span class="ot">&lt;-</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">10</span>]</a>
<a class="sourceLine" id="cb5-158" data-line-number="158">                  , <span class="kw">let</span> s <span class="fu">=</span> stateDef { playerSum  <span class="fu">=</span> pTot</a>
<a class="sourceLine" id="cb5-159" data-line-number="159">                                     , usableAce  <span class="fu">=</span> ace</a>
<a class="sourceLine" id="cb5-160" data-line-number="160">                                     , dealerCard <span class="fu">=</span> dCard</a>
<a class="sourceLine" id="cb5-161" data-line-number="161">                                     }</a>
<a class="sourceLine" id="cb5-162" data-line-number="162">                  ]</a>
<a class="sourceLine" id="cb5-163" data-line-number="163">                <span class="fu">|</span> pTot <span class="ot">&lt;-</span> [<span class="dv">12</span><span class="fu">..</span><span class="dv">21</span>]</a>
<a class="sourceLine" id="cb5-164" data-line-number="164">                ]</a>
<a class="sourceLine" id="cb5-165" data-line-number="165">          )</a>
<a class="sourceLine" id="cb5-166" data-line-number="166">        <span class="fu">++</span> [<span class="st">&quot;\\hline&quot;</span>]</a>
<a class="sourceLine" id="cb5-167" data-line-number="167">        <span class="fu">++</span> [intercalate <span class="st">&quot; &amp; &quot;</span> <span class="fu">$</span> <span class="st">&quot;\\text{Dealer&#39;s Card:} &quot;</span> <span class="fu">:</span> [show n <span class="fu">|</span> n <span class="ot">&lt;-</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">10</span>]]]</a>
<a class="sourceLine" id="cb5-168" data-line-number="168">        <span class="fu">++</span> [<span class="st">&quot;\\end{array}&quot;</span>]</a>
<a class="sourceLine" id="cb5-169" data-line-number="169">      )</a>
<a class="sourceLine" id="cb5-170" data-line-number="170">    )</a>
<a class="sourceLine" id="cb5-171" data-line-number="171"></a>
<a class="sourceLine" id="cb5-172" data-line-number="172"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb5-173" data-line-number="173"><span class="co">  Command line options defintions.</span></a>
<a class="sourceLine" id="cb5-174" data-line-number="174"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb5-175" data-line-number="175"></a>
<a class="sourceLine" id="cb5-176" data-line-number="176"><span class="kw">data</span> <span class="dt">Opts</span> w <span class="fu">=</span> <span class="dt">Opts</span></a>
<a class="sourceLine" id="cb5-177" data-line-number="177">    {<span class="ot"> nGames ::</span> w <span class="ot">::</span><span class="fu">:</span> <span class="dt">Maybe</span> <span class="dt">Int</span> <span class="fu">&lt;?&gt;</span></a>
<a class="sourceLine" id="cb5-178" data-line-number="178">        <span class="st">&quot;The number of games to play.&quot;</span></a>
<a class="sourceLine" id="cb5-179" data-line-number="179">    }</a>
<a class="sourceLine" id="cb5-180" data-line-number="180">    <span class="kw">deriving</span> (<span class="dt">Generic</span>)</a>
<a class="sourceLine" id="cb5-181" data-line-number="181"></a>
<a class="sourceLine" id="cb5-182" data-line-number="182"><span class="kw">instance</span> <span class="dt">ParseRecord</span> (<span class="dt">Opts</span> <span class="dt">Wrapped</span>)</a>
<a class="sourceLine" id="cb5-183" data-line-number="183"></a>
<a class="sourceLine" id="cb5-184" data-line-number="184"></a>
<a class="sourceLine" id="cb5-185" data-line-number="185"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb5-186" data-line-number="186"><span class="co">  main()</span></a>
<a class="sourceLine" id="cb5-187" data-line-number="187"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb5-188" data-line-number="188"></a>
<a class="sourceLine" id="cb5-189" data-line-number="189"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb5-190" data-line-number="190">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb5-191" data-line-number="191">  <span class="co">-- Process command line options.</span></a>
<a class="sourceLine" id="cb5-192" data-line-number="192"><span class="ot">  o ::</span> <span class="dt">Opts</span> <span class="dt">Unwrapped</span> <span class="ot">&lt;-</span></a>
<a class="sourceLine" id="cb5-193" data-line-number="193">    unwrapRecord <span class="st">&quot;A solution to the &#39;Blackjack&#39; problem (Example 5.3).&quot;</span></a>
<a class="sourceLine" id="cb5-194" data-line-number="194">  <span class="kw">let</span> nG <span class="fu">=</span> fromMaybe <span class="dv">10000</span> (nGames o)</a>
<a class="sourceLine" id="cb5-195" data-line-number="195"></a>
<a class="sourceLine" id="cb5-196" data-line-number="196">  <span class="co">-- Initialize policy and state/action values.</span></a>
<a class="sourceLine" id="cb5-197" data-line-number="197">  <span class="kw">let</span> qs  <span class="fu">=</span> VS.replicate ((<span class="dv">0</span>,<span class="dv">0</span>), (<span class="dv">0</span>,<span class="dv">0</span>))  <span class="co">-- Initialize all state/action values to zero.</span></a>
<a class="sourceLine" id="cb5-198" data-line-number="198">      pol <span class="fu">=</span> VS.replicate (<span class="dt">BJAction</span> <span class="dt">True</span>)</a>
<a class="sourceLine" id="cb5-199" data-line-number="199">        <span class="fu">//</span> [ (enumState s, <span class="dt">BJAction</span> <span class="dt">False</span>)</a>
<a class="sourceLine" id="cb5-200" data-line-number="200">           <span class="fu">|</span> s <span class="ot">&lt;-</span> [ stateDef { playerSum <span class="fu">=</span> pTot</a>
<a class="sourceLine" id="cb5-201" data-line-number="201">                             , usableAce <span class="fu">=</span> ace</a>
<a class="sourceLine" id="cb5-202" data-line-number="202">                             , dealerCard <span class="fu">=</span> dCard</a>
<a class="sourceLine" id="cb5-203" data-line-number="203">                             }</a>
<a class="sourceLine" id="cb5-204" data-line-number="204">                  <span class="fu">|</span> pTot  <span class="ot">&lt;-</span> [<span class="dv">20</span>, <span class="dv">21</span>]</a>
<a class="sourceLine" id="cb5-205" data-line-number="205">                  , ace   <span class="ot">&lt;-</span> [<span class="dt">False</span>, <span class="dt">True</span>]</a>
<a class="sourceLine" id="cb5-206" data-line-number="206">                  , dCard <span class="ot">&lt;-</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">10</span>]</a>
<a class="sourceLine" id="cb5-207" data-line-number="207">                  ]</a>
<a class="sourceLine" id="cb5-208" data-line-number="208">           ]</a>
<a class="sourceLine" id="cb5-209" data-line-number="209"></a>
<a class="sourceLine" id="cb5-210" data-line-number="210">  <span class="co">-- Play many games, updating policy and state/action values after each.</span></a>
<a class="sourceLine" id="cb5-211" data-line-number="211">  (results, _) <span class="ot">&lt;-</span> runWriterT <span class="fu">$</span> iterateM&#39; nG optPol (qs, pol)</a>
<a class="sourceLine" id="cb5-212" data-line-number="212">  writeFile  <span class="st">&quot;other/blackjack.md&quot;</span> <span class="st">&quot;\n### Final State Action Values (stand, hit)\n\n&quot;</span></a>
<a class="sourceLine" id="cb5-213" data-line-number="213">  appendFile <span class="st">&quot;other/blackjack.md&quot;</span> <span class="fu">$</span> pack</a>
<a class="sourceLine" id="cb5-214" data-line-number="214">                                  <span class="fu">$</span> showVofState</a>
<a class="sourceLine" id="cb5-215" data-line-number="215">                                  <span class="fu">$</span> VS.map ( toBoth</a>
<a class="sourceLine" id="cb5-216" data-line-number="216">                                             <span class="fu">$</span> <span class="dt">PrettyFloat</span></a>
<a class="sourceLine" id="cb5-217" data-line-number="217">                                             <span class="fu">.</span> uncurry safeDiv</a>
<a class="sourceLine" id="cb5-218" data-line-number="218">                                             <span class="fu">.</span> (fromIntegral <span class="fu">***</span> fromIntegral)</a>
<a class="sourceLine" id="cb5-219" data-line-number="219">                                           )</a>
<a class="sourceLine" id="cb5-220" data-line-number="220">                                  <span class="fu">$</span> fst results</a>
<a class="sourceLine" id="cb5-221" data-line-number="221">  appendFile <span class="st">&quot;other/blackjack.md&quot;</span> <span class="st">&quot;\n### Final Policy (H = hit)\n\n&quot;</span></a>
<a class="sourceLine" id="cb5-222" data-line-number="222">  appendFile <span class="st">&quot;other/blackjack.md&quot;</span> <span class="fu">$</span> pack</a>
<a class="sourceLine" id="cb5-223" data-line-number="223">                                  <span class="fu">$</span> showVofState</a>
<a class="sourceLine" id="cb5-224" data-line-number="224">                                  <span class="fu">$</span> snd results</a>
<a class="sourceLine" id="cb5-225" data-line-number="225">  appendFile <span class="st">&quot;other/blackjack.md&quot;</span> <span class="st">&quot;\n### Debugging Info\n\n&quot;</span></a>
<a class="sourceLine" id="cb5-226" data-line-number="226">  appendFile <span class="st">&quot;other/blackjack.md&quot;</span> <span class="st">&quot;\n### State Action Visits (stand, hit)\n\n&quot;</span></a>
<a class="sourceLine" id="cb5-227" data-line-number="227">  appendFile <span class="st">&quot;other/blackjack.md&quot;</span> <span class="fu">$</span> pack</a>
<a class="sourceLine" id="cb5-228" data-line-number="228">                                  <span class="fu">$</span> showVofState</a>
<a class="sourceLine" id="cb5-229" data-line-number="229">                                  <span class="fu">$</span> VS.map ( toBoth snd )</a>
<a class="sourceLine" id="cb5-230" data-line-number="230">                                  <span class="fu">$</span> fst results</a>
<a class="sourceLine" id="cb5-231" data-line-number="231"></a>
<a class="sourceLine" id="cb5-232" data-line-number="232"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb5-233" data-line-number="233"><span class="co">  Monte Carlo optimizer</span></a>
<a class="sourceLine" id="cb5-234" data-line-number="234"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb5-235" data-line-number="235"></a>
<a class="sourceLine" id="cb5-236" data-line-number="236"><span class="co">-- | Play one game of Blackjack and return improved state-action value</span></a>
<a class="sourceLine" id="cb5-237" data-line-number="237"><span class="co">-- and policy estimates.</span></a>
<a class="sourceLine" id="cb5-238" data-line-number="238"><span class="co">--</span></a>
<a class="sourceLine" id="cb5-239" data-line-number="239"><span class="co">-- Note that the Q vector contains not only the running expectation for</span></a>
<a class="sourceLine" id="cb5-240" data-line-number="240"><span class="co">-- hitting/standing at each state, but also the number of times that</span></a>
<a class="sourceLine" id="cb5-241" data-line-number="241"><span class="co">-- particular state-action pair has been visited. This is needed for</span></a>
<a class="sourceLine" id="cb5-242" data-line-number="242"><span class="co">-- proper normalization across multiple episodes.</span></a>
<a class="sourceLine" id="cb5-243" data-line-number="243"><span class="ot">optPol ::</span> ( <span class="dt">Vector</span> <span class="dv">200</span> ((<span class="dt">Int</span>, <span class="dt">Integer</span>), (<span class="dt">Int</span>, <span class="dt">Integer</span>))</a>
<a class="sourceLine" id="cb5-244" data-line-number="244">          , <span class="dt">Vector</span> <span class="dv">200</span> <span class="dt">BJAction</span></a>
<a class="sourceLine" id="cb5-245" data-line-number="245">          )</a>
<a class="sourceLine" id="cb5-246" data-line-number="246">       <span class="ot">-&gt;</span> <span class="dt">WriterT</span> [[<span class="dt">DbgT</span>]]</a>
<a class="sourceLine" id="cb5-247" data-line-number="247">            <span class="dt">IO</span> ( <span class="dt">Vector</span> <span class="dv">200</span> ((<span class="dt">Int</span>, <span class="dt">Integer</span>), (<span class="dt">Int</span>, <span class="dt">Integer</span>))</a>
<a class="sourceLine" id="cb5-248" data-line-number="248">               , <span class="dt">Vector</span> <span class="dv">200</span> <span class="dt">BJAction</span></a>
<a class="sourceLine" id="cb5-249" data-line-number="249">               )</a>
<a class="sourceLine" id="cb5-250" data-line-number="250">optPol (qs, pol) <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb5-251" data-line-number="251">  randAct <span class="ot">&lt;-</span> lift <span class="fu">$</span> rand allActs</a>
<a class="sourceLine" id="cb5-252" data-line-number="252">  cards <span class="ot">&lt;-</span> shuffleM <span class="fu">$</span> concat [replicate  <span class="dv">4</span>  n <span class="fu">|</span> n <span class="ot">&lt;-</span> [<span class="dv">1</span><span class="fu">..</span><span class="dv">9</span>]]</a>
<a class="sourceLine" id="cb5-253" data-line-number="253">                           <span class="fu">++</span> replicate <span class="dv">16</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb5-254" data-line-number="254">  <span class="kw">let</span> ((r, ss), dbgs) <span class="fu">=</span> runWriter <span class="fu">$</span> play (appPolV pol) cards randAct</a>
<a class="sourceLine" id="cb5-255" data-line-number="255">      ixs             <span class="fu">=</span> (nubOn fst <span class="fu">.</span> map (enumState <span class="fu">&amp;&amp;&amp;</span> didHit) <span class="fu">.</span> validStates) ss</a>
<a class="sourceLine" id="cb5-256" data-line-number="256">      (qs&#39;, pol&#39;)     <span class="fu">=</span> VS.unzip <span class="fu">$</span> VS.zip qs pol <span class="fu">//</span></a>
<a class="sourceLine" id="cb5-257" data-line-number="257">                          [ (i, (q&#39;, p&#39;))</a>
<a class="sourceLine" id="cb5-258" data-line-number="258">                          <span class="fu">|</span> (i, hit) <span class="ot">&lt;-</span> ixs</a>
<a class="sourceLine" id="cb5-259" data-line-number="259">                          , <span class="kw">let</span> q  <span class="fu">=</span> qs  <span class="ot">`index`</span> i</a>
<a class="sourceLine" id="cb5-260" data-line-number="260">                                q&#39; <span class="fu">=</span> ( <span class="kw">if</span> hit</a>
<a class="sourceLine" id="cb5-261" data-line-number="261">                                         <span class="kw">then</span> second</a>
<a class="sourceLine" id="cb5-262" data-line-number="262">                                         <span class="kw">else</span> first</a>
<a class="sourceLine" id="cb5-263" data-line-number="263">                                     ) ((<span class="fu">+</span> r) <span class="fu">***</span> (<span class="fu">+</span> <span class="dv">1</span>)) q</a>
<a class="sourceLine" id="cb5-264" data-line-number="264">                                p&#39; <span class="fu">=</span> <span class="kw">case</span> uncurry compare</a>
<a class="sourceLine" id="cb5-265" data-line-number="265">                                          <span class="fu">$</span> toBoth ( uncurry (<span class="fu">/</span>)</a>
<a class="sourceLine" id="cb5-266" data-line-number="266">                                                   <span class="fu">.</span> (fromIntegral <span class="fu">***</span> fromIntegral)</a>
<a class="sourceLine" id="cb5-267" data-line-number="267">                                                   ) q&#39;</a>
<a class="sourceLine" id="cb5-268" data-line-number="268">                                     <span class="kw">of</span></a>
<a class="sourceLine" id="cb5-269" data-line-number="269">                                       <span class="dt">GT</span> <span class="ot">-&gt;</span> <span class="dt">BJAction</span> <span class="dt">False</span></a>
<a class="sourceLine" id="cb5-270" data-line-number="270">                                       _  <span class="ot">-&gt;</span> <span class="dt">BJAction</span> <span class="dt">True</span></a>
<a class="sourceLine" id="cb5-271" data-line-number="271">                          ]</a>
<a class="sourceLine" id="cb5-272" data-line-number="272">  tell [dbgs]</a>
<a class="sourceLine" id="cb5-273" data-line-number="273">  return (qs&#39;, pol&#39;)</a>
<a class="sourceLine" id="cb5-274" data-line-number="274"></a>
<a class="sourceLine" id="cb5-275" data-line-number="275"><span class="co">{----------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb5-276" data-line-number="276"><span class="co">  Misc.</span></a>
<a class="sourceLine" id="cb5-277" data-line-number="277"><span class="co">----------------------------------------------------------------------}</span></a>
<a class="sourceLine" id="cb5-278" data-line-number="278"></a>
<a class="sourceLine" id="cb5-279" data-line-number="279"><span class="ot">iterateM&#39; ::</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> (a <span class="ot">-&gt;</span> m a) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> m a</a>
<a class="sourceLine" id="cb5-280" data-line-number="280">iterateM&#39; <span class="dv">0</span> _ a <span class="fu">=</span> return a</a>
<a class="sourceLine" id="cb5-281" data-line-number="281">iterateM&#39; n f a <span class="fu">=</span> f a <span class="fu">&gt;&gt;=</span> iterateM&#39; (n<span class="fu">-</span><span class="dv">1</span>) f</a>
<a class="sourceLine" id="cb5-282" data-line-number="282"></a>
<a class="sourceLine" id="cb5-283" data-line-number="283"><span class="ot">toBoth ::</span> (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> (a,a) <span class="ot">-&gt;</span> (b,b)</a>
<a class="sourceLine" id="cb5-284" data-line-number="284">toBoth f (x,y) <span class="fu">=</span> (f x, f y)</a>
<a class="sourceLine" id="cb5-285" data-line-number="285"></a>
<a class="sourceLine" id="cb5-286" data-line-number="286"><span class="ot">safeDiv ::</span> (<span class="dt">Fractional</span> a, <span class="dt">Eq</span> a)</a>
<a class="sourceLine" id="cb5-287" data-line-number="287">        <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb5-288" data-line-number="288">safeDiv x y <span class="fu">=</span> <span class="kw">if</span> y <span class="fu">==</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb5-289" data-line-number="289">                <span class="kw">then</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb5-290" data-line-number="290">                <span class="kw">else</span> x <span class="fu">/</span> y</a>
<a class="sourceLine" id="cb5-291" data-line-number="291"></a>
<a class="sourceLine" id="cb5-292" data-line-number="292"><span class="kw">newtype</span> <span class="dt">PrettyFloat</span> <span class="fu">=</span> <span class="dt">PrettyFloat</span> <span class="dt">Float</span></a>
<a class="sourceLine" id="cb5-293" data-line-number="293"></a>
<a class="sourceLine" id="cb5-294" data-line-number="294"><span class="kw">instance</span> <span class="dt">Show</span> <span class="dt">PrettyFloat</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-295" data-line-number="295">  show (<span class="dt">PrettyFloat</span> x) <span class="fu">=</span> printf <span class="st">&quot;%+5.2f&quot;</span> x</a>
<a class="sourceLine" id="cb5-296" data-line-number="296"></a>
<a class="sourceLine" id="cb5-297" data-line-number="297"><span class="ot">nubOn ::</span> <span class="dt">Eq</span> b <span class="ot">=&gt;</span> (a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [a]</a>
<a class="sourceLine" id="cb5-298" data-line-number="298">nubOn _ []     <span class="fu">=</span> []</a>
<a class="sourceLine" id="cb5-299" data-line-number="299">nubOn f (x<span class="fu">:</span>xs) <span class="fu">=</span> x <span class="fu">:</span> filter ((<span class="fu">/=</span> f x) <span class="fu">.</span> f) xs</a></code></pre></div>
<h2 id="output">output</h2>
<pre class="include"><code>other/blackjack.md</code></pre>
<hr />
<div class="footer">
<p>Powered by <a href="https://haskell-lang.org/">haskell</a>, <a href="https://docs.haskellstack.org/en/stable/README/">stack</a> and <a href="http://pandoc.org/">pandoc</a>.</p>
</div>
